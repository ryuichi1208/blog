<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2020-08-18T00:45:29.873Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Bastion のサブネットに 適用する NSG の設定例</title>
    <link href="https://jpaztech.github.io/blog/network/bastion-nsg/"/>
    <id>https://jpaztech.github.io/blog/network/bastion-nsg/</id>
    <published>2020-08-11T05:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.873Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの薄井です。<br>今回は Bastion のサブネットに関連付けることのできる NSG についてご紹介します。</p><p>よく Bastion のサブネットへのアクセスに制限をかけたいといったお問い合わせをいただきます。Bastion のサブネットに適用する場合の NSG の設定については<a href="https://docs.microsoft.com/ja-jp/azure/bastion/bastion-nsg" target="_blank" rel="noopener">公式ドキュメント</a>にも記載がございますが、ここでは具体的な設定例を画像とともにご紹介いたします。</p><a id="more"></a><h2 id="受信セキュリティ規則"><a href="#受信セキュリティ規則" class="headerlink" title="受信セキュリティ規則"></a>受信セキュリティ規則</h2><p>以下に掲載しております画像の例では、優先度 120 番にて Bastion にアクセスするクライアントのグローバル IP アドレスのみを許可している例となります。優先度 4096 番に全てを拒否するルールを入れて既定のルールを拒否しています。<br>受信セキュリティ規則では以下のルールが必須となります。</p><ul><li>GatewayManager から任意の宛先への TCP の許可</li><li>AzureLoadBalancer から任意の宛先への TCP の許可</li><li>Bastion に接続するクライアントの IP アドレスから任意の宛先への HTTPS（TCP ポート 443）の許可。</li></ul><p><img src="/blog/network/bastion-nsg/bastion_nsg_in.png" alt="image-title"></p><h2 id="送信セキュリティ規則"><a href="#送信セキュリティ規則" class="headerlink" title="送信セキュリティ規則"></a>送信セキュリティ規則</h2><p>以下に掲載しております画像の例では、必須となるルールのみを許可している例となります。優先度 4096 番に全てを拒否するルールを入れて既定のルールを拒否しています。<br>送信セキュリティ規則では以下のルールが必須となります。</p><ul><li>任意の送信元から VirtualNetwork への SSH と RDP (TCP ポート 22 と TCP ポート 3389) の許可。どちらか一方のプロトコルしか使わないような場合でも両方必要となります。</li><li>AzureLoadBalancer から任意の宛先への TCP の許可</li><li>任意の送信元から Internet への HTTP (TCP ポート 80) の許可。Bastion のセッション情報の管理に使用されます。</li></ul><p><img src="/blog/network/bastion-nsg/bastion_nsg_out.png" alt="image-title"></p><h2 id="VM-および-VM-のサブネットの-NSG-の受信セキュリティ規則"><a href="#VM-および-VM-のサブネットの-NSG-の受信セキュリティ規則" class="headerlink" title="VM および VM のサブネットの NSG の受信セキュリティ規則"></a>VM および VM のサブネットの NSG の受信セキュリティ規則</h2><p>Bastion の接続先となる VM および VM のサブネットに NSG を設定する場合は、VM 側の NSG の受信セキュリティ規則において、Bastion のサブネットから VM のサブネットへの SSH もしくは RDP (TCP ポート 22 もしくは TCP ポート 3389) の許可をするルールが必要となります。</p><p>以下に掲載しております画像の例では、優先度 100 番の規則において Bastion のサブネットから Windows の VM に接続するために RDP（TCP ポート 3389)  宛の接続を許可した例となります。</p><p>Bastion から Linux の VM に接続をする場合には SSH（TCP ポート 22）宛の接続の許可が必要となります。</p><p><img src="/blog/network/bastion-nsg/vm_nsg_in.png" alt="image-title"></p><p>送信セキュリティ規則は特に必要な設定はございません。</p><h2 id="その他の-Bastion-に関連する情報"><a href="#その他の-Bastion-に関連する情報" class="headerlink" title="その他の Bastion に関連する情報"></a>その他の Bastion に関連する情報</h2><p>Bastion のサブネットに関連づける NSG について関連する情報が以下のページにあります。<br>併せてご参考いただければと思います。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/bastion/bastion-nsg" target="_blank" rel="noopener">NSG アクセスと Azure Bastion を使用する</a></li></ul><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チームの薄井です。&lt;br&gt;今回は Bastion のサブネットに関連付けることのできる NSG についてご紹介します。&lt;/p&gt;
&lt;p&gt;よく Bastion のサブネットへのアクセスに制限をかけたいといったお問い合わせをいただきます。Bastion のサブネットに適用する場合の NSG の設定については&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/bastion/bastion-nsg&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;公式ドキュメント&lt;/a&gt;にも記載がございますが、ここでは具体的な設定例を画像とともにご紹介いたします。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="Bastion" scheme="https://jpaztech.github.io/blog/tags/Bastion/"/>
    
      <category term="NSG" scheme="https://jpaztech.github.io/blog/tags/NSG/"/>
    
  </entry>
  
  <entry>
    <title>証明書の失効に関するアドバイザリ PVKM-5T8 の補足情報</title>
    <link href="https://jpaztech.github.io/blog/network/20200716-net/"/>
    <id>https://jpaztech.github.io/blog/network/20200716-net/</id>
    <published>2020-07-16T00:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.873Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの飯塚です。</p><p>先日、一部の証明書の失効に伴う影響についてのアドバイザリを、以下の URL にて公開するとともに、影響を受ける可能性があるサービスをご利用いただいているお客様に、追跡 ID: PVKM-5T8 でセキュリティ アドバイザリの通知を行いました。</p><a id="more"></a><p><a href="https://azure.microsoft.com/en-us/updates/certificateauthorityrevocation/" target="_blank" rel="noopener">Revocation of non-compliant Certificate Authorities potentially impacting customer’s Azure service(s).</a></p><p>内容や対応については上記の URL で公開されているとおりですが、英語での案内ということもあり、わかりづらい可能性がございましたので、日本語での補足記事をご用意させていただきました。以下のとおりご案内いたします。</p><h2 id="通知の背景"><a href="#通知の背景" class="headerlink" title="通知の背景"></a>通知の背景</h2><p>最近、CA ブラウザー フォーラム (*1) のメンバーによって、DigiCert 社の一部の中間認証局において、その管理、運用上、本来満たすべき要件の一部が満たされていないという内容が報告されました。これを受けて、該当の中間認証局より発行された証明書を失効させる措置が行われました。失効措置の対象となる証明書を利用している場合、証明書を再度取得して、失効対象の証明書と置き換える措置を行う必要があります。</p><p>対象となる認証局の情報などを含むレポートの詳細は、こちらにまとまっています。</p><ul><li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1649951" target="_blank" rel="noopener">DigiCert: Incorrect OCSP Delegated Responder Certificate</a></li><li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1650910" target="_blank" rel="noopener">DigiCert: Inconsistent EV audits</a></li></ul><p>この問題自体は認証局の問題であり、Microsoft Azure と直接関係のあるものではありません。しかし、Azure では一部のサービスにおいて、お客様が取得した証明書を持ち込んで利用するケースがあります。そのようなケースにおいて予期せずサービス影響が生じないよう、注意喚起のために、念のため弊社からも通知をさせていただきました。</p><p>(*1) CA ブラウザー フォーラムについては、<a href="(https://www.nic.ad.jp/ja/basics/terms/ca_browser_forum.html)">JPNIC のウェブサイト</a>にてわかりやすく説明されています。</p><h2 id="影響を受ける可能性のあるサービス"><a href="#影響を受ける可能性のあるサービス" class="headerlink" title="影響を受ける可能性のあるサービス"></a>影響を受ける可能性のあるサービス</h2><p>お客様が証明書を持ち込んで適用する可能性のあるサービスとして、Azure では以下を把握しております。これらのサービスに対して、お客様が取得した証明書を持ち込んで適用している場合は、影響を受ける可能性があります。</p><p>API Management; Application Gateway; App Service; Azure Active Directory Domain Services; Azure Front Door Service; CDN</p><h2 id="利用している証明書が失効対象かどうかの確認"><a href="#利用している証明書が失効対象かどうかの確認" class="headerlink" title="利用している証明書が失効対象かどうかの確認"></a>利用している証明書が失効対象かどうかの確認</h2><p>影響を受ける中間認証局の情報は、以下の DigiCert 社の資料にまとまっております。</p><ul><li><a href="https://knowledge.digicert.com/alerts/DigiCert-ICA-Replacement" target="_blank" rel="noopener">DigiCert ICA Replacement</a></li></ul><p>資料には、以下の中間認証局が対象という情報がまとまっています。これらの認証局から発行された証明書を利用している場合、それらは失効措置の対象となります。</p><ul><li>DigiCert Global CA G2</li><li>GeoTrust TLS RSA CA G1</li><li>Thawte TLS RSA CA G1</li><li>Secure Site CA</li><li>NCC Group Secure Server CA G2</li><li>TERENA SSL High Assurance CA 3</li></ul><p>対象かどうかの判断ができない場合は、念のため証明書の発行を受けた認証局にお問い合わせいただくことをお勧めいたします。なお、対象は EV 証明書のみという情報も記載がありますので、その他 (OV や DV) についても対象外と考えることができます。</p><h2 id="必要な対処手順"><a href="#必要な対処手順" class="headerlink" title="必要な対処手順"></a>必要な対処手順</h2><p>もし、失効対象の証明書を Azure の各サービスに適用・利用している場合、認証局より証明書を再取得いただくとともに、それぞれのサービスにおいて証明書の入れ替えが必要になります。それぞれのサービスにおける証明書の入れ替え手順について、以下の資料でご案内させていただいておりますので、もし対象の場合は、内容をご確認のうえ、証明書の入れ替えを実施いただければと思います。</p><p>なお、DigiCert 社のアナウンスでは、7 月 11 日までに対象の証明書については入れ替えを行うようにという案内がありますが、厳密な失効のスケジュールについては、認証局にお問い合わせいただけますようお願いいたします。</p><h3 id="API-Management"><a href="#API-Management" class="headerlink" title="API Management"></a>API Management</h3><p><a href="https://docs.microsoft.com/ja-jp/azure/api-management/api-management-howto-ca-certificates" target="_blank" rel="noopener">Azure API Management でカスタム CA 証明書を追加する方法</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/api-management/configure-custom-domain#use-the-azure-portal-to-set-a-custom-domain-name" target="_blank" rel="noopener">カスタム ドメイン名の構成 - Azure ポータルを使用してカスタム ドメイン名を設定する</a></p><h3 id="Application-Gateway"><a href="#Application-Gateway" class="headerlink" title="Application Gateway"></a>Application Gateway</h3><p><a href="https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-faq#my-ev-certificate-is-issued-by-digicert-and-my-intermediate-certificate-has-been-revoked-how-do-i-renew-my-certificate-on-application-gateway" target="_blank" rel="noopener">My EV certificate is issued by DigiCert and my intermediate certificate has been revoked. How do I renew my certificate on Application Gateway?</a> (現状英語版のみの提供となります)</p><h3 id="App-Service"><a href="#App-Service" class="headerlink" title="App Service"></a>App Service</h3><p><a href="https://azure.github.io/AppService/2020/07/14/Cert-Revoke.html" target="_blank" rel="noopener">Certificate Authorities revoking non-compliant certificates, potentially impacting your App Service</a> (現状英語版のみの提供となります)</p><h3 id="Azure-CDN"><a href="#Azure-CDN" class="headerlink" title="Azure CDN"></a>Azure CDN</h3><p><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-custom-ssl?tabs=option-2-enable-https-with-your-own-certificate#tlsssl-certificates" target="_blank" rel="noopener">チュートリアル:Azure CDN カスタム ドメインで HTTPS を構成する - TLS/SSL 証明書</a></p><h3 id="Azure-Front-Door"><a href="#Azure-Front-Door" class="headerlink" title="Azure Front Door"></a>Azure Front Door</h3><p><a href="https://docs.microsoft.com/ja-jp/azure/frontdoor/front-door-custom-domain-https" target="_blank" rel="noopener">チュートリアル:Front Door カスタム ドメインで HTTPS を構成する</a></p><h3 id="Azure-AD-アプリケーション-プロキシ"><a href="#Azure-AD-アプリケーション-プロキシ" class="headerlink" title="Azure AD アプリケーション プロキシ"></a>Azure AD アプリケーション プロキシ</h3><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/manage-apps/application-proxy-configure-custom-domain#set-up-and-use-custom-domains" target="_blank" rel="noopener">Azure AD アプリケーション プロキシでカスタム ドメインを構成する - カスタム ドメインを設定して使用する</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チームの飯塚です。&lt;/p&gt;
&lt;p&gt;先日、一部の証明書の失効に伴う影響についてのアドバイザリを、以下の URL にて公開するとともに、影響を受ける可能性があるサービスをご利用いただいているお客様に、追跡 ID: PVKM-5T8 でセキュリティ アドバイザリの通知を行いました。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>Azure CDN の特徴やよくあるお問い合わせ、トラブル シューティングの紹介</title>
    <link href="https://jpaztech.github.io/blog/network/cdn-common/"/>
    <id>https://jpaztech.github.io/blog/network/cdn-common/</id>
    <published>2020-07-15T00:00:00.000Z</published>
    <updated>2020-08-18T00:45:29.877Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チーム箕輪です。</p><p>Azure が提供している CDN サービスの Azure CDN において、ご利用いただける機能やよくあるお問合せ、各 SKU の特徴などを踏まえたトラブル シューティングの手順などをご紹介いたします。<br>Azure CDN は現在 4 つの SKU があり、3 社の CDN プロバイダー (Microsoft / Verizon / Akamai) で CDN サービスを提供しています。<br>本ブログは Azure CDN における共通的な事項をまとめたブログとなります。</p><a id="more"></a> <p>各 SKU の特徴や、各 SKU における情報採取の手順については、以下のブログでまとめていますのでご参照ください。</p><ul><li><a href="https://jpaztech.github.io/blog/network/cdn-specific-sku/">Azure CDN の各 SKU の特徴、トラブルシューティングの紹介</a></li></ul><p>本ブログでは、Azure CDN の共通的な機能として、以下の項目についてご案内しています。</p><ul><li>Azure CDN の特徴</li><li>Azure CDN のよくあるお問合せ</li><li>構築・設定変更時のエラーのトラブルシューティング</li><li>接続エラーなどが発生した際のトラブルシューティング</li></ul><br><p><span id="feature-of-azure-cdn"></span></p><h2 id="Azure-CDN-の特徴"><a href="#Azure-CDN-の特徴" class="headerlink" title="Azure CDN の特徴"></a><a href="#feature-of-azure-cdn">Azure CDN の特徴</a></h2><p>Azure CDN は 3 社の CDN プロバイダー (Microsoft / Verizon / Akamai)  で CDN サービスを提供しています。<br>各社の CDN プラットフォームによりご利用いただける機能が異なり、各 SKU の比較は <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-features" target="_blank" rel="noopener">弊社公開情報</a> でご案内しています。<br>Azure CDN の 4 つの SKU で共通して利用できる機能について、弊社公開情報のリンクとあわせてご紹介します。</p><ul><li>固定費用がかからない、転送量に応じた課金体系<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/cdn/" target="_blank" rel="noopener">https://azure.microsoft.com/ja-jp/pricing/details/cdn/</a></li><li>任意のリソース名でプロファイルとエンドポイントが構成でき、既定のエンドポイントは HTTPS に対応<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-create-new-endpoint" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-create-new-endpoint</a></li><li>お客様に管理された任意のドメイン (カスタムドメイン) を利用可能<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-map-content-to-custom-domain" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-map-content-to-custom-domain</a></li><li>Azure CDN で管理された無料の SSL 証明書を用いたカスタムドメインの HTTPS 接続を提供<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-custom-ssl?tabs=option-1-default-enable-https-with-a-cdn-managed-certificate" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-custom-ssl?tabs=option-1-default-enable-https-with-a-cdn-managed-certificate</a></li><li>キャッシュされたコンテンツのキャッシュ消去 (Purge)<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-purge-endpoint" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-purge-endpoint</a></li><li>コンテンツのキャッシュ期間の設定<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-caching-rules" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-caching-rules</a></li><li>キャッシュされたコンテンツのファイル圧縮機能<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-improve-performance" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-improve-performance</a></li><li>リクエストやキャッシュ ヒット数などのログ確認機能<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-azure-diagnostic-logs" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-azure-diagnostic-logs</a></li><li>国/地域別のアクセス制御<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-restrict-access-by-country" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-restrict-access-by-country</a></li></ul><br><p><span id="qa-of-azure-cdn"></span></p><h2 id="Azure-CDN-のよくあるお問合せ"><a href="#Azure-CDN-のよくあるお問合せ" class="headerlink" title="Azure CDN のよくあるお問合せ"></a><a href="#qa-of-azure-cdn">Azure CDN のよくあるお問合せ</a></h2><p>Azure CDN において、お客様よりよくお問い合わせいただく内容についてご紹介いたします。</p><br><p><span id="q1"></span></p><h4 id="Azure-CDN-のリソースのリージョンを指定したい-Azure-CDN-のリソースを日本だけに固定したい"><a href="#Azure-CDN-のリソースのリージョンを指定したい-Azure-CDN-のリソースを日本だけに固定したい" class="headerlink" title="Azure CDN のリソースのリージョンを指定したい / Azure CDN のリソースを日本だけに固定したい"></a><a href="#q1">Azure CDN のリソースのリージョンを指定したい / Azure CDN のリソースを日本だけに固定したい</a></h4><p>Azure CDN では、世界中で構成された CDN の POP からサービスを提供しており、リージョン単位でのサービス提供はしていません。<br>Azure CDN のプロファイルを構成される場合、既定では global というリージョンでリソースが構成され、特定のリージョンだけにお客様の構成情報を適応するといった機能はありません。<br>Azure CDN の構成方法によっては Azure CDN のリージョンが global 以外となる場合がありますが、いずれのリージョンであっても動作や機能に違いはありません。</p><p>接続制限という観点で特定のリージョンを指定されたい場合は、<a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-restrict-access-by-country" target="_blank" rel="noopener">国/地域別の Azure CDN コンテンツの制限</a> の機能をご検討ください。</p><br><p><span id="q2"></span></p><h4 id="Azure-CDN-から更新されたコンテンツが配信されない"><a href="#Azure-CDN-から更新されたコンテンツが配信されない" class="headerlink" title="Azure CDN から更新されたコンテンツが配信されない"></a><a href="#q2">Azure CDN から更新されたコンテンツが配信されない</a></h4><p>Azure CDN はクライアント (ユーザー) からの要求 URL に対して、CDN 上でキャッシュされたコンテンツがあれば CDN から応答し、キャッシュされたコンテンツが無い場合やキャッシュの有効期間が過ぎている場合は、配信元に対象のコンテンツを取得した上で、クライアント (ユーザー) に応答する動作となります。</p><p>配信元のコンテンツを更新されたにもかかわらず、Azure CDN から更新される前のコンテンツが応答される場合は、Azure CDN 上のキャッシュを消去 (Purge) いただくことで、Azure CDN はクライアント (ユーザー) からの要求 URL に対して、配信元に更新されたコンテンツを取得し、クライアント (ユーザー)  に応答します。</p><br><p><span id="q3"></span></p><h4 id="Azure-CDN-を利用した際に発生する費用の考え方について"><a href="#Azure-CDN-を利用した際に発生する費用の考え方について" class="headerlink" title="Azure CDN を利用した際に発生する費用の考え方について"></a><a href="#q3">Azure CDN を利用した際に発生する費用の考え方について</a></h4><p>Azure CDN おいて発生する費用の考え方については、以下の弊社公開情報にてご案内しています。<br>実際に発生する費用や、お客様の固有のご環境における費用のご質問についてご確認されたい場合は、課金の観点で弊社サポート担当までお問い合わせください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-billing" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-billing</a></p><br><p><span id="q4"></span></p><h4 id="新規でエンドポイントを設定したがエラーになる"><a href="#新規でエンドポイントを設定したがエラーになる" class="headerlink" title="新規でエンドポイントを設定したがエラーになる"></a><a href="#q4">新規でエンドポイントを設定したがエラーになる</a></h4><p>Azure CDN は世界中で構成された CDN の POP から CDN サービスを提供しているため、世界中で一意のリソース名で構成される必要があります。<br>設定されたいエンドポイント名が既に利用されている場合はエラーとなり設定ができないため、別のエンドポイント名をご利用ください。<br>(Azure CDN のプロファイル名は任意のリソース名を設定できます。)</p><p>設定されたいエンドポイント名が利用可能かは、<a href="https://docs.microsoft.com/en-us/rest/api/cdn/checknameavailability" target="_blank" rel="noopener">こちらの REST API</a> によりご確認いただけます。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"contoso-cdn"</span>,</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"Microsoft.Cdn/Profiles/Endpoints"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(contoso-cdn をお客様のご利用されたいリソース名に置き換えて Body に入力し、REST API を実行してください)</span><br></pre></td></tr></table></figure><br><p><span id="q5"></span></p><h4 id="カスタムドメインを別のエンドポイントに移行したい"><a href="#カスタムドメインを別のエンドポイントに移行したい" class="headerlink" title="カスタムドメインを別のエンドポイントに移行したい"></a><a href="#q5">カスタムドメインを別のエンドポイントに移行したい</a></h4><p>Azure CDN のエンドポイントに設定されたカスタムドメインの設定を維持したままエンドポイントの変更はできません。<br>カスタムドメインを別のエンドポイントに移行する場合、既存のカスタムドメインの設定を削除いただいた上で移行する必要があります。</p><br><p><span id="q6"></span></p><h4 id="CORS-に対応する方法を知りたい"><a href="#CORS-に対応する方法を知りたい" class="headerlink" title="CORS に対応する方法を知りたい"></a><a href="#q6">CORS に対応する方法を知りたい</a></h4><p>HTTP ヘッダの CORS (クロス オリジン リソース共有) の利用方法については、以下の弊社公開上でご案内しています。<br>CORS の設定後、意図した動作とならない場合は、一度キャッシュ消去 (Purge) を実行いただき、動作をご確認ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-cors" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-cors</a> </p><br><p><span id="q7"></span></p><h4 id="独自の証明書を利用したカスタムドメインの-HTTPS-有効化について"><a href="#独自の証明書を利用したカスタムドメインの-HTTPS-有効化について" class="headerlink" title="独自の証明書を利用したカスタムドメインの HTTPS 有効化について"></a><a href="#q7">独自の証明書を利用したカスタムドメインの HTTPS 有効化について</a></h4><p>カスタムドメインの HTTPS 有効化において、Azure CDN で管理された証明書 (DigiCert 社の証明書) 以外に、独自の証明書 (お客様に準備いただいた証明書) がご利用できます。<br>独自の証明書がご利用いただけるのは Standard Microsoft と Standard Verizon、Premium Verizon となります。<br>Standard Akamai では独自の証明書はご利用いただけず、Let’s Encrypt の証明書で HTTPS 接続が利用できます。<br>独自の証明書をご利用いただく際は、Azure CDN のリソースが構成された同じサブスクリプションに Azure Key Vault リソースを構成いただき、証明書をアップロードする必要があります。</p><p>なお、Standard Microsoft では <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-troubleshoot-allowed-ca" target="_blank" rel="noopener">特定の認証局 (CA) で発行された証明書</a> をご利用いただく必要があります。<br>Standard Verizon、Premium Verizon においては、任意の認証局 (CA) で発行された証明書が利用できますが、自己署名証明書は利用できず、また Azure Key Vault にアップロードいただく証明書には認証局 (CA) の中間証明書を含めるように構成する必要があります。<br>以下の openssl コマンドで、中間 CA 証明書を含んだ PFX 形式の証明書を構成できますのでご参照ください。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -<span class="built_in">export</span> -<span class="keyword">in</span> PublicSSLcert.cer -inkey PrivateKey.key -certfile IntermediateCAcert.cer -out PFXcert.pfx</span><br><span class="line"> </span><br><span class="line">* PublicSSLcert.cer : 認証局 (CA) より発行された SSL 証明書</span><br><span class="line">* PrivateKey.key : 認証局 (CA) に送付した CSR を構成された際の秘密鍵</span><br><span class="line">* IntermediateCAcert.cer : 認証局 (CA) の中間 CA 証明書</span><br><span class="line">* PFXcert.pfx : openssl コマンドにより出力される PFX 形式のファイル</span><br></pre></td></tr></table></figure><br><p><span id="q8"></span></p><h4 id="Azure-CDN-で利用されている-IP-リストが知りたい"><a href="#Azure-CDN-で利用されている-IP-リストが知りたい" class="headerlink" title="Azure CDN で利用されている IP リストが知りたい"></a><a href="#q8">Azure CDN で利用されている IP リストが知りたい</a></h4><p>Azure CDN で利用されている IP リストは、以下の弊社公開情報にて公開しています。<br>Standard Akamai においては、公開された IP リストはありません。<br>配信元 (オリジン) で Azure CDN からの接続を IP リストで制限されたい場合は、Standard Microsoft、Standard Verizon、Premium Verizon をご利用ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-pop-list-api" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-pop-list-api</a></p><br><p><span id="q9"></span></p><h4 id="配信元-オリジン-に-HTTPS-だけ接続するようにしたい"><a href="#配信元-オリジン-に-HTTPS-だけ接続するようにしたい" class="headerlink" title="配信元 (オリジン) に HTTPS だけ接続するようにしたい"></a><a href="#q9">配信元 (オリジン) に HTTPS だけ接続するようにしたい</a></h4><p>Azure CDN の動作として、クライアント (ユーザー) からの要求プロトコルを用いて配信元 (オリジン) に接続する動作となります。<br>クライアント (ユーザー) が HTTP で要求 URL を送信した場合、Azure CDN は配信元 (オリジン) に HTTP でコンテンツを取得します。</p><p>クライアント (ユーザー) からの HTTP の要求 URL を HTTPS にリダイレクトしたい場合、Standard Microsoft と Premium Verizon で提供しているルール エンジンを利用いただく必要があります。<br>Standard Akamai や Standard Verizon はルール エンジンが利用できないため、HTTPS リダイレクトは構成できません。<br>HTTPS リダイレクトを構成する方法は、以下の弊社公開情報でご案内しておりますのでご参照ください。<br>なお、Azure CDN のエンドポイントの設定で、HTTP を受け入れプロトコルとして許可していない場合、HTTPS へのリダイレクトは動作しない点はご注意ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-storage-custom-domain-https#http-to-https-redirection" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-storage-custom-domain-https#http-to-https-redirection</a></p><br><p><span id="q10"></span></p><h4 id="Azure-CDN-で認証機能を利用したい"><a href="#Azure-CDN-で認証機能を利用したい" class="headerlink" title="Azure CDN で認証機能を利用したい"></a><a href="#q10">Azure CDN で認証機能を利用したい</a></h4><p>Premium Verizon では <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-token-auth" target="_blank" rel="noopener">トークン認証</a> の機能を提供しておりますが、それ以外の認証機能 (基本認証、クライアント認証など) は Azure CDN では提供していません。<br>配信元 (オリジン) として Azure Storage をご利用されている環境では、Azure Storage の SAS (Shared Access Signature) の機能を利用し、以下の公開情報でご案内しておりますのでご参照ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-sas-storage-support" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-sas-storage-support</a></p><br><p><span id="q11"></span></p><h4 id="Azure-CDN-で対象の-URL-がキャッシュされているかを確認したい"><a href="#Azure-CDN-で対象の-URL-がキャッシュされているかを確認したい" class="headerlink" title="Azure CDN で対象の URL がキャッシュされているかを確認したい"></a><a href="#q11">Azure CDN で対象の URL がキャッシュされているかを確認したい</a></h4><p>Azure ポータルなどの機能で、対象の URL のコンテンツが CDN 上にキャッシュされているかを確認する機能はありませんが、対象の URL への応答における HTTP ヘッダを確認することで、CDN 上に対象の URL のコンテンツがキャッシュされているかを確認できます。<br>確認方法として、HTTP ヘッダの x-cache が HIT や TCP_HIT となっている場合、Azure CDN 上でキャッシュされたコンテンツが応答されている状態となります。</p><p>HTTP ヘッダの x-cache の確認方法としては、<a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/capture-browser-trace" target="_blank" rel="noopener">Web プラウザにおけるネットワーク トレース (F12) </a> で、対象 URL の HTTP の x-cache の応答ヘッダを確認いただくか、以下の curl コマンドの結果で x-cache を確認できます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -H https://contoso-cdn.azureedge.net/xxx/xxx</span><br><span class="line"></span><br><span class="line">(http や https 以降を対象の URL に置き換えて実行ください)</span><br></pre></td></tr></table></figure><p>Standard Akamai では、Web プラウザでは HTTP ヘッダの x-cache を確認できないため、以下の curl コマンドでご確認ください。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">"Pragma: akamai-x-cache-on"</span> \</span><br><span class="line">-IXGET https://contoso-cdn.azureedge.net/xxx/xxx</span><br><span class="line"></span><br><span class="line">(http や https 以降を対象の URL に置き換えて実行ください)</span><br></pre></td></tr></table></figure><br><p><span id="troubleshooting-changing-settings"></span></p><h2 id="構築・設定変更時のエラーのトラブルシューティング"><a href="#構築・設定変更時のエラーのトラブルシューティング" class="headerlink" title="構築・設定変更時のエラーのトラブルシューティング"></a><a href="#troubleshooting-changing-settings">構築・設定変更時のエラーのトラブルシューティング</a></h2><p>Azure CDN を新規で構築されている場合、または設定変更後に Azure CDN を介してコンテンツが取得できなくなった場合は以下をお試しください。</p><br><p><span id="troubleshooting-1"></span></p><h4 id="Azure-CDN-を新規で構築した場合"><a href="#Azure-CDN-を新規で構築した場合" class="headerlink" title="Azure CDN を新規で構築した場合"></a><a href="#troubleshooting-1">Azure CDN を新規で構築した場合</a></h4><p>Azure CDN を新規で構築された場合、世界中にある POP に構成情報を展開するため、新規でリソースを構成いただいた後に反映までしばらくお時間を要します。<br>Azure CDN の SKU によって以下の通り反映に要する時間が異なります。<br>特に Verizon SKU をご利用いただいているご環境においては設定の反映に 90 分はお時間を要し、90 分以内に動作を確認されても想定された動作とならない可能性があります。<br>その場合は、90 分お待ちいただいた上で動作をご確認ください。</p><p>　Standard Microsoft : 10 分<br>　Standard Verizon / Premium Verizon : 90 分<br>　Standard Akamai : 1 分</p><br><p><span id="troubleshooting-2"></span></p><h4 id="DNS-関連の変更をした場合"><a href="#DNS-関連の変更をした場合" class="headerlink" title="DNS 関連の変更をした場合"></a><a href="#troubleshooting-2">DNS 関連の変更をした場合</a></h4><p>DNS 関連の変更などをした場合、一般的に DNS の設定の反映にはしばらく時間を要するため、設定直後に確認された際には意図した結果とならない可能性があります。<br>例えば DNS の参照する先を変更した場合などは、クライアント環境においてキャッシュ DNS をクリアなどしてから状況が変わるかをお試しください。<br>また、<a href="https://digwebinterface.com/" target="_blank" rel="noopener">オンライン ツール</a> などをご利用いただき、DNS の最新の状況についてご確認ください。</p><br><p><span id="troubleshooting-3"></span></p><h4 id="Azure-CDN-の設定反映"><a href="#Azure-CDN-の設定反映" class="headerlink" title="Azure CDN の設定反映"></a><a href="#troubleshooting-3">Azure CDN の設定反映</a></h4><p>Azure CDN は世界中にある POP の CDN のリソースに変更された構成情報を展開するため、Azure ポータルなどで変更された内容が各 POP に反映されるまで時間を要します。<br>目安としては 10 分ほどお待ちいただき、変更された内容が適応されているかをご確認ください。<br>また、既に CDN 上にキャッシュなどがある場合、意図した動作とならない可能性があるため、各設定の反映を確認するためにキャッシュの消去 (Purge) を一度実施いただくことをお勧めいたします。</p><p>なお、設定変更後に時間を空けずに別の変更を設定された場合、設定の反映に齟齬が発生し、意図した設定が適応されない事象が発生する可能性があります。<br>そのため、各設定変更の後は少なくとも 10 分はお時間を空けてからお試しください。</p><p>また、カスタムドメインやエンドポイントの削除を伴う変更については、短時間で削除、再生成をするとエラーとなる可能性があります。<br>同じカスタムドメインやエンドポイント名をご利用される場合は、削除後に目安として 2 時間ほど時間を空けてから再生成ください。</p><br><p><span id="troubleshooting-connection-error"></span></p><h2 id="接続エラーなどが発生した際のトラブルシューティング"><a href="#接続エラーなどが発生した際のトラブルシューティング" class="headerlink" title="接続エラーなどが発生した際のトラブルシューティング"></a><a href="#troubleshooting-connection-error">接続エラーなどが発生した際のトラブルシューティング</a></h2><p>設定変更などを実施されていないご状況において、Azure CDN を介してコンテンツが取得できなくなった場合は以下をお試しください。</p><p><strong>0. エラー状況の確認</strong></p><p>Azure CDN を介して対象の URL において、ライアント (ユーザー) からコンテンツが取得できないエラーなどが発生した場合、<a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/capture-browser-trace" target="_blank" rel="noopener">Web プラウザのネットワーク トレース (F12) の機能</a> や curl を利用し、対象の URL の応答結果の確認をすることで、エラーの状況を確認することができます。</p><ul><li><p><strong>HTTP レスポンスが応答されない</strong> <br>クライアント (ユーザー) から Azure CDN までのネットワークにおいて DNS レイヤーや TCP レイヤーに障害などが発生し接続ができていない可能性があります。<br>Azure CDN はパブリック ネットワークから接続ができるため、異なるクライアント環境やネットワーク環境から接続が可能かをご確認ください。<br>特定のネットワークからのみ接続ができない場合、ネットワーク管理者などにネットワーク状況をお問い合わせください。</p></li><li><p><strong>いずれかの HTTP レスポンスが応答される</strong> <br>Azure CDN か、Azure CDN と配信元 (オリジン) 間のネットワーク、または配信元 (オリジン) で障害などが発生している可能性があります。<br>次の手順で、Azure CDN と配信元 (オリジン) の被疑箇所を切り分けます。</p></li></ul><p><strong>1. 配信元の状況確認</strong> </p><p>配信元 (オリジン) のエンドポイント (URL) にアクセスし、想定されるコンテンツが取得できるかをご確認ください。<br>配信元 (オリジン) から想定されたコンテンツが取得できない場合、配信元 (オリジン) の障害などの影響により Azure CDN からコンテンツが応答できていない可能性があります。<br>配信元 (オリジン) から想定されたコンテンツが取得でき、Azure CDN からコンテンツが取得できない場合は、次の手順で被疑箇所を切り分けます。</p><p><strong>2. 配信元の証明書の状態を確認する</strong> </p><p>Azure CDN はクライアント (ユーザー) からプロトコルで配信元 (オリジン) に転送してコンテンツを取得します。<br>HTTPS 接続においては、Azure CDN や配信元 (オリジン) の HTTPS 接続のための SSL/TLS 証明書の有効期限切れなどによりエラーが発生する場合があります。<br>この場合、HTTP 接続で Azure CDN を介してコンテンツの取得が可能かをご確認ください。</p><p>TLS/SSL 証明書の状態については、以下の openssl コマンドを用いて確認することが可能です。<br>以下の openssl コマンドで証明書の有効期限切れなどが確認できた場合、証明書の状況をご確認ください。<br>証明書に問題がなく、引き続き Azure CDN からコンテンツが取得できない場合は、次の手順で改善されるかお試しください。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Azure CDN へのTLS 接続確認]</span><br><span class="line">openssl s_client -connect &lt;Azure CDN のエンドポイント (xxx..azureedge.net)&gt;:443 -servername &lt;FQDN&gt; -showcerts</span><br><span class="line"></span><br><span class="line">[バックエンドへの TLS 接続確認]</span><br><span class="line">openssl s_client -connect &lt;バックエンドのパブリック IP アドレスや FQDN&gt;:443 -servername &lt;FQDN&gt; -showcerts</span><br></pre></td></tr></table></figure><p><strong>3. キャッシュ消去 (Purge)</strong> </p><p>Azure CDN 上でクライアント (オリジン) からの要求 URL に対して意図しないコンテンツをキャッシュし、エラーが応答されている可能性があります。<br>一度、キャッシュ消去 (Purge) を実施いただいた上で、クライアント (ユーザー) から Azure CDN に再接続し、エラー状況をご確認ください。</p><p><strong>4. 情報採取</strong></p><p>上記を実施いただき、事象が改善されない場合は、ご利用いただいている SKU に応じて情報取得をいただき、弊社サポート担当までお問い合わせください。</p><ul><li><a href="https://jpaztech.github.io/blog/network/cdn-specific-sku/#collect-information-standard-microsoft">Standard Microsoft においてエラー発生時にご提供いただきたい情報</a></li><li><a href="https://jpaztech.github.io/blog/network/cdn-specific-sku/#collect-information-standard-verizon-premium-verizon">Standard Verizon / Premium Verizon においてエラー発生時にご提供いただきたい情報</a></li><li><a href="https://jpaztech.github.io/blog/network/cdn-specific-sku/#collect-information-standard-akamai">Standard Akamai においてエラー発生時にご提供いただきたい情報</a></li></ul><br><p>本ブログが皆様のお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チーム箕輪です。&lt;/p&gt;
&lt;p&gt;Azure が提供している CDN サービスの Azure CDN において、ご利用いただける機能やよくあるお問合せ、各 SKU の特徴などを踏まえたトラブル シューティングの手順などをご紹介いたします。&lt;br&gt;Azure CDN は現在 4 つの SKU があり、3 社の CDN プロバイダー (Microsoft / Verizon / Akamai) で CDN サービスを提供しています。&lt;br&gt;本ブログは Azure CDN における共通的な事項をまとめたブログとなります。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="AzureCDN" scheme="https://jpaztech.github.io/blog/tags/AzureCDN/"/>
    
      <category term="Troubleshooting" scheme="https://jpaztech.github.io/blog/tags/Troubleshooting/"/>
    
  </entry>
  
  <entry>
    <title>Azure CDN の各 SKU の特徴、トラブルシューティングの紹介</title>
    <link href="https://jpaztech.github.io/blog/network/cdn-specific-sku/"/>
    <id>https://jpaztech.github.io/blog/network/cdn-specific-sku/</id>
    <published>2020-07-15T00:00:00.000Z</published>
    <updated>2020-08-18T00:45:29.877Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チーム箕輪です。</p><p>Azure が提供している CDN サービスの Azure CDN において、ご利用いただける機能やよくあるお問合せ、各 SKU の特徴などを踏まえたトラブル シューティングの手順などをご紹介いたします。<br>Azure CDN は現在 4 つの SKU があり、3 社の CDN プロバイダー (Microsoft / Verizon / Akamai) で CDN サービスを提供しております。<br>本ブログは Azure CDN で提供している 4 つの SKU の特徴や、各 SKU における情報採取手順などをまとめたブログとなります。</p><a id="more"></a> <p>Azure CDN における共通的な事項については、以下のブログでまとめておりますのでご参照ください。</p><ul><li><a href="https://jpaztech.github.io/blog/network/cdn-common/">Azure CDN の特徴やよくあるお問い合わせ、トラブル シューティングの紹介</a></li></ul><p>本ブログでは、Azure CDN の各 SKU の特徴についてご案内しております。</p><ul><li>Azure CDN における各 SKU の特徴</li><li>ルール エンジンの設定</li><li>エラー発生時の情報採取手順</li></ul><br><p><span id="feature-of-azure-cdn-sku"></span></p><h2 id="Azure-CDN-における各-SKU-の特徴"><a href="#Azure-CDN-における各-SKU-の特徴" class="headerlink" title="Azure CDN における各 SKU の特徴"></a><a href="#feature-of-azure-cdn-sku">Azure CDN における各 SKU の特徴</a></h2><p>Azure CDN における各 SKU の機能一覧については、<a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-features" target="_blank" rel="noopener">弊社公開情報</a> でご案内しております。<br>本ブログでは、<a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-features" target="_blank" rel="noopener">弊社公開情報</a> でご案内している内容をもとに、各 SKU の特徴について関連するドキュメントと紹介します。</p><br><p><span id="standard-microsoft"></span></p><h4 id="Standard-Microsoft"><a href="#Standard-Microsoft" class="headerlink" title="Standard Microsoft"></a><a href="#standard-microsoft">Standard Microsoft</a></h4><p>Standard Microsoft は、Microsoft のインフラストラクチャー上で構成された CDN プラットフォームを用いてサービスを提供しています。<br>Azure CDN の SKU としては最も新しく提供された SKU で、新規機能の追加などが随時行われております。<br>Azure CDN の中で、2020 年 7 月時点で唯一 WAF 機能を利用できる SKU となっており、配信元が Azure サービスであればデータ転送料の観点で他の SKU よりも優れています。<br>また、アクセス ログの取得の機能も実装されております。<br>動的コンテンツの最適化については <a href="https://docs.microsoft.com/ja-jp/azure/frontdoor/front-door-overview" target="_blank" rel="noopener">Azure Front Door</a> で機能を提供しています。</p><ul><li>ルール エンジンによるカスタマイズ設定<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine-reference" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine-reference</a></li><li>WAF 機能の追加 (プレビュー)<br><a href="https://docs.microsoft.com/ja-jp/azure/web-application-firewall/cdn/cdn-overview" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/web-application-firewall/cdn/cdn-overview</a></li><li>アクセス ログの取得<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/enable-raw-logs" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/enable-raw-logs</a></li><li>独自証明書で指定の認証局 (CA) による制限<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-troubleshoot-allowed-ca" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-troubleshoot-allowed-ca</a></li><li>配信元 (オリジン) が Azure サービスの場合、配信元から CDN へのデータ転送が無料<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-billing#which-origin-services-are-eligible-for-free-data-transfer-with-azure-cdn-from-microsoft" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-billing#which-origin-services-are-eligible-for-free-data-transfer-with-azure-cdn-from-microsoft</a></li></ul><br><p><span id="standard-premium-verizon"></span></p><h4 id="Standard-Premium-Verizon"><a href="#Standard-Premium-Verizon" class="headerlink" title="Standard / Premium Verizon"></a><a href="#standard-premium-verizon">Standard / Premium Verizon</a></h4><p>Standard Verizon、Premium Verizon は Verizon Digital Media Services 社の CDN プラットフォームを用いて CDN サービスを提供しています。<br>Azure ポータルから Verizon のポータルに接続することで、CDN に関わるログをグラフ化して確認することができます。<br>Azure Media Service において、ストリーミング エンドポイントで CDN を用いた際に既定で選択される SKU であり、メディア ストリーミングの最適化に優れています。<br>Premium Verizon は他の SKU と価格が異なりますが、多機能のルール エンジンや詳細なレポートなどがご利用いただけます。</p><ul><li>任意の認証局 (CA) が発行した証明書を利用可能</li><li>キャッシュの事前読み込み機能<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-preload-endpoint" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-preload-endpoint</a></li><li>視覚化されたグラフ<br>(1) <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-analyze-usage-patterns" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-analyze-usage-patterns</a><br>(2) <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-custom-reports" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-custom-reports</a></li><li>メディア ストリーミングの最適化に優れている (Azure Media Service の既定の SKU)<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-media-streaming-optimization#media-streaming-optimizations-for-azure-cdn-from-verizon" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-media-streaming-optimization#media-streaming-optimizations-for-azure-cdn-from-verizon</a></li><li>ルールエンジンによるカスタマイズ (Premium のみ)<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference</a></li><li>詳細なレポート (Premium のみ)<br>(1) <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-advanced-http-reports" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-advanced-http-reports</a><br>(2) <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-real-time-stats" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-real-time-stats</a><br>(3) <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-edge-performance" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-edge-performance</a><br>(4) <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-real-time-alerts" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-real-time-alerts</a></li><li>トークン認証 (Premium のみ)<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-token-auth" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-token-auth</a></li></ul><br><p><span id="standard-akamai"></span></p><h4 id="Standard-Akamai"><a href="#Standard-Akamai" class="headerlink" title="Standard Akamai"></a><a href="#standard-akamai">Standard Akamai</a></h4><p>Standard Akamai は Akamai 社の CDN プラットフォームを用いて CDN サービスを提供しております。<br>Akamai 社は世界最大規模の CDN プラットフォームで CDN サービスを提供しており、動的なサイトの最適化に優れています。<br>なお、Akamai 社が提供している Akamai Control Center (旧 Luna Control Center) は Azure CDN ではご利用いただけません。</p><ul><li>キャッシュ消去 (Purge) や設定変更の反映が迅速</li><li>Let’s Encrypt を用いたカスタムドメインの HTTPS 有効化</li><li>動的なサイトの最適化機能<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-dynamic-site-acceleration" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-dynamic-site-acceleration</a></li><li>メディア ストリーミングの最適化機能<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-media-streaming-optimization#media-streaming-optimizations-for-azure-cdn-from-akamai" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-media-streaming-optimization#media-streaming-optimizations-for-azure-cdn-from-akamai</a></li></ul><br><p><span id="setting-of-rule-engine"></span></p><h2 id="ルール-エンジンの設定"><a href="#ルール-エンジンの設定" class="headerlink" title="ルール エンジンの設定"></a><a href="#setting-of-rule-engine">ルール エンジンの設定</a></h2><p>Azure CDN では 2020 年 7 月時点で Standard Microsoft と Premium Verizon でルール エンジンの機能を提供しています。<br>ルール エンジンは以下の項目においてカスタマイズが可能です。</p><ul><li>キャッシュ規則のカスタマイズ</li><li>クライアント (ユーザー) からの要求をリダイレクト</li><li>HTTP の要求ヘッダーや応答ヘッダーの変更</li><li>(Premium Verizon のみ) クライアント (ユーザー) からの要求を拒否 (403 で応答) する</li></ul><br><p><span id="setting-of-rule-engine-standard-microsoft"></span></p><h4 id="Standard-Microsoft-におけるルール-エンジンの設定"><a href="#Standard-Microsoft-におけるルール-エンジンの設定" class="headerlink" title="Standard Microsoft におけるルール エンジンの設定"></a><a href="#setting-of-rule-engine-standard-microsoft">Standard Microsoft におけるルール エンジンの設定</a></h4><p>Stnadard Microsoft のルール エンジンの設定は Azure ポータルから実施いただけます。<br>ルール エンジンの設定の考え方として、対象の通信を <strong>一致条件</strong> で指定し、対象の通信に対して実施したい <strong>アクション</strong> を設定することで動作します。<br>Standard Microsoft のルール エンジンの設定は、エンドポイント単位で管理、適応されております。</p><p>設定の一例として、Azure CDN はクライアント (ユーザー) から HTTP で接続された場合、配信元 (オリジン) に対して HTTP で接続します。<br>この通信経路をすべて HTTPS で暗号化されたいシナリオにおいて、<a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine" target="_blank" rel="noopener">ルール エンジンを利用した HTTPS リダイレクト</a> を設定することで、クライアント (ユーザー) から Azure CDN を介した通信経路がすべて HTTPS となります。<br>この設定においては、Azure CDN のエンドポイントで受け入れプロトコルを HTTP/HTTPS としていただく点と、カスタムドメインにおいては HTTPS 有効化を構成いただく必要がある点はご留意ください。</p><br><p><span id="troubleshooting-setting-of-rule-engine"></span></p><h4 id="Standard-Microsoft-におけるルール-エンジンの設定のトラブルシューティング"><a href="#Standard-Microsoft-におけるルール-エンジンの設定のトラブルシューティング" class="headerlink" title="Standard Microsoft におけるルール エンジンの設定のトラブルシューティング"></a><a href="#troubleshooting-setting-of-rule-engine">Standard Microsoft におけるルール エンジンの設定のトラブルシューティング</a></h4><p>設定を保存されたルール エンジンは、世界中の POP に適応するため、設定後の反映にはおおよそ 10 分ほど時間が掛かることが想定された動作となります。<br>そのため、設定後は少しお時間をあけてから設定の反映をご確認ください。<br>また、ルール エンジンの設定を反映する間に短時間で何度も設定を変更し保存した場合、設定情報が意図しない状態となる可能性があるため、設定を変更さえる場合はお時間を空けて実施ください。</p><p>設定後も意図した動作にならないなどご確認されたい事項がございましたら、以下の情報をもとに弊社サポート担当までお問い合わせください。</p><p><strong>[ご提供いただきたい情報]</strong></p><ul><li>Azure CDN が構成されている 32 桁の サブスクリプションID</li><li>Azure CDN のプロファイル名</li><li>ルール エンジンを設定したエンドポイント名</li><li>ルール エンジンの設定名</li><li>設定されたい要件の詳細</li></ul><br><p><span id="document-setting-of-rule-engine-standard-microsoft"></span></p><h4 id="Standard-Microsoft-のルール-エンジンに関する弊社公開情報"><a href="#Standard-Microsoft-のルール-エンジンに関する弊社公開情報" class="headerlink" title="Standard Microsoft のルール エンジンに関する弊社公開情報"></a><a href="#document-setting-of-rule-engine-standard-microsoft">Standard Microsoft のルール エンジンに関する弊社公開情報</a></h4><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine-reference" target="_blank" rel="noopener">Azure CDN の Standard ルール エンジン リファレンス</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine-match-conditions" target="_blank" rel="noopener">Azure CDN の Standard ルール エンジンの一致条件</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine-actions" target="_blank" rel="noopener">Azure CDN の Standard ルール エンジンでのアクション</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine" target="_blank" rel="noopener">Standard ルール エンジンの HTTPS リダイレクト設定</a></li></ul><br><p><span id="setting-of-rule-engine-premium-verizon"></span></p><h4 id="Premium-Verizon-におけるルール-エンジンの設定"><a href="#Premium-Verizon-におけるルール-エンジンの設定" class="headerlink" title="Premium Verizon におけるルール エンジンの設定"></a><a href="#setting-of-rule-engine-premium-verizon">Premium Verizon におけるルール エンジンの設定</a></h4><p>Premium Verizon のルール エンジンの設定は Azure ポータルからログインできる Verizon ポータルで実施いただけます。<br>概要としては、<a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference" target="_blank" rel="noopener">弊社公開情報</a> より確認いただけますが、ルール エンジンの設定の考え方として、対象の通信を <strong>一致条件</strong> で指定し、対象の通信に対して実施したい <strong>機能</strong> を設定することで動作します。<br>Premium Verizon のルール エンジンの設定は、プロファイル単位で管理されており、プロファイルのエンドポイントに対して設定を反映することができます。</p><p>Premium Verizon のルール エンジンは現在 v4 とよばれるバージョンで動作しており、ルール エンジンは <strong>ポリシー</strong> と呼ばれる単位で管理しています。<br><strong>ポリシー</strong> から新規でルール エンジンを設定いただくと <strong>Draft</strong> が構成されます。<br>設定された <strong>Draft</strong> から設定を適応される場合、<strong>Draft</strong> の <strong>Lock Draft as Policy</strong> を選択後、<strong>Deploy Request</strong> から <strong>Production</strong> を選択いただき、<strong>Create Deploy Request</strong> と進めていただければ、<strong>ポリシー</strong> で設定いただいたルール エンジンが適応されます。<br><strong>Create Deploy Request</strong> 後、ルール エンジンの設定は数分で完了いたしますが、実際の環境に適応されるまでは構成によりますが、少なくとも <strong>20 分</strong> はかかりますので、設定の反映を確認される場合はお時間を空けて動作をご確認ください。</p><br><p><span id="troubleshooting-setting-of-rule-engine-premium-verizon"></span></p><h4 id="Premium-Verizon-におけるルール-エンジンの設定のトラブルシューティング"><a href="#Premium-Verizon-におけるルール-エンジンの設定のトラブルシューティング" class="headerlink" title="Premium Verizon におけるルール エンジンの設定のトラブルシューティング"></a><a href="#troubleshooting-setting-of-rule-engine-premium-verizon">Premium Verizon におけるルール エンジンの設定のトラブルシューティング</a></h4><p>Premium Verizon のルール エンジンの設定においては、<strong>Lock Draft as Policy</strong> や <strong>Create Deploy Request</strong> において検証がされる動作となりますので、設定ができないパラメータなどがある場合は、設定時にエラー メッセージが表示される動作となります。<br><strong>Create Deploy Request</strong> を実施いただいた後も、エラー メッセージが表示されずに設定が完了し、お時間を空けてご確認いただいたにも関わらず想定された動作とならない場合、Verizon 社のエンジニアと設定状況について調査いたしますので、以下の情報をもとに弊社サポート担当までお問い合わせください。</p><p><strong>[ご提供いただきたい情報]</strong></p><ul><li>Azure CDN が構成されている 32 桁の サブスクリプションID</li><li>Azure CDN のプロファイル名</li><li>ルール エンジンを設定されたい CDN のエンドポイント名</li><li>ルール エンジン設定画面の右上に記載れた 5 桁の ID (Verizon Account ID)</li><li>設定されたルール エンジンの 画面キャプチャ</li><li>設定されたルール エンジンの XML 情報 (ルール エンジンの設定画面で確認いただけます)</li><li>設定されたい要件の詳細</li></ul><br><p><span id="document-setting-of-rule-engine-premium-verizon"></span></p><h4 id="Premium-Verizon-のルール-エンジンに関するドキュメント"><a href="#Premium-Verizon-のルール-エンジンに関するドキュメント" class="headerlink" title="Premium Verizon のルール エンジンに関するドキュメント"></a><a href="#document-setting-of-rule-engine-premium-verizon">Premium Verizon のルール エンジンに関するドキュメント</a></h4><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference" target="_blank" rel="noopener">Azure CDN from Verizon Premium ルール エンジンのリファレンス</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference-conditional-expressions" target="_blank" rel="noopener">Azure CDN from Verizon Premium ルール エンジンの条件式</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference-match-conditions" target="_blank" rel="noopener">Azure CDN from Verizon Premium ルール エンジンの一致条件</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference-features" target="_blank" rel="noopener">Azure CDN from Verizon Premium ルール エンジンの機能</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-http-variables" target="_blank" rel="noopener">Azure CDN from Verizon Premium ルール エンジンの HTTP 変数</a></li></ul><br><p><span id="setting-of-waf"></span></p><h2 id="WAF-の設定"><a href="#WAF-の設定" class="headerlink" title="WAF の設定"></a><a href="#setting-of-waf">WAF の設定</a></h2><p>WAF の機能は 2020 年 7 月時点で Standard Microsoft においてプレビュー提供をしています。<br>WAF では OWASP のルール セットに準拠した Azure で管理されたルール セットの他に、カスタム規則でルールを設定することができます。<br>Standard Microsoft で構成されたエンドポイントに対して 1 つの WAF が関連付けできます。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/web-application-firewall/cdn/cdn-overview" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/web-application-firewall/cdn/cdn-overview</a></p><p>2020 年 7月時点の動作として、WAF がエンドポイントに関連付けられた状態において、カスタム規則の変更は一部制限がかかる場合があります。<br>WAF のカスタム規則において意図した設定が追加できない場合は、一度エンドポイントとの関連付けを解除した上で設定の変更をお試しください。</p><br><p><span id="collect-information"></span></p><h2 id="エラー発生時の情報採取手順"><a href="#エラー発生時の情報採取手順" class="headerlink" title="エラー発生時の情報採取手順"></a><a href="#collect-information">エラー発生時の情報採取手順</a></h2><p>Azure CDN では Microsoft 以外に Verizon 社と Akamai 社の CDN プラットフォームで CDN サービスを提供していることから、事象に応じて各社と連携して調査を実施する必要があります。<br>SKU によって情報採取の手順が一部異なりますので、弊社サポート担当にお問い合わせいただく際に以下をご確認いただき、情報採取にご協力いただければ幸いです。</p><br><p><span id="collect-information-standard-microsoft"></span></p><h4 id="Standard-Microsoft-においてエラー発生時にご提供いただきたい情報"><a href="#Standard-Microsoft-においてエラー発生時にご提供いただきたい情報" class="headerlink" title="Standard Microsoft においてエラー発生時にご提供いただきたい情報"></a><a href="#collect-information-standard-microsoft">Standard Microsoft においてエラー発生時にご提供いただきたい情報</a></h4><p>Standard Microsoft では、CDN を介した通信における HTTP ヘッダの <strong>x-azure-ref</strong> が、サポート担当が Azure 基盤のログを確認するために必要な情報となります。<br>情報採取の際は以下の情報に加えて、事象が発生した際の HTTP ヘッダの <strong>x-azure-ref</strong> を取得いただき、お問合せ時にご共有いただけますと幸いです。</p><p><strong>[ご提供いただきたい情報]</strong></p><ul><li>Azure CDN が構成されている 32 桁の サブスクリプションID</li><li>Azure CDN のプロファイル名</li><li>Azure CDN のエンドポイント名</li><li>事象が発生している URL (FQDN) </li><li>事象の概要</li><li>HTTP ヘッダの x-azure-ref の結果 (画像ではなくテキスト ベースでご共有願います)</li></ul><p>HTTP ヘッダの <strong>x-azure-ref</strong> は以下の方法でご確認いただけます。</p><ol><li><a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/capture-browser-trace" target="_blank" rel="noopener">Web プラウザにおけるネットワーク トレース (F12)</a> で確認する</li><li>curl コマンドで確認する。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -I  https://www.contoso.com/path/pic.png</span><br><span class="line"></span><br><span class="line">(https://www.contoso.com/path/pic.png の箇所は CDN にアクセスする際の URL に変えて実施ください)</span><br></pre></td></tr></table></figure><br><p><span id="collect-information-standard-verizon-premium-verizon"></span></p><h4 id="Standard-Verizon-Premium-Verizon-においてエラー発生時にご提供いただきたい情報"><a href="#Standard-Verizon-Premium-Verizon-においてエラー発生時にご提供いただきたい情報" class="headerlink" title="Standard Verizon / Premium Verizon においてエラー発生時にご提供いただきたい情報"></a><a href="#collect-information-standard-verizon-premium-verizon">Standard Verizon / Premium Verizon においてエラー発生時にご提供いただきたい情報</a></h4><p>Standard Verizon、Premium Verizon は Verizon 社の CDN プラットフォームでサービスを提供しているため、調査は Verizon 社のエンジニアと共同で実施いたします。<br>Verizon 社のエンジニアとスムーズに連携して調査をするため、情報採取の際は以下の情報をお問合せ時にご共有いただけますと幸いです。</p><p><strong>[ご提供いただきたい情報]</strong></p><ul><li>Azure CDN が構成されている 32 桁の サブスクリプションID</li><li>Azure CDN のプロファイル名</li><li>Azure CDN のエンドポイント名</li><li>事象が発生している URL (FQDN) </li><li>事象の概要</li><li><a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/capture-browser-trace" target="_blank" rel="noopener">Web プラウザにおけるネットワーク トレース (F12) の結果</a></li></ul><br><p><span id="collect-information-standard-akamai"></span></p><h4 id="Standard-Akamai-においてエラー発生時にご提供いただきたい情報"><a href="#Standard-Akamai-においてエラー発生時にご提供いただきたい情報" class="headerlink" title="Standard Akamai においてエラー発生時にご提供いただきたい情報"></a><a href="#collect-information-standard-akamai">Standard Akamai においてエラー発生時にご提供いただきたい情報</a></h4><p>Standard Akamai は Akamai 社の CDN プラットフォームでサービスを提供しているため、調査は Akamai 社のエンジニアと共同で実施いたします。<br>Standard Akamai では、CDN からエラーメッセージを応答された場合に、画面上に <strong>Reference</strong> と呼ばれるエラー コードが記載されます。<br>この  <strong>Reference</strong>  のエラー コードを元に調査することが可能となりますので、お問合せ時にご共有いただけますと幸いです。</p><p><img src="/blog/network/cdn-specific-sku/reference-error-code.png" alt="参考 : Reference のエラー コード">  </p><p>また、Standard Akamai では Web プラウザにおけるネットワーク トレース (F12) では十分な情報が取得できない場合があります。<br>そのため、Akamai 社のエンジニアとスムーズに連携して調査をするため、情報採取の際は以下の情報に加えて、以下の curl コマンドの実行結果をお問合せ時にご共有いただけますと幸いです。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -H \</span><br><span class="line"> <span class="string">"Pragma: akamai-x-cache-on, akamai-x-cache-remote-on, akamai-x-check-cacheable, akamai-x-get-cache-key, akamai-x-get-extracted-values, akamai-x-get-nonces, akamai-x-get-ssl-client-session-id, akamai-x-get-true-cache-key, akamai-x-serial-no"</span> \</span><br><span class="line"> -IXGET https://www.contoso.com/path/pic.png</span><br><span class="line"> </span><br><span class="line">(https://www.contoso.com/path/pic.png の箇所は CDN にアクセスする際の URL に変えて実施ください)</span><br></pre></td></tr></table></figure><p><strong>[ご提供いただきたい情報]</strong></p><ul><li>Azure CDN が構成されている 32 桁の サブスクリプションID</li><li>Azure CDN のプロファイル名</li><li>Azure CDN のエンドポイント名</li><li>事象が発生している URL (FQDN) </li><li>事象の概要</li><li>Reference のエラー コード(画像ではなくテキスト ベースでご共有願います)</li><li>以下の curl コマンドの実行結果</li></ul><br><p>本ブログが皆様のお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チーム箕輪です。&lt;/p&gt;
&lt;p&gt;Azure が提供している CDN サービスの Azure CDN において、ご利用いただける機能やよくあるお問合せ、各 SKU の特徴などを踏まえたトラブル シューティングの手順などをご紹介いたします。&lt;br&gt;Azure CDN は現在 4 つの SKU があり、3 社の CDN プロバイダー (Microsoft / Verizon / Akamai) で CDN サービスを提供しております。&lt;br&gt;本ブログは Azure CDN で提供している 4 つの SKU の特徴や、各 SKU における情報採取手順などをまとめたブログとなります。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="AzureCDN" scheme="https://jpaztech.github.io/blog/tags/AzureCDN/"/>
    
      <category term="Troubleshooting" scheme="https://jpaztech.github.io/blog/tags/Troubleshooting/"/>
    
  </entry>
  
  <entry>
    <title>Windows ゲスト エージェント (WinGA) の再インストール方法</title>
    <link href="https://jpaztech.github.io/blog/vm/re-install-windows-azure-guest-agent/"/>
    <id>https://jpaztech.github.io/blog/vm/re-install-windows-azure-guest-agent/</id>
    <published>2020-06-26T08:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.897Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。</p><p>お問い合わせでご案内する頻度が多い、Windows ゲスト エージェント (WinGA) の再インストール方法をご案内いたします。<br>WinGAが正常に動作しなくなった場合に再インストールを行うことで正常動作に戻ることが多くあります。</p><p>今回は下記画像の3つのサービスを一旦削除し、インストールを行うシナリオとなります。</p><p><img src="/blog/vm/re-install-windows-azure-guest-agent/service.png" alt=""> </p><h2 id="再インストール方法"><a href="#再インストール方法" class="headerlink" title="再インストール方法"></a>再インストール方法</h2><ol><li><p>現在のWinGAをアンインストールします。<br> スタートを右クリックして、「Apps and Features」を選択します。<br> 下記のように「Windows Azure VM Agent」がインストールされている場合は「Uninstall」を選択してください。</p><p> <img src="/blog/vm/re-install-windows-azure-guest-agent/app-and-features.png" alt=""> </p><p> WinGAが最初からインストールされているイメージを使用した際は、「Windows Azure VM Agent」の表示はありませんのでこの操作は不要です。</p></li><li><p>管理者権限でコマンドプロンプトを起動します。</p></li><li><p>下記のコマンドでサービスを停止します。既に停止している場合は不要です。</p> <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> stop rdagent</span><br><span class="line"><span class="built_in">net</span> stop WindowsAzureGuestAgent</span><br><span class="line"><span class="built_in">net</span> stop WindowsAzureTelemetryService</span><br></pre></td></tr></table></figure></li><li><p>下記コマンドでサービスの削除を行います。</p> <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sc delete rdagent</span><br><span class="line">sc delete WindowsAzureGuestAgent</span><br><span class="line">sc delete WindowsAzureTelemetryService</span><br></pre></td></tr></table></figure></li><li><p>インストール前に不要ファイルの移動を行います。<br> “C:\WindowsAzure” 内に “OLD” というフォルダを作成します。<br> “C:\WindowsAzure” 内に “Packages” または “GuestAgent” というフォルダがあった場合は、作成した “OLD” フォルダに移動させてください。</p></li><li><p>下記リンクより最新のインストーラーをダウンロードします。<br> <a href="https://go.microsoft.com/fwlink/?LinkID=394789" target="_blank" rel="noopener">https://go.microsoft.com/fwlink/?LinkID=394789</a></p></li><li><p>ダウンロードしたインストーラーを “C:\VMAgentMSI” に配置します。</p></li><li><p>下記コマンドでインストールを実行します。<br> &lt;Version&gt;はインストーラーのファイル名のバージョンに合わせて書き換えて実行してください。  </p> <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msiexec.exe /i c:\VMAgentMSI\WindowsAzureVmAgent.<span class="number">2</span>.<span class="number">7</span>.&lt;version&gt;.fre.msi /quiet /L*v c:\VMAgentMSI\msiexec.log</span><br></pre></td></tr></table></figure></li><li><p>これにてWinGAの再インストールは完了となります。<br> なお、サービスが起動するまでに1,2分程度かかる場合があります。<br> インストールが失敗した場合は “C:\VMAgentMSI\msiexec.log” の内容を参照してください。</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;/p&gt;
&lt;p&gt;お問い合わせでご案内する頻度が多い、Windows ゲスト エージェント (WinGA) の再インストール方法をご案内いたします。&lt;br&gt;WinGAが正常に動作しなくなった場合に再インストールを
      
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
      <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>データ ディスクのドライブ文字が変わる</title>
    <link href="https://jpaztech.github.io/blog/vm/drive-letter-changed-1/"/>
    <id>https://jpaztech.github.io/blog/vm/drive-letter-changed-1/</id>
    <published>2020-06-25T08:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.881Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの重田です。</p><p>オンプレミス環境の Hyper-V Guest を Azure 環境に移行した際や、Azure Windows VM を一般化 (sysprep) したイメージから複製 VM を作成したところ、割り当てられていたドライブ文字が以前の状態と変わったしまった、というお問い合わせをいただくことがありましたので、検証結果を交えてご説明させていただきます。</p><a id="more"></a><p>なお、移行手順に関しては下記ドキュメントに詳説されておりますので、こちらをご参照ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image" target="_blank" rel="noopener">Azure にアップロードする Windows VHD または VHDX を準備する</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/upload-generalized-managed" target="_blank" rel="noopener">汎用化した VHD をアップロードして Azure で新しい VM を作成する</a></li></ul><hr><span id="how-it-works"></span><h2 id="■-ドライブ文字を割り当ての仕組み"><a href="#■-ドライブ文字を割り当ての仕組み" class="headerlink" title="■ ドライブ文字を割り当ての仕組み"></a><a href="#how-it-works">■ ドライブ文字を割り当ての仕組み</a></h2><p>※ ダイナミック ディスク構成による複数ディスクにまたがるボリュームにつきましては、レガシーな機能であり、Windows では非推奨となっておりますため、本稿ではベーシック ディスクについて説明しています。</p><p>はじめに、Windows によるドライブ文字の割り当ては、すべてレジストリキー <strong>HKLM¥SYSTEM¥MountedDevices</strong> に格納されます。<br>このレジストリ キーには、¥??¥Volume{GUID} という名前の値 (ボリューム名のエントリ) と、¥DosDevices¥C: のような名前の値があり、格納されるデータは、ディスク シグネチャとそのボリュームに関連する最初のパーティションの開始オフセットです。<br>どのディスクのどこから始まるパーティションのドライブ、という情報に対して、ドライブ文字が紐づけられているイメージになります。</p><p><img src="/blog/vm/drive-letter-changed-1/registry.png" alt=""></p><p>ドライブ文字の割り当てはマウント マネージャー (mountmgr.sys) が行っています。<br>マウント マネージャーが新しいボリュームに関する通知を受け取ると、新しいボリュームの GUID やディスク シグネチャを特定し、その情報をもとに MountedDevices レジストリ キーの内容が反映されている内部データベースを調べて、ドライブ文字の割り当てが含まれているかどうかを確認します。<br>このデータベースに新しいボリュームのエントリがない場合、マウント マネージャーは最初の未割り当てドライブ文字を採用して新規割り当てを定義し、それをデータベースに格納します。利用できるドライブ文字がない場合、ドライブ文字の割り当ては行われません。</p><hr><span id="verify"></span><h2 id="■-いつドライブ文字が変わるのか"><a href="#■-いつドライブ文字が変わるのか" class="headerlink" title="■ いつドライブ文字が変わるのか"></a><a href="#verify">■ いつドライブ文字が変わるのか</a></h2><p><span id="verify1"></span></p><h3 id="□-検証-1-Azure-Windows-VM-を-sysprep-し、複製-VM-を作成した場合"><a href="#□-検証-1-Azure-Windows-VM-を-sysprep-し、複製-VM-を作成した場合" class="headerlink" title="□ 検証 1: Azure Windows VM を sysprep し、複製 VM を作成した場合"></a><a href="#verify1">□ 検証 1: Azure Windows VM を sysprep し、複製 VM を作成した場合</a></h3><p><strong>&lt;検証概要&gt;</strong></p><p>本検証は、ドライブ文字の情報が sysprep の影響を受けることを確認した検証となります。<br>上述の通り、ドライブ文字の情報は <strong>HKLM¥SYSTEM¥MountedDevices</strong> に格納されていますので、sysprep 前後のレジストリの値を確認します。</p><p>具体的な手順は下記の通りです。</p><ol><li>[Azure Portal] Azure Windows VM にデータ ディスク 3 本をアタッチする</li><li>[ゲスト OS] VM に RDP 接続し、データ ディスクそれぞれに H、I、J ドライブを作成する</li><li>[ゲスト OS] 作成した VM に RDP 接続し、レジストリ値を確認する</li><li>[ゲスト OS] sysprep を実行して一般化を行う</li><li>[Azure Portal] 当該 VM の画面にて “キャプチャ” をクリックし、イメージ リソースを作成する</li><li>[Azure Portal] 作成したイメージ リソースから VM を作成する</li><li>[ゲスト OS] 作成した VM に RDP 接続し、レジストリ値を確認する</li></ol><p>手順につきましては、下記ドキュメントに詳説されておりますので、こちらをご参照ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/capture-image-resource" target="_blank" rel="noopener">Azure で一般化された VM の管理対象イメージを作成する</a></li></ul><p><strong>&lt;検証結果&gt;</strong><br>検証の結果、sysprep を実施すると今までのドライブ文字の情報は考慮されず、ディスクを読み込んだ順に新たにドライブ文字を割り当てることが確認できました。</p><p>レジストリに格納されている名前に対するデータ (ディスク シグネチャとパーティションの開始オフセット) より、sysprep 実施前後で同一のディスクがアタッチされていると OS には認識されておりますが、ドライブ文字との紐付け情報は残っていないことが確認できます。</p><p><strong>sysprep 実施前:</strong><br><img src="/blog/vm/drive-letter-changed-1/diskmanager-2.png" alt=""><br><img src="/blog/vm/drive-letter-changed-1/registry-2.png" alt=""></p><p><strong>sysprep 実施後再作成した VM にて:</strong><br>ドライブ先頭に付けた文字と実際に割り当てられた文字が違うことが確認いただけます。<br><img src="/blog/vm/drive-letter-changed-1/diskmanager-2aft.png" alt=""><br><img src="/blog/vm/drive-letter-changed-1/registry-2aft.png" alt=""></p><p><strong>&lt;まとめ&gt;</strong><br>そのため、Azure Windows VM のイメージから VM を作成する際には、必要に応じてドライブ文字の再設定をご実施ください。</p><p><span id="verify2"></span></p><h3 id="□-検証-2-オンプレミス環境の-Hyper-V-Guest-から-Azure-環境への移行した場合"><a href="#□-検証-2-オンプレミス環境の-Hyper-V-Guest-から-Azure-環境への移行した場合" class="headerlink" title="□ 検証 2: オンプレミス環境の Hyper-V Guest から Azure 環境への移行した場合"></a><a href="#verify2">□ 検証 2: オンプレミス環境の Hyper-V Guest から Azure 環境への移行した場合</a></h3><p><strong>&lt;検証概要&gt;</strong></p><p>本検証は、一般化を行なっていないオンプレミス環境の Hyper-V Guest　から Azure 環境への移行を実施した際に、ドライブ文字が変わるのかを確認します。</p><p>すべての Azure 仮想マシンでは、ページング ファイルやスワップ ファイルなどのデータのみを格納するための一時的なストレージ (一時ディスク) が割り当てされます。<br>Azure MarketPlace イメージをご利用の場合、一時ディスクは規定で D ドライブとなり、ページング ファイルはこの一時ディスクに設定されます。すでにデータ ディスクのドライブに D が使用されている場合には、一時ディスクのドライブ文字は D ドライブにはなりません。そのため、すでに D ドライブが設定されているオンプレミス環境を用意して確認を行います。</p><p>具体的な手順は下記の通りです。</p><ol><li>[Hyper-V Guest] システム ドライブ以外にディスクを 3 本アタッチし、D、E、F ドライブを作成する</li><li>[Hyper-V Guest] Azure に vhd ファイルをアプロードするための準備を行う (<a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image" target="_blank" rel="noopener">手順</a>)</li><li>[Hyper-V Host] vhd ファイルを Azure ストレージ アカウントにアップロードする</li><li>[Azure Portal] vhd ファイルから管理ディスクを作成する</li><li>[Azure Portal] 作成した管理ディスクから VM を作成する</li><li>[ゲスト OS] 作成した VM に RDP 接続し、レジストリ値を確認する</li></ol><p><strong>&lt;検証結果&gt;</strong><br>検証の結果、Azure 環境にオンプレミス環境の VHD ファイルをアップロードして作成した仮想マシンでは、D、E、F ドライブは変わらず、移行前後で同一のディスクがアタッチされていると OS には認識されております。<br>Azure の一時ディスクについては、C 以降で使用済みのアルファベットを除いてもっとも若いアルファベットである G が割り当てられていることを確認いたしました。</p><p><strong>移行前:</strong><br><img src="/blog/vm/drive-letter-changed-1/registry-1.png" alt=""><br><strong>移行後:</strong><br><img src="/blog/vm/drive-letter-changed-1/registry-1aft.png" alt=""></p><hr><span id="summary"></span><h2 id="■-まとめ"><a href="#■-まとめ" class="headerlink" title="■ まとめ"></a><a href="#summary">■ まとめ</a></h2><p>上記検証と Windows の動作より、ボリュームに割り当てられたドライブ文字が変更されてしまうには、下記の 2 つのパターンが存在すると言えます。</p><blockquote><ul><li>sysprep を行い VM を一般化して、レジストリに該当ボリュームの情報がない場合</li><li>ディスクの情報が異なり、レジストリに該当ボリュームの情報がない場合</li></ul></blockquote><p>そのため、イメージから VM を作成いただいた後には改めてドライブ文字の設定をご検討ください。<br>また、意図せずドライブ文字が変更された場合には、ディスク自体の情報が変更されているか、レジストリに情報がないことが想定されますので、<strong>どんな操作を行った時にドライブ文字が変更されたか</strong>、<strong>ディスクは同一ディスクとして認識されているか</strong> をご確認ください。</p><p>本稿が皆様のお役に立てれば幸いです。</p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;/p&gt;
&lt;p&gt;オンプレミス環境の Hyper-V Guest を Azure 環境に移行した際や、Azure Windows VM を一般化 (sysprep) したイメージから複製 VM を作成したところ、割り当てられていたドライブ文字が以前の状態と変わったしまった、というお問い合わせをいただくことがありましたので、検証結果を交えてご説明させていただきます。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
      <category term="Drive Letter" scheme="https://jpaztech.github.io/blog/tags/Drive-Letter/"/>
    
  </entry>
  
  <entry>
    <title>Azure Linux VM の OS ディスク拡張方法</title>
    <link href="https://jpaztech.github.io/blog/vm/linux-expand-os-disk/"/>
    <id>https://jpaztech.github.io/blog/vm/linux-expand-os-disk/</id>
    <published>2020-06-19T08:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.897Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの青山です。</p><p>Azure Marketplace のイメージからデプロイしたほとんどの Linux VM は、OS ディスクサイズが 30GB となります。VM の用途次第では、このサイズでは <code>/</code> 領域が不足することがあります。<br>そこで今回は OS ディスクの拡張方法、および、パーティション、ファイルシステムの拡張方法についてご案内します。</p><p>なお、データディスクの拡張については下記公式ドキュメントに詳細手順がありますので、こちらを参考にしてください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/expand-disks" target="_blank" rel="noopener">Azure CLI を使用して Linux VM の仮想ハード ディスクを拡張する</a></li></ul><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>作業前には必ず <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/tutorial-backup-vms" target="_blank" rel="noopener">バックアップ</a> を取得しておきましょう。</p><h2 id="Azure-ディスクの拡張"><a href="#Azure-ディスクの拡張" class="headerlink" title="Azure ディスクの拡張"></a>Azure ディスクの拡張</h2><p><a href="https://docs.microsoft.com/ja-jp/cli/azure/install-azure-cli?view=azure-cli-latest" target="_blank" rel="noopener">Azure CLI</a> で <code>az login</code> が完了していることを前提とします。<br>CLI をインストールしていない場合は、<a href="https://docs.microsoft.com/ja-jp/azure/cloud-shell/quickstart" target="_blank" rel="noopener">Azure Cloud Shell の Bash</a> を使うと便利です。</p><ol><li>環境に合わせて変数を設定します。<code>myResourceGroup</code> には VM のリソースグループ名、<code>myVmName</code> には VM のリソース名、<code>myOsDiskSize</code> には拡張後の OS ディスクサイズを指定しましょう。以下の例では 100GB に拡張します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myResourceGroup=<span class="string">"contosogroup"</span></span><br><span class="line">myVmName=<span class="string">"contosovm"</span></span><br><span class="line">myOsDiskSize=<span class="string">"100"</span></span><br></pre></td></tr></table></figure></li><li>VM 実行中は接続されたディスクのサイズを変更できません。一度 VM を停止(割り当て解除)します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm deallocate --resource-group <span class="variable">$myResourceGroup</span> --name <span class="variable">$myVmName</span></span><br></pre></td></tr></table></figure></li><li>ディスクサイズを変更します。管理ディスクの場合は、<code>az disk update</code> でサイズ変更します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">osdiskid=$(az vm show --resource-group <span class="variable">$myResourceGroup</span> --name <span class="variable">$myVmName</span> --query storageProfile.osDisk.managedDisk.id -o tsv)</span><br><span class="line">az disk update --ids <span class="variable">$osdiskid</span> --size-gb <span class="variable">$myOsDiskSize</span></span><br></pre></td></tr></table></figure>非管理ディスクの場合は、<code>az vm update</code> でサイズ変更します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm update -n <span class="variable">$myVmName</span> -g <span class="variable">$myResourceGroup</span> --<span class="built_in">set</span> StorageProfile.OSDisk.DiskSizeGB=<span class="variable">$myOsDiskSize</span></span><br></pre></td></tr></table></figure></li><li>VM を起動します。Azure CLI での操作はここまでとなります。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm start --resource-group <span class="variable">$myResourceGroup</span> --name <span class="variable">$myVmName</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="ファイルシステムの拡張"><a href="#ファイルシステムの拡張" class="headerlink" title="ファイルシステムの拡張"></a>ファイルシステムの拡張</h2><p>Ubuntu など、cloud-init が予め有効なシステムでは、起動時に拡張が済んでいる場合があります。<br>ここでは、LVM 構成ではない RHEL7.6 でのコマンド例を紹介します。LVM 構成の場合は <a href="#ファイルシステムの拡張-LVM">ファイルシステムの拡張 (LVM)</a> を参照してください。</p><ol><li>VM に SSH 接続します。</li><li><code>lsblk</code> コマンドで拡張するパーティションを確認します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsblk -p -o NAME,FSTYPE,SIZE,MOUNTPOINT</span><br></pre></td></tr></table></figure>以下の出力例では、<code>/</code> は <code>/dev/sda2</code> に 31.5G の xfs として作成されていることが確認できます。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAME        FSTYPE  SIZE MOUNTPOINT</span><br><span class="line">&#x2F;dev&#x2F;fd0              4K</span><br><span class="line">&#x2F;dev&#x2F;sda            100G</span><br><span class="line">|-&#x2F;dev&#x2F;sda1 xfs     500M &#x2F;boot</span><br><span class="line">&#96;-&#x2F;dev&#x2F;sda2 xfs    31.5G &#x2F;</span><br><span class="line">&#x2F;dev&#x2F;sdb              7G</span><br><span class="line">&#96;-&#x2F;dev&#x2F;sdb1 ext4      7G &#x2F;mnt&#x2F;resource</span><br></pre></td></tr></table></figure></li><li><code>yum</code> コマンドで、<code>cloud-utils-growpart</code> パッケージをインストールします。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y cloud-utils-growpart</span><br></pre></td></tr></table></figure></li><li><code>growpart</code> コマンドでパーティションを拡張します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo growpart /dev/sda 2</span><br></pre></td></tr></table></figure></li><li>再度 <code>lsblk</code> コマンドを使い、<code>/dev/sda2</code> が拡張されたかを確認してみましょう。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsblk -p /dev/sda2</span><br></pre></td></tr></table></figure>以下の出力例では、99.5G に拡張されたことが確認できます。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">&#x2F;dev&#x2F;sda2   8:2    0 99.5G  0 part &#x2F;</span><br></pre></td></tr></table></figure></li><li>ファイルシステムを拡張します。xfs の場合は、<code>xfs_growfs</code>, ext4 の場合は、<code>resize2fs</code> コマンドを使います。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo xfs_growfs /</span><br></pre></td></tr></table></figure>拡張されました。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meta-data&#x3D;&#x2F;dev&#x2F;sda2              isize&#x3D;512    agcount&#x3D;4, agsize&#x3D;2065088 blks</span><br><span class="line">         &#x3D;                       sectsz&#x3D;512   attr&#x3D;2, projid32bit&#x3D;1</span><br><span class="line">         &#x3D;                       crc&#x3D;1        finobt&#x3D;0 spinodes&#x3D;0</span><br><span class="line">data     &#x3D;                       bsize&#x3D;4096   blocks&#x3D;8260352, imaxpct&#x3D;25</span><br><span class="line">         &#x3D;                       sunit&#x3D;0      swidth&#x3D;0 blks</span><br><span class="line">naming   &#x3D;version 2              bsize&#x3D;4096   ascii-ci&#x3D;0 ftype&#x3D;1</span><br><span class="line">log      &#x3D;internal               bsize&#x3D;4096   blocks&#x3D;4033, version&#x3D;2</span><br><span class="line">         &#x3D;                       sectsz&#x3D;512   sunit&#x3D;0 blks, lazy-count&#x3D;1</span><br><span class="line">realtime &#x3D;none                   extsz&#x3D;4096   blocks&#x3D;0, rtextents&#x3D;0</span><br><span class="line">data blocks changed from 8260352 to 26086139</span><br></pre></td></tr></table></figure></li><li>最後に、<code>df</code> コマンドで <code>/</code> のサイズを確認してみましょう。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df -hT /</span><br></pre></td></tr></table></figure>目的のサイズになっていれば無事成功です。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Filesystem     Type  Size  Used Avail Use% Mounted on</span><br><span class="line">&#x2F;dev&#x2F;sda2      xfs   100G  2.8G   97G   3% &#x2F;</span><br></pre></td></tr></table></figure></li></ol><h2 id="ファイルシステムの拡張-LVM"><a href="#ファイルシステムの拡張-LVM" class="headerlink" title="ファイルシステムの拡張 (LVM)"></a>ファイルシステムの拡張 (LVM)</h2><p>ここでは、LVM 構成の RHEL8.2 でのコマンド例を紹介します。</p><ol><li>VM に SSH 接続します。</li><li><code>lsblk</code> コマンドで拡張するパーティションを確認します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsblk -p -o NAME,FSTYPE,SIZE,MOUNTPOINT</span><br></pre></td></tr></table></figure>以下の出力例では、<code>/</code> としてマウントされている LV <code>rootlv</code> は <code>/dev/sda2</code> に作成されていることが確認できます。<br>ファイルシステムは xfs として作成されています。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAME                          FSTYPE       SIZE MOUNTPOINT</span><br><span class="line">&#x2F;dev&#x2F;sda                                   100G</span><br><span class="line">├─&#x2F;dev&#x2F;sda1                   xfs          500M &#x2F;boot</span><br><span class="line">├─&#x2F;dev&#x2F;sda2                   LVM2_member   63G</span><br><span class="line">│ ├─&#x2F;dev&#x2F;mapper&#x2F;rootvg-tmplv  xfs            2G &#x2F;tmp</span><br><span class="line">│ ├─&#x2F;dev&#x2F;mapper&#x2F;rootvg-usrlv  xfs           10G &#x2F;usr</span><br><span class="line">│ ├─&#x2F;dev&#x2F;mapper&#x2F;rootvg-homelv xfs            1G &#x2F;home</span><br><span class="line">│ ├─&#x2F;dev&#x2F;mapper&#x2F;rootvg-varlv  xfs            8G &#x2F;var</span><br><span class="line">│ └─&#x2F;dev&#x2F;mapper&#x2F;rootvg-rootlv xfs            2G &#x2F;</span><br><span class="line">├─&#x2F;dev&#x2F;sda14                                 4M</span><br><span class="line">└─&#x2F;dev&#x2F;sda15                  vfat         495M &#x2F;boot&#x2F;efi</span><br><span class="line">&#x2F;dev&#x2F;sdb                                     7G</span><br><span class="line">└─&#x2F;dev&#x2F;sdb1                   ext4           7G &#x2F;mnt</span><br></pre></td></tr></table></figure></li><li><code>yum</code> コマンドで、<code>cloud-utils-growpart</code> パッケージをインストールします。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y cloud-utils-growpart</span><br></pre></td></tr></table></figure></li><li><code>growpart</code> コマンドでパーティションを拡張します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo growpart /dev/sda 2</span><br></pre></td></tr></table></figure></li><li><code>pvresize</code> コマンドで、PV を拡張します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pvresize /dev/sda2</span><br></pre></td></tr></table></figure>成功すると、以下のような出力が得られます。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Physical volume &quot;&#x2F;dev&#x2F;sda2&quot; changed</span><br><span class="line">1 physical volume(s) resized or updated &#x2F; 0 physical volume(s) not resized</span><br></pre></td></tr></table></figure></li><li><code>vgs</code> コマンドで <code>rootlv</code> の含まれている <code>rootvg</code> の領域が増えたか確認してみます。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vgs</span><br></pre></td></tr></table></figure>以下の出力例では 76.02 GB が使用可能です。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VG     #PV #LV #SN Attr   VSize   VFree</span><br><span class="line">rootvg   1   5   0 wz--n- &lt;99.02g &lt;76.02g</span><br></pre></td></tr></table></figure></li><li><code>lvextend</code> コマンドで、LV を拡張します。<br>今回は、空き容量を全て使って <code>rootlv</code> を拡張します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo lvextend -l +100%FREE /dev/rootvg/rootlv</span><br></pre></td></tr></table></figure>成功すると、以下のような出力が得られます。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Size of logical volume rootvg&#x2F;rootlv changed from 2.00 GiB (512 extents) to &lt;78.02 GiB (19973 extents).</span><br><span class="line">Logical volume rootvg&#x2F;rootlv successfully resized.</span><br></pre></td></tr></table></figure></li><li>ファイルシステムを拡張します。xfs の場合は、xfs_growfs, ext4 の場合は、resize2fs コマンドを使います。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo xfs_growfs /</span><br></pre></td></tr></table></figure>成功すると、以下のような出力が得られます。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">meta-data&#x3D;&#x2F;dev&#x2F;mapper&#x2F;rootvg-rootlv isize&#x3D;512    agcount&#x3D;4, agsize&#x3D;131072 blks</span><br><span class="line">         &#x3D;                       sectsz&#x3D;4096  attr&#x3D;2, projid32bit&#x3D;1</span><br><span class="line">         &#x3D;                       crc&#x3D;1        finobt&#x3D;1, sparse&#x3D;1, rmapbt&#x3D;0</span><br><span class="line">         &#x3D;                       reflink&#x3D;1</span><br><span class="line">data     &#x3D;                       bsize&#x3D;4096   blocks&#x3D;524288, imaxpct&#x3D;25</span><br><span class="line">         &#x3D;                       sunit&#x3D;0      swidth&#x3D;0 blks</span><br><span class="line">naming   &#x3D;version 2              bsize&#x3D;4096   ascii-ci&#x3D;0, ftype&#x3D;1</span><br><span class="line">log      &#x3D;internal log           bsize&#x3D;4096   blocks&#x3D;2560, version&#x3D;2</span><br><span class="line">         &#x3D;                       sectsz&#x3D;4096  sunit&#x3D;1 blks, lazy-count&#x3D;1</span><br><span class="line">realtime &#x3D;none                   extsz&#x3D;4096   blocks&#x3D;0, rtextents&#x3D;0</span><br><span class="line">data blocks changed from 524288 to 20452352</span><br></pre></td></tr></table></figure></li><li>最後に、df コマンドで / のサイズを確認してみましょう。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df -hT /</span><br></pre></td></tr></table></figure>目的のサイズになっていれば無事成功です。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Filesystem                Type  Size  Used Avail Use% Mounted on</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;rootvg-rootlv xfs    79G  625M   78G   1% &#x2F;</span><br></pre></td></tr></table></figure></li></ol><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの青山です。&lt;/p&gt;
&lt;p&gt;Azure Marketplace のイメージからデプロイしたほとんどの Linux VM は、OS ディスクサイズが 30GB となります。VM の用途次第では、このサイズでは &lt;code&gt;/
      
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
      <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
      <category term="Disk" scheme="https://jpaztech.github.io/blog/tags/Disk/"/>
    
  </entry>
  
  <entry>
    <title>Azure Load Balancer のトラブルシューティング: スコーピング編</title>
    <link href="https://jpaztech.github.io/blog/network/tsg-azure-load-balancer-scoping/"/>
    <id>https://jpaztech.github.io/blog/network/tsg-azure-load-balancer-scoping/</id>
    <published>2020-06-17T01:00:00.000Z</published>
    <updated>2020-08-18T00:45:29.881Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Networking テクニカル サポートの山口です。</p><p>Azure Load Balancer (ALB) はワークロードを複数の Azure VM / VMSS に負荷分散するサービスで、最も利用されている Azure サービスの一つです。利用数が多い分、ALB を経由するエンドノード間の通信に問題が生じたといったトラブルもよくお問い合わせいただきます。そこで、そうしたトラブルにおいて、ALB の観点で原因箇所を切り分けるスコーピングの方法についてご紹介したいと思います。</p><a id="more"></a><h2 id="要約"><a href="#要約" class="headerlink" title="要約"></a>要約</h2><ul><li>トランスポート層 (L4) レベルで接続性が確保できていれば Auzre Load Balancer として問題はありません。</li><li>例えば TCP の負荷分散規則であれば <code>nc</code>、<code>telnet</code>、<code>PsPing</code>、<code>Test-NetConnection</code> 等で TCP コネクションが確立出来るかみれば十分です。</li><li>L4 の接続性が確認できない場合は、Azure Load Balancer の構成状況に問題があります。次の公式ドキュメントやブログ記事等を参考に原因箇所を特定してください。<ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-troubleshoot" target="_blank" rel="noopener">Azure Load Balancer のトラブルシューティング | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/loadbalancer-troubleshooting" target="_blank" rel="noopener">ロードバランサー経由での通信ができない場合のチェックポイント | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/azurelb-tips" target="_blank" rel="noopener">Azure ロードバランサー利用時の注意点 | Microsoft Docs</a></li></ul></li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p> Azure Load Balancer に関わるトラブルを解決する際には、<strong>Azure Load Balancer は L4 ロードバランサーである</strong>ということを意識しておく必要があります。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-overview" target="_blank" rel="noopener">Azure Load Balancer の概要 - Azure Load Balancer | Microsoft Docs</a></li></ul><blockquote><p>Azure Load Balancer は、開放型システム間相互接続 (OSI) モデルのレイヤー 4 で動作します。 </p></blockquote><p>立ち位置を明確にする為に他の負荷分散サービスと比べてみると、Azure の負荷分散サービスで関与できるネットワーク レイヤーは、それぞれ以下の通りです。</p><ul><li><strong>Trarffic Manager</strong>: DNS レベルの負荷分散装置。DNS による名前解決時に負荷分散に関与できる。</li><li><strong>Azure Load Balancer</strong>: トランスポート層 (L4) の負荷分散装置。UDP または TCP のフローを、適当なバックエンド サーバーに分散するのが仕事。</li><li><strong>Application Gateway</strong>: アプリケーション層 (L7) の負荷分散装置。HTTP/S のセッションを、適当なバックエンド サーバーに分散するのが仕事。</li></ul><p>なお、負荷分散サービスの比較は、以下のドキュメントでより詳しく説明されています。これらのサービスの比較にご興味があれば、併せてご確認ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/traffic-manager/traffic-manager-load-balancing-azure" target="_blank" rel="noopener">Azure で負荷分散サービスを使用する | Microsoft Docs</a></li></ul><p>「503 エラーが表示されるが、Azure Load Balancer に問題はないか調査してほしい」といったお問い合わせをいただくことがありますが、<span style="color: #d00000">Azure Load Balancer はあくまで L4 の接続性を担保するのが責務であり、その上のレイヤーである HTTP の応答に関与することはありません</span>。</p><p>Azure Load Balancer は TCP ペイロードに関与しないため、例えば HTTP の 50* 系ステータス コードのレスポンスを返すことも、<code>X-forwarded-for</code> ヘッダを書き換えることもありません。HTTP (アプリケーション層) で何か不具合が出ている場合は、バックエンド サーバーより後段のエンティティを対象に原因調査するのが良いでしょう。</p><h2 id="スコーピング-問題の切り分け"><a href="#スコーピング-問題の切り分け" class="headerlink" title="スコーピング: 問題の切り分け"></a>スコーピング: 問題の切り分け</h2><p>この記事の最大の目的です。Azure Load Balancer を経由するシステムに問題がある場合の <strong>切り分け (スコーピング) 方法</strong>について紹介していきたいと思います。具体的には「Azure Load Balancer に関連する箇所で問題があるか」を切り分けます。</p><p>答えを言ってしまうと、Azure Load Balancer に問題があるか切り分けるには <strong>L4 の接続性 (connectivity)</strong> を確認するだけで十分です。</p><p>切り分けのフローチャートを作成したので、まずは下図を基に全体像を把握していただければ幸いです。</p><p><img src="/blog/network/tsg-azure-load-balancer-scoping/scoping-flowchart.png" alt="tsg-flowchart"></p><h3 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h3><p>切り分けに必要な情報は以下の通りです。</p><ul><li><code>&lt;vip&gt;</code>: フロントエンドで待ち受ける仮想 IP アドレス</li><li><code>&lt;protocol&gt;</code>: VIP で待ち受ける L4 プロトコル (TCP/UDP)</li><li><code>&lt;port&gt;</code>: VIP で待ち受けるポート番号</li><li><code>&lt;backend-port&gt;</code>: 負荷分散された後、バックエンド サーバーが受け取る (NAPT 後の) ポート番号</li></ul><p>加えて、テストパケットを送信するクライアントも用意する必要がありますが、クライアントと Azure Load Balancer の間には余計なネットワーク装置 (e.g. Firewall) を置かないことが鉄則です。どうしてもそのようなクライアントが準備出来ない場合は、被疑箇所は Azure Load Balancer だけではなく、中間のネットワーク装置まで含めた検証となることを必ず意識してください。</p><p>なお、クライアントには対象の Azure Load Balancer のバックエンド サーバーではないものを選択してください。というのも、内部ロードバランサーは自分自身に負荷分散されたパケットはドロップされる動作となっている為です。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-troubleshoot#cause-4-accessing-the-internal-load-balancer-frontend-from-the-participating-load-balancer-backend-pool-vm" target="_blank" rel="noopener">Azure Load Balancer のトラブルシューティング | Microsoft Docs</a></li></ul><blockquote><p>副作用として、バックエンド プール内の VM からの送信フローが、そのプール内の内部ロード バランサーのフロントエンドへのフローを試み、”かつ”、それ自体にマップバックされている場合、フローの 2 つのレッグは一致しません。 これらは一致しないため、フローは失敗します。 フローが、フロントエンドへのフローを作成したバックエンド プール内の同じ VM にマップバックしなかった場合、フローは成功します。</p></blockquote><h3 id="TCP-の負荷分散規則"><a href="#TCP-の負荷分散規則" class="headerlink" title="TCP の負荷分散規則"></a>TCP の負荷分散規則</h3><p>負荷分散プロトコルが TCP の場合、3-way handshaking が確認できれば疎通できていると見なせるので、切り分けはクライアントで完結します。</p><p>例えば次のコマンドを実行して、TCP コネクションが確立できるか確認します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[client]# telnet &lt;vip&gt; &lt;port&gt;</span><br><span class="line">[client]# curl -v telnet:&#x2F;&#x2F;&lt;vip&gt;:&lt;port&gt;</span><br><span class="line">[client]# nc -v &lt;vip&gt; &lt;port&gt;</span><br><span class="line"></span><br><span class="line"># Windows (powershell)</span><br><span class="line">PS C:\client&gt; Test-NetConnection &lt;vip&gt; -Port &lt;port&gt;</span><br><span class="line">PS C:\client&gt; PsPing -t &lt;vip&gt; &lt;port&gt;</span><br></pre></td></tr></table></figure><ul><li><a href="https://Linux.die.net/man/1/telnet" target="_blank" rel="noopener">telnet(1): user interface to TELNET protocol - Linux man page</a></li><li><a href="https://Linux.die.net/man/1/nc" target="_blank" rel="noopener">nc(1): arbitrary TCP/UDP connections/listens - Linux man page</a></li><li><a href="https://docs.microsoft.com/en-us/powershell/module/nettcpip/test-netconnection?view=win10-ps" target="_blank" rel="noopener">Test-NetConnection | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psping" target="_blank" rel="noopener">PsPing - Windows Sysinternals | Microsoft Docs</a></li></ul><p>Linux と Windows のいずれの場合でも、TCP コネクションが connected になれば L4 の疎通性に問題はありません。</p><h3 id="UDP-の負荷分散規則"><a href="#UDP-の負荷分散規則" class="headerlink" title="UDP の負荷分散規則"></a>UDP の負荷分散規則</h3><p>一方で、UDP の場合は、クライアントからの通信に必ずしも応答 (ACK) が返されるとは限らないため、サーバー側で着信を確認する必要があります。</p><p>クライアント側では例えば以下のようなコマンドで、テスト パケットを送信出来ます。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Linux</span><br><span class="line">[client]# echo -n &quot;test message&quot; | nc -u &lt;vip&gt; &lt;port&gt;</span><br><span class="line"></span><br><span class="line"># Windows (powershell)</span><br><span class="line">PS C:\client&gt;</span><br><span class="line">function Test-Udp($vip, $port) &#123;</span><br><span class="line">    $client &#x3D; New-Object System.Net.Sockets.UdpClient</span><br><span class="line">    $client.Connect($vip, $port)</span><br><span class="line">    $encoding &#x3D; New-Object System.Text.ASCIIEncoding</span><br><span class="line">    $bytes &#x3D; $encoding.GetBytes(&quot;test message&quot;)</span><br><span class="line">    $client.Send($bytes, $bytes.Length)</span><br><span class="line">    $client.Close()</span><br><span class="line">&#125;</span><br><span class="line">Test-Udp &lt;vip&gt; &lt;port&gt;</span><br></pre></td></tr></table></figure><p>サーバー側でテスト パケットが着信していることを確認するには、アクセスログを確認する、モックサーバーを利用する、パケットをキャプチャする、といった選択肢が選べます。ここでは、最も汎用性の高いパケット キャプチャによる確認方法を簡単に紹介します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Linux</span><br><span class="line">[server]# sudo tcpdump -i any -nN udp and port &lt;backend-port&gt;</span><br><span class="line"></span><br><span class="line"># Windows (powershell with administrator mode)</span><br><span class="line">PS C:\server&gt; netsh trace start report&#x3D;no capture&#x3D;yes tracefile&#x3D;%USERPROFILE%\Desktop\trace.etl</span><br><span class="line">PS C:\server&gt; netsh trace stop</span><br></pre></td></tr></table></figure><p><code>tcpdump</code> の場合は、標準出力に対象のパケットが表示できれば L4 疎通性は問題ありません。また、<code>netsh</code> の場合は、採取したトレース ファイル (デスクトップに生成される <code>trace.etl</code>) に対象のパケットが含まれていたら L4 疎通性に問題ありません。</p><h2 id="ネクスト-アクション"><a href="#ネクスト-アクション" class="headerlink" title="ネクスト アクション"></a>ネクスト アクション</h2><p>上記の切り分けで L4 の疎通性が得られない場合、Azure Load Balancer の構成状況に問題があります。次に紹介するブログ記事や公式ドキュメントを参考に、原因箇所の特定をご実施ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-troubleshoot" target="_blank" rel="noopener">Azure Load Balancer のトラブルシューティング | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/loadbalancer-troubleshooting" target="_blank" rel="noopener">ロードバランサー経由での通信ができない場合のチェックポイント | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/azurelb-tips" target="_blank" rel="noopener">Azure ロードバランサー利用時の注意点 | Microsoft Docs</a></li></ul><p>一方で、Azure Load Balancer に問題がなければ、多くの状況でサーバーで動作しているアプリケーションがエラー原因です。正確に言えば、OS のネットワーク スタック以上のレイヤーで、構成が間違っているか予期しない問題が起きている可能性があります。</p><p>本切り分けの検証結果や、現在の状況、目標とする状態などを OS やミドルウェア/アプリケーションのベンダー様とご共有いただき、さらに原因調査を進めてください。</p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Azure Networking テクニカル サポートの山口です。&lt;/p&gt;
&lt;p&gt;Azure Load Balancer (ALB) はワークロードを複数の Azure VM / VMSS に負荷分散するサービスで、最も利用されている Azure サービスの一つです。利用数が多い分、ALB を経由するエンドノード間の通信に問題が生じたといったトラブルもよくお問い合わせいただきます。そこで、そうしたトラブルにおいて、ALB の観点で原因箇所を切り分けるスコーピングの方法についてご紹介したいと思います。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="Azure Load Balancer" scheme="https://jpaztech.github.io/blog/tags/Azure-Load-Balancer/"/>
    
      <category term="TSG" scheme="https://jpaztech.github.io/blog/tags/TSG/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM の外部接続 (SNAT) オプション まとめ</title>
    <link href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/"/>
    <id>https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/</id>
    <published>2020-06-16T04:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.877Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Networking テクニカル サポートの山口です。</p><p>Azure VM がインターネットに接続する際には、パブリック IP アドレスでの送信元 NAT (SNAT) が必要です。Azure は、外部接続の SNAT に関して多くのオプションを提供していますが、オプションが多くて便利な反面、全オプションの列挙やオプション間の比較が難しいのも事実です。そうした難しさを少しでも緩和できるよう、本稿では外部接続の SNAT オプションを様々な角度から網羅的に紹介いたします。</p><a id="more"></a><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p><strong>仮定する知識</strong></p><p>この記事では、一般的なネットワーク用語としてのネットワーク アドレス変換 (NAT) や NAPT について、ある程度知識があることを前提としています。これらの言葉に馴染みがなければ、以下の公式ドキュメントを参考に、まずは NAT についての技術背景を確認してみてください。インターネットを活用すれば、さらに多くの技術解説を見つけることが出来るはずです。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#understanding-snat-and-pat" target="_blank" rel="noopener">Azure の Outbound connections &gt; SNAT と PAT の理解 | Microsoft Docs</a></li></ul><p><strong>外部接続と SNAT</strong></p><p>Azure 仮想マシン (VM) がインターネット等のグローバル IP アドレス帯のサーバーと通信することを、<strong>外部接続 (outbound connection)</strong> と呼びます。外部接続では、仮想ネットワークで設定したプライベート IP アドレスから、グローバル IP アドレスに送信元 NAT (SNAT) する必要があります。この記事で取り扱うのは、外部接続の為に Azure が提供している SNAT のオプションについてです。</p><p>結論から書くと、2020 年 6 月現在、Azure で利用できる SNAT のオプションは以下の 5 つ存在します。</p><ul><li>ユーザー定義ルートと仮想アプライアンス (e.g. Azure Firewall) による SNAT</li><li>NAT Gateway</li><li>パブリック Azure Load Balancer (外部ロードバランサー)</li><li>パブリック IP アドレス</li><li>Azure 既定の SNAT</li></ul><p>「ユーザー定義ルート (UDR) と仮想アプライアンス (NVA) による SNAT」に関しては、SNAT 可否やその動作仕様が NVA 製品に依存しますので、今回は残る 4 つの「Azure プラットフォームそのものが提供する SNAT」についてお話します (UDR+NVA で SNAT する場合も、結局 NVA 上では残りのいずれかの方法で SNAT する必要があります)。</p><h2 id="判定フローチャート"><a href="#判定フローチャート" class="headerlink" title="判定フローチャート"></a>判定フローチャート</h2><p>個々の詳細を見る前に、SNAT オプション同士の依存関係を把握し、全体感を捉えておきましょう。</p><p>というのも、環境によっては複数の SNAT オプションが構成されている可能性がある為です。例えば、NAT Gateway を関連付けたサブネットの中に、パブリック IP アドレスを付与した VM をデプロイするとどうなるでしょうか?</p><p>そのような状況で役に立つフローチャートを作図しました。以下のフローに従えば、<strong>ある Azure VM のある NIC</strong> がどのように SNAT されるか判定できます。VM ではなく、<span style="color: #c00000">NIC に関する SNAT 方法判定</span>である点に注意してください。</p><p><img src="/blog/network/snat-options-for-azure-vm/flowchart-to-determine-snat-scenario.png" alt="flowchar"></p><p>なお、フローチャートに脚注で記載されているシナリオ {1, 2, 3} は、以下の公式ドキュメントのシナリオ番号に対応しています。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-overview" target="_blank" rel="noopener">Azure の Outbound connections - Azure Load Balancer | Microsoft Docs</a></li></ul><p><strong>フローチャートの使い方</strong></p><p>先程挙げた NAT Gateway とパブリック IP アドレスの共存環境の例を使って、フローチャートの使い方を説明します。</p><ol><li>左上の丸からスタートします。</li><li>まずはじめに、UDR で宛先が NVA に向いているか確認します。この情報は、NIC の [有効なルート] から確認することが出来ます。この例では NVA もルート テーブルもデプロイしておらず、判定は “NO” だったとして次の条件文に進みます。</li><li>サブネットに NAT Gateway が関連付けられているか確認します。この情報は、仮想ネットワークの [サブネット] から確認することが出来ます。この例では NAT Gateway が関連付けられています! 条件文の答えは “YES” なので、フローチャートはここで終了します。</li></ol><p>最終的に、パブリック IP アドレスではなく NAT Gateway が優先されて SNAT される動作であることが、このフローチャートから判定出来ました。</p><p><strong>Standard SKU の外部接続構成か?</strong></p><p>最後の「Standard SKU の外部接続構成か?」と記載された条件ボックスは、次のいずれか一つを満たす場合に “YES” と判定されます。</p><ul><li>VM には可用性セットが構成されていて、一つ以上の可用性セット内 VM が「Standard SKU の外部接続リソース」に関連付けられている。</li><li>VM は仮想マシン スケール セット (VMSS) であり、一つ以上の VMSS 内 VM が「Standard SKU の外部接続リソース」に関連付けられている。</li><li>複数の NIC が VM に関連付けられていて、一つ以上の NIC が「Standard SKU の外部接続リソース」に関連付けられている。</li></ul><p>ここで、Standard SKU の外部接続リソースとは、以下の Azure リソースを表します。</p><ul><li>Standard SKU のパブリック IP アドレス</li><li>Standard SKU の Azure Load Balancer</li></ul><p>上記の通り、NAT Gateway は “Standard SKU の外部接続リソース” に該当しないため、可用性セットの一部 VM にだけ外部接続を構成したい場合や、複数 NIC を持つ VM の一部 NIC に外部接続を構成したい場合に使えます。</p><p>このあたりの条件式を把握するのは難しく、個人的にも理解するのに最も時間がかかった部分ですが、 <strong>Standard SKU ではリソースの保護が強化されていて、明示的に通信設定をするまでは許可されない</strong> と理解すれば多少は飲み込みやすいと思います。同じ内容は、以下の公式ドキュメントにも記載されています。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections" target="_blank" rel="noopener">Azure の Outbound connections - Azure Load Balancer | Microsoft Docs</a></li></ul><blockquote><p>重要<br>…<br>アウトバウンド接続のコンテキストでは、単一スタンドアロン VM、可用性セット内のすべての VM、VMSS のすべてのインスタンスがグループとして動作します。 つまり、可用性セット内の単一 VM が Standard SKU に関連付けられている場合、この可用性セット内のすべての VM インスタンスが、Standard SKU に関連付けられている場合と同じ規則に従って動作するようになります。個々のインスタンスが直接関連付けられていない場合でも同様です。 この動作は、ロード バランサーに複数のネットワーク インターフェイスカードが接続されているスタンドアロン VM の場合にも見られます。 1 つの NIC をスタンドアロンとして追加された場合、同じ動作が行われます。</p></blockquote><p><strong>外部接続不可</strong></p><p>最後に、フローチャートの中で赤色で記された<span style="color: #c00000;">「外部接続不可」</span>のシナリオについて補足しておきます。</p><p>フローチャートからもわかるように、Azure では多くの SNAT オプションがあり、ほとんどの状況で外部接続が可能です。特に、NAT 装置を意識せずに VM をデプロイするだけでも (デフォルトゲートウェイが) SNAT を実施してくれる「Azure 既定の SNAT」のシナリオに関しては、特筆すべきポイントです。</p><p>しかしながら、一つだけ SNAT 出来ないシナリオがあります。それが<span style="color: #c00000;">「外部接続不可」</span>のシナリオです。具体的には、Standard SKU の外部接続構成の NIC に、明示的に外部接続リソースを関連付けない場合に該当します (こうして言葉で説明するより、フローチャートを見てもらうほうが早いと思います)。</p><p>「VM が外部接続できない、できなくなった」というお問い合わせは多数いただきますが、殆どの場合の根本原因は、単に<span style="color: #c00000;">「外部接続不可」</span>のシナリオに該当していたというものです。このため、過去にもブログ記事として紹介しています。</p><ul><li><a href="https://jpaztech1.z11.web.core.windows.net/Azure%E3%83%AD%E3%83%BC%E3%83%89%E3%83%90%E3%83%A9%E3%83%B3%E3%82%B5%E3%83%BC%E5%88%A9%E7%94%A8%E6%99%82%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9.html#outbound-cannot-connect" target="_blank" rel="noopener">Azure ロードバランサー利用時の注意点 &gt; ロードバランサーのバックエンドプールに追加したら外部へ接続できなくなった</a></li></ul><blockquote><p>ロードバランサーのバックエンドプールに追加したら外部へ接続できなくなった<br>こちらの事象についてよくある原因としては以下があります。</p><ol><li>Standard SKU の内部ロードバランサーのバックエンドプールに所属している</li></ol></blockquote><p>上記ブログ記事は少し情報が古く (というより Azure の進化のスピードが本当にはやく)、現在はこのシナリオのワークアラウンドは以下の 4 つとなっていますが、<strong>明示的に外部接続のポリシーを構成する</strong> という根本的な考え方は変わりません。</p><ul><li>NVA (e.g. Azure Firewall) をデプロイし、0.0.0.0/0 のネクストホップを NVA に向ける UDR を構成する</li><li>NAT Gateway をデプロイし、VM が配置されているサブネットに関連付ける</li><li>Standard SKU のパブリック IP アドレスをデプロイし、VM に関連付ける</li><li>Standard SKU の外部ロードバランサーをデプロイし、そのバックエンド プールに VM を配置する</li></ul><h2 id="機能比較"><a href="#機能比較" class="headerlink" title="機能比較"></a>機能比較</h2><p>フローチャートの他に、幾つかの機能項目をピックアップし SNAT オプション間で比較した表も用意しました。俯瞰的に機能を比べる目的でご利用ください。</p><table><thead><tr><th align="center"></th><th align="center">AzFW/NVA + UDR</th><th align="center">NAT GW</th><th align="center">Public IP</th><th align="center">Public Azure Load Balancer</th><th align="center">Default SNAT</th></tr></thead><tbody><tr><td align="center">関連付け単位</td><td align="center">サブネット[^1]</td><td align="center">サブネット</td><td align="center">NIC</td><td align="center">バックエンド プール</td><td align="center">NIC</td></tr><tr><td align="center">送信元を固定出来るか</td><td align="center">NVA 依存[^2]</td><td align="center">はい</td><td align="center">はい</td><td align="center">はい</td><td align="center">いいえ</td></tr><tr><td align="center">SNAT ポート数を拡張出来るか</td><td align="center">NVA 依存[^2]</td><td align="center">はい</td><td align="center">いいえ</td><td align="center">はい</td><td align="center">いいえ</td></tr><tr><td align="center">SNAT ポート数が VM に静的割り当てされるか</td><td align="center">NVA 依存[^2]</td><td align="center">いいえ (動的確保)</td><td align="center">はい (64000 個)</td><td align="center">はい (数は構成依存)</td><td align="center">はい (1024 個)</td></tr><tr><td align="center">TCP アイドルタイムアウト</td><td align="center">NVA 依存[^2]</td><td align="center">4 ～ 120 分</td><td align="center">4 分</td><td align="center">4 ～ 120 分</td><td align="center">4 分</td></tr><tr><td align="center">利用可能なプロトコル</td><td align="center">NVA 依存[^2]</td><td align="center">TCP/UDP</td><td align="center">TCP/UDP/ICMP/ESP</td><td align="center">TCP/UDP</td><td align="center">TCP/UDP/ICMP</td></tr><tr><td align="center">インバウンド接続性も確保出来るか</td><td align="center">NVA 依存[^2]</td><td align="center">いいえ</td><td align="center">はい</td><td align="center">はい</td><td align="center">いいえ</td></tr></tbody></table><p>それぞれの行で意図している内容は、以下の通りです。</p><ul><li><strong>関連付け単位</strong>: SNAT のポリシーを適用する単位です。例えばサブネットが SNAT ポリシーの単位である場合、サブネット内のすべての VM は同じ方法で SNAT が実施されます。</li><li><strong>送信元を固定出来るか</strong>: この項目が “はい” の SNAT オプションでは、特定の SNAT アドレス プールから送信元の IP アドレスを払い出す事ができます。”いいえ” の SNAT オプションでは、時間経過や VM の先道など、あるイベントをトリガーとして SNAT プールが変更される可能性があります。</li><li><strong>SNAT ポート数を拡張出来るか</strong>: この項目が “はい” の SNAT オプションでは、構成状況を変更することで、ユーザーが各 VM に割り当てる SNAT ポート数を変動させることが出来ます。”いいえ” のオプションでは、予め定められた値のポート数が各 VM に割り当てられます。</li><li><strong>SNAT ポート数が VM に静的割り当てされるか</strong>: この項目が “はい” の SNAT オプションでは、予め各 VM には最大の SNAT ポート数が定められます。基本的に SNAT ポート数は固定ですが、唯一の例外は NAT Gateway です。NAT Gateway では、利用状況に応じて SNAT ポート数は動的に VM に割り当てられます。</li><li><strong>TCP アイドルタイムアウト</strong>: 外部接続の TCP 接続に関するタイムアウト値 (分) です。範囲が記載されている SNAT オプションに関しては、ユーザーが定めることが出来ます。</li><li><strong>利用可能なプロトコル</strong>: 外部接続でサポートされているプロトコルです。すべての SNAT オプションで TCP/UDP はサポートされているものの、ICMP が利用できないオプションもあるので注意してください。</li><li><strong>インバウンド接続性も確保出来るか</strong>: この項目が “はい” の SNAT オプションでは、Azure リソースを追加でデプロイすることなく、インバウンドの接続ポリシーも構成することが出来ます。</li></ul><p>[^1]: UDR の関連付け単位がサブネットであることに起因しています<br>[^2]: NVA による SNAT も結局は NAT Gateway、パブリック IP アドレス、外部 Azure Load Balancer、Azure 既定の SNAT のいずれかのオプションを NVA で利用しています。したがって、NVA の動作制限に加えて、これらの制限も当然加わります。</p><h2 id="SNAT-オプションの詳細"><a href="#SNAT-オプションの詳細" class="headerlink" title="SNAT オプションの詳細"></a>SNAT オプションの詳細</h2><p>このセクションでは、各 SNAT オプションについて少し深堀りして説明します。</p><p>主な特徴やユースケース、注意事項等を記載しますので、ここまでの内容を踏まえて興味の湧いた SNAT オプションについて、詳しく確認してみてください。</p><h3 id="NAT-Gateway"><a href="#NAT-Gateway" class="headerlink" title="NAT Gateway"></a>NAT Gateway</h3><p><img src="/blog/network/snat-options-for-azure-vm/nat-gateway-snat.png" alt="nat-gateway"></p><p><em>NAT ゲートウェイ (NAT Gateway)</em> は、複数ある SNAT オプションの中で唯一「外部接続だけを目的とした」専用サービスです。専用サービスとだけあって、SNAT プールの固定化はもちろん、動的なポート確保など、他の SNAT オプションにはない機能を有します。</p><p><strong>特徴</strong></p><ul><li>フルマネージドな PaaS サービスで、高い可用性を有します。</li><li>動的に SNAT ポートを確保できるのは NAT Gateway だけです[^3]。</li><li>Public IP や Azure Load Balancer の SNAT よりも、NAT Gateway が優先されます[^4]。</li><li>外部接続の TCP アイドル タイムアウトを最大 120 分に伸ばせます。</li><li>NAT Gateway に追加できるパブリック IP アドレスの最大数は 16 個です。つまり、一つの NAT Gateway あたり、最大 64,000 * 16 = 1,024,000 ポートが SNAT ポートに使えます。</li></ul><p>[^3]: NAT Gateway の動的な SNAT ポート確保動作の詳細は、<a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-gateway-resource#on-demand" target="_blank" rel="noopener">NAT ゲートウェイ リソースを使用した仮想ネットワークの設計 &gt; オンデマンド</a> をご覧ください。<br>[^4]: NAT Gateway と Public IP/Azure Load Balancer の共存環境における動作については、<a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-gateway-resource#nat-and-vm-with-instance-level-public-ip-and-public-load-balancer" target="_blank" rel="noopener">NAT ゲートウェイ リソースを使用した仮想ネットワークの設計 &gt; インスタンスレベル パブリック IP とパブリック Load Balancer を使用した VM と NAT</a> をご覧ください。</p><p><strong>基本的な構成方法</strong></p><ol><li>NAT Gateway リソースを作成する。</li><li>対象のサブネットに NAT Gateway を関連付ける。</li></ol><p><strong>ユースケース</strong></p><ul><li>一般的な SNAT のシナリオ全般。</li><li>大量に SNAT ポートが必要となる場合。</li><li>複数の VM で SNAT プールを共有したいが、各 VM が消費する SNAT ポート数にばらつきがある場合。</li></ul><p><strong>注意事項</strong></p><ul><li>NAT Gateway では、インバウンドの接続性は提供されません。</li><li>UDR で特定の経路のネクスト ホップを NVA や仮想ネットワーク ゲートウェイに向けている場合、それらを宛先とする通信は NAT Gateway を利用して SNAT されません。</li><li>他の外部接続のサービスで言えば Standard SKU の扱いのサービスなので、Basic のサービスと共存出来ません (e.g. Basic SKU の Public IP が付与された VM がサブネットに存在すれば、NAT Gateway は関連付けできない)。</li><li>ICMP プロトコルはサポートされません。</li><li>その他の制限事項について、<a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-overview#limitations" target="_blank" rel="noopener">公式ドキュメント</a> をご確認ください。</li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-overview" target="_blank" rel="noopener">Azure Virtual Network NAT とは | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-gateway-resource" target="_blank" rel="noopener">NAT ゲートウェイ リソースを使用した仮想ネットワークの設計 - Azure Virtual Network NAT | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/troubleshoot-nat" target="_blank" rel="noopener">Azure Virtual Network NAT 接続のトラブルシューティング - Azure Virtual Network | Microsoft Docs</a></li></ul><h3 id="パブリック-IP-アドレス"><a href="#パブリック-IP-アドレス" class="headerlink" title="パブリック IP アドレス"></a>パブリック IP アドレス</h3><p><img src="/blog/network/snat-options-for-azure-vm/public-ip-address-snat.png" alt="public-ip-address"></p><p>Azure VM のネットワーク インターフェイス (NIC) にパブリック IP アドレス (Public IP) を関連付けると、その NIC からの外部接続は Public IP によって SNAT される動作となります。</p><p><strong>特徴</strong></p><ul><li>SNAT に利用される IP アドレスは必ず Public IP なので、送信元を固定することが出来ます。</li><li>割り当てられるポート数は、Public IP が利用できるエフェメラル ポートの最大数 64,000 で固定されます。この 64,000 という数字は、もちろん用途にもよりますが、多くのワークロードで十分な SNAT ポート数です。</li></ul><p><strong>基本的な構成方法</strong></p><ol><li>パブリック IP アドレス リソースを作成する。</li><li>対象の VM の NIC に関連付ける。</li></ol><p><strong>ユースケース</strong></p><ul><li>エフェメラル ポートを一つの VM で専有したい場合 (e.g. 多くの SNAT ポートを消費するフォワード プロキシ)。</li><li>外部接続だけでなく VM 単位でのインバウンド接続も確保したい場合 (e.g. 特定拠点からリモート アクセスされる踏み台サーバー)。</li></ul><p><strong>注意事項</strong></p><ul><li>NAT Gateway による SNAT が実施されていないことが前提条件です。</li><li>Basic SKU だと NAT Gateway と共存出来ない等、SKU 依存の制限が存在します。可用性ゾーンへの対応も考慮すると、基本的には Standard SKU の使用が推奨されます。</li></ul><p><strong>参考文献</strong></p><ul><li>[Azure の Outbound connections &gt; シナリオ 1:パブリック IP アドレスありの VM | Microsoft Docs](<a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#ilPublic" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#ilPublic</a> IP)</li><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-network-public-ip-address" target="_blank" rel="noopener">Azure パブリック IP アドレスの作成、変更、削除 | Microsoft Docs</a></li></ul><h3 id="Azure-Load-Balancer"><a href="#Azure-Load-Balancer" class="headerlink" title="Azure Load Balancer"></a>Azure Load Balancer</h3><p><img src="/blog/network/snat-options-for-azure-vm/auzre-load-balancer-snat.png" alt="auzre-load-balancer-snat"></p><p>外部ロードバランサーのバックエンド プールに Azure VM を配置すると、構成した規則に応じて、フロントエンドの Public IP で SNAT される動作となります。</p><!-- [^Azure Load Balancer-snat-trigger]: 厳密にはバックエンド プールに VM を配置するだけでは不十分で、規則 (送信規則、負荷分散規則、インバウンド NAT 規則) を作るまでは SNAT されません。 --><p>このシナリオでは、特に Azure Load Balancer の Standard SKU でのみ利用可能な <strong>送信規則 (outbound rule)</strong> が効果的に活用できます。送信規則を使うと、SNAT ポート割り当てのカスタマイズや、TCP アイドルタイムアウトの調節が柔軟に構成出来ます。</p><p><strong>特徴</strong></p><ul><li>バックエンド プール単位で SNAT ポリシーが構成されるため、サブネットにとらわれずに複数 VM を同じ方法で SNAT できる。</li><li>Standard SKU で利用可能な送信規則を使って、より仔細に SNAt ポリシーが構成できる。</li><li>送信規則で制御できるパラメータは、以下の通り。<ul><li>バックエンド プール (どの仮想マシンに SNAT ポリシーを適用するか)</li><li>SNAT ポート数の割り当てかた (各仮想マシンに何ポートずつ割り当てるか)</li><li>SNAT の対象とするプロトコル (TCP、UDP、または両方)</li><li>TCP アイドルタイムアウト (4 分から最大 120 分まで)</li><li>タイムアウト時の TCP リセット送信の有無</li></ul></li></ul><p><strong>基本的な構成方法</strong></p><ol><li>パブリック IP アドレスをフロントエンドに付与した Azure Load Balancer (外部ロードバランサー) をデプロイする。</li><li>バックエンド プールを作成し、SNAT ポリシーを適用したい VM を複数追加する。</li><li>送信規則、インバウンド NAT 規則、あるいは送信規則 (Standard SKU のみ) を構成する。</li></ol><p><strong>ユースケース</strong></p><ul><li>SNAT と同時に、インバウンド方向の負荷分散も同時に構成したい場合 (e.g. 処理の一部で外部送信が必要となる WEB サーバー)。</li><li>サブネット以外の単位で、複数 VM を同一 SNAT ポリシー下としたい場合 (e.g. サブネットの一部の VM にのみインターネット接続を許可する)</li></ul><p><strong>注意事項</strong></p><ul><li>NAT Gateway、Public IP による SNAT が実施されていないことが前提条件です。</li><li>Basic SKU と Standard SKU で、SNAT の動作が大きく異なります。これは、Standard SKU で送信規則が追加され、高い自由度で SNAT ポリシーを構成できるようになった為です。</li><li>Basic SKU の場合、SNAT ポート数はバックエンド プールの VM の台数に依存して、Azure 基盤が自動で割り当てます。<ul><li>具体的な対応表は、以下の公式ドキュメントに記載がある通りです。<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#ephemeral-port-preallocation-for-port-masquerading-snat-pat" target="_blank" rel="noopener">Azure の Outbound connections &gt; ポート マスカレード SNAT (PAT) 用のエフェメラル ポートの事前割り当て | Microsoft Docs</a></li></ul></li><li>Standard SKU の場合、Basic SKU での自動割り当ての方法に加えて、送信規則を使って手動のポート数割り当てが行えます。<ul><li>送信規則によるポート数の調節については、以下の公式ドキュメントを参考にしてください。<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#azure-load-balancer-outbound-rules" target="_blank" rel="noopener">Azure の Outbound connections &gt; Azure Load Balancer のアウトバウンド規則 | Microsoft Docs</a></li></ul></li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-2-load-balanced-vm-without-a-public-ip-address" target="_blank" rel="noopener">Azure の Outbound connections &gt; シナリオ 2:パブリック IP アドレスなしの負荷分散 VM | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/configure-load-balancer-outbound-portal" target="_blank" rel="noopener">Azure portal を使用して負荷分散規則とアウトバウンド規則を構成する - Azure Load Balancer | Microsoft Docs</a></li></ul><h3 id="Azure-既定の-SNAT"><a href="#Azure-既定の-SNAT" class="headerlink" title="Azure 既定の SNAT"></a>Azure 既定の SNAT</h3><p><img src="/blog/network/snat-options-for-azure-vm/azure-default-snat.png" alt="azure-default-snat"></p><p>パブリック IP アドレスや外部ロードバランサーにも関連づいていない状態でも、Azure VM は既定で外部接続できるようになっています。特に SNAT の構成をしていないのにも関わらず、外部接続ができることで驚いた経験をした方もいらっしゃるのではないでしょうか。</p><p>特にパブリック IP アドレスをユーザーが確保しているわけではないため、SNAT プールはオンザフライでの提供となります。具体的には、VM がデプロイされている Azure リージョンで使用されるグローバル IP アドレスのうち、未使用なものがランダムに割り当てられます。そのため、VM を再起動するたびに、SNAT に利用される NAT アドレスは変動します。</p><p>なお、各 Azure リージョンで使用されるグローバル IP アドレスは、以下ページからダウンロードできる JSON ファイルに定義されています。</p><ul><li><a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519" target="_blank" rel="noopener">Download Azure IP Ranges and Service Tags – Public Cloud from Official Microsoft Download Center</a></li></ul><p><strong>特徴</strong></p><ul><li>唯一パブリック IP アドレス リソースを作らずに SNAT が出来るシナリオ。</li><li>未使用な IP アドレスがランダムで割り当てられるため、VM が起動するたびに SNAT アドレスが変動する。</li><li>確保される SNAT ポート数は VM あたり 1024 で固定。</li></ul><p><strong>基本的な構成方法</strong></p><p>以下のいずれかの環境で、VM は「Azure 既定の SNAT」で外部接続されます。</p><ul><li>VM を Basic SKU の内部 Azure Load Balancer のバックエンド プールに配置する</li><li>NAT Gateway、パブリック IP アドレス、Azure Load Balancer と関係ないスタンドアロンな VM を構成する</li></ul><p><strong>ユースケース</strong></p><ul><li>テスト/開発用 VM で外部送信が必要になる場合 (e.g. ひとまずインターネットに通信できていれば特に問題ない開発マシン)</li></ul><p><strong>注意事項</strong></p><ul><li>パブリック IP アドレスを付与しなくても外部接続できるという利便性がある一方で、予期せず外部送信を許可していますケースもあります。外部接続を許可しない場合、VM を Standard SKU の内部ロードバランサー配下として意図的に「外部接続不可」環境にするか、NSG で外部送信を拒否する対策等を実施してください。</li><li>SNAT プールが固定出来ないため、外部接続の接続先となるサーバーで ACL を実施するのが難しくなります。</li><li>あくまでテスト目的か、インターネットとの接続性だけ得られていれば後は気にしないようなワークロードでのみご利用いただくことを推奨いたします。</li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-3-standalone-vm-without-a-public-ip-address" target="_blank" rel="noopener">Azure の Outbound connections &gt; シナリオ 3:パブリック IP アドレスなしのスタンドアロン VM | Microsoft Docs</a></li><li><a href="https://www.syuheiuda.com/?p=5074" target="_blank" rel="noopener">Azure VM の SNAT の話 – Made in container</a></li></ul><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>記事のボリュームからも推察できる通り、Azure では SNAT のオプションが多く用意されています。</p><p>ただ、自由度が上がる副作用として、どうしてもすべてのシナリオを網羅的に把握することが難しくなっています。外部接続できない時のトラブルシューティングや、他にどんな選択肢があるのかの確認に、ぜひ冒頭で紹介したフローチャートを活用していただければと思います。</p><p>また、SNAT オプションの比較には、機能比較のセクションで示した比較表もご活用ください。当該の比較表は、各 SNAT オプションのすべての側面を映し出しているわけではありませんが、大まかにどのような違いがあるのかを知るには十分の情報を記載してあります。ファーストステップとしては丁度よい情報量だと思いますので、参考にしていただければ幸いです。</p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Azure Networking テクニカル サポートの山口です。&lt;/p&gt;
&lt;p&gt;Azure VM がインターネットに接続する際には、パブリック IP アドレスでの送信元 NAT (SNAT) が必要です。Azure は、外部接続の SNAT に関して多くのオプションを提供していますが、オプションが多くて便利な反面、全オプションの列挙やオプション間の比較が難しいのも事実です。そうした難しさを少しでも緩和できるよう、本稿では外部接続の SNAT オプションを様々な角度から網羅的に紹介いたします。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="Azure Load Balancer" scheme="https://jpaztech.github.io/blog/tags/Azure-Load-Balancer/"/>
    
      <category term="NAT Gateway" scheme="https://jpaztech.github.io/blog/tags/NAT-Gateway/"/>
    
      <category term="Public IP Address" scheme="https://jpaztech.github.io/blog/tags/Public-IP-Address/"/>
    
      <category term="SNAT" scheme="https://jpaztech.github.io/blog/tags/SNAT/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Peering 導入時の注意事項</title>
    <link href="https://jpaztech.github.io/blog/network/considerations-of-microsoft-peering/"/>
    <id>https://jpaztech.github.io/blog/network/considerations-of-microsoft-peering/</id>
    <published>2020-06-15T01:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.877Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Networking テクニカル サポートの山口です。</p><p>Azure のネットワークとオンプレミス拠点ネットワークを直接接続する ExpressRoute と呼ばれるサービスがあります。ExpressRoute では利用目的に応じた複数のピアリング方法が用意されているのですが、今回は Microsoft Peering と呼ばれるピアリング サービスについて注目して、その構築時に留意いただく必要のあるポイントをいくつかご紹介したいと思います。</p><a id="more"></a><h2 id="Microsoft-Peering-とは何か"><a href="#Microsoft-Peering-とは何か" class="headerlink" title="Microsoft Peering とは何か"></a>Microsoft Peering とは何か</h2><p>ExpressRoute は、オンプレミスと Azure のネットワークをインターネットを介さずに直接接続するためのサービスです。ExpressRoute 回線と呼ばれる Azure リソースを作成し、その中にピアリング情報を構成することで利用できます。</p><p>接続先に応じて下記 2 種類のピアリング種類が用意されており、ひとつの ExpressRoute 回線上に両ピアリングを同時に構成することもできます。</p><ul><li><strong>Private Peering</strong>: 仮想ネットワークとの接続 (Azure 上の Private IP 帯との接続)</li><li><strong>Microsoft Peering</strong>: Azure のパブリック サービス / O365 との接続 (Azure のパブリック IP 帯との接続)</li></ul><p>※ 以前はこの他に Public Peering と呼ばれる種別もありましたが、現在は Microsoft Peering に統合されています。</p><ul><li><a href="https://jpaztech1.z11.web.core.windows.net/ExpressRoute%E3%81%AEPublicPeering%E3%81%A8MicrosoftPeering%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%82%A2%E3%83%8A%E3%82%A6%E3%83%B3%E3%82%B9.html" target="_blank" rel="noopener">ExpressRouteのPublicPeeringとMicrosoftPeeringに関するアナウンス</a></li></ul><p>今回の記事では、<strong>Microsoft Peering</strong> と呼ばれるピアリング種別についてお話します。ExpressRoute 回線で Microsoft Peering を構成すると、オンプレミス拠点から Azure 上のパブリックなサービスに回線経由で接続できます。</p><p>例えば、BLOB ストレージへのバックアップ通信を ExpressRoute 回線経由とすることが出来ます。</p><h2 id="物理的レイヤー"><a href="#物理的レイヤー" class="headerlink" title="物理的レイヤー"></a>物理的レイヤー</h2><p>高レベルな概念としては、オンプレミス拠点と Azure のネットワークを接続するイメージで間違いないのですが、具体的にルーターのレベルで何をやっているか落とし込むと下図のようになります。</p><p><img src="/blog/network/considerations-of-microsoft-peering/microsoft-peering-overview.png" alt="microsoft-peering-overview"></p><p>まず用語を整理すると、次の通りです。</p><ul><li>Microsoft Enterprise Edge (MSEE): Azure 側のエッジ ルーター</li><li>Privider Edge (PE): プロバイダー側のエッジ ルーター</li><li>Customer Edge (CE): お客様拠点のエッジ ルーター</li></ul><p>Azure リソース上で 1 つの ExpressRoute 回線を作成すると、物理的には Azure 側のルーター (MSEE) が 2 つ確保される動作となっています。MSEE は Active/Active で動作するため、万が一片系に障害が発生しても引き続き通信が可能となります。</p><p>なお、ExpressRoute 回線の契約時に選択いただく帯域幅は、各 MSEE で同じだけ確保されます。例えば、200 Mbps を選択頂いた場合、プライマリ側の MSEE でもセカンダリ側の MSEE でも、それぞれ 200 Mbps が確保されます。</p><h3 id="BGP"><a href="#BGP" class="headerlink" title="BGP"></a>BGP</h3><p>PE と MSEE の間では、インターネットで一般的に用いられている動的な経路交換プロトコルの <strong>BGPv4</strong> (RFC4271) を利用して、お互いのネットワークの経路情報を交換、学習します。</p><p>BGP でピア (ネイバー) を張るには、PE と MSEE のそれぞれのインターフェイスに IP アドレスを割り当てる必要があり、Microsoft Peering ではこのアドレスをお客様側で準備いただく必要があります。PE と MSEE に払い出す IP アドレスが、セカンダリ/プライマリのそれぞれで必要な為、/30 のグローバル IP アドレスのプレフィクスが 2 つ必要です。</p><p>例えば、203.0.113.0/30 と 203.0.113.4/30 をサブネットに利用する場合は、先の図の通りに IP アドレスが払い出されます。つまり、予約済みでない利用可能 IP アドレスのうち、若番が PE 側に、老番が MSEE 側に払い出されます。<code>traceroute</code> を実行したときに MSEE が応答する IP アドレスの参考としていただければ幸いです。</p><h3 id="経路広報"><a href="#経路広報" class="headerlink" title="経路広報"></a>経路広報</h3><p>オンプレミス側から広報する経路情報は、基本的に、PE ルーターで NAT 用に確保しているアドレス プレフィクスです。後述の通り、この経路情報は <code>Advertised public prefixes</code> のパラメータで指定します。</p><p>例えば 203.0.113.0/28 をオンプレミス/プロバイダー側から広報すれば、Microsoft のパブリック サービスから 203.0.113.0/28 に宛てたパケットは、この ExprsesRoute 回線を経由してフォワーディングされる動作となります。このため、オンプレミス側から Azure への通信を 203.0.113.0/28 を SNAT することで、戻り通信が対称的に返ってくるようになります。</p><p>一方で、Azure 側から広報する経路情報は、<strong>ルート フィルター (route filter)</strong> と呼ばれる Azure リソースを利用で指定することが出来ます。逆に言えば、ルート フィルターで広報するまで、Azure 側からは一切経路が広報されません。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/how-to-routefilter-portal" target="_blank" rel="noopener">ExpressRoute:ルート フィルター - Microsoft ピアリング:Azure portal | Microsoft Docs</a></li></ul><h3 id="BGP-コミュニティ"><a href="#BGP-コミュニティ" class="headerlink" title="BGP コミュニティ"></a>BGP コミュニティ</h3><p>ルート フィルターでは、<strong>BGP コミュニティ (BGP Community)</strong> と呼ばれるアドレス プレフィクスの集合を単位として、目的のサービスに適したアドレス帯を Azure 側から広報することが出来ます。</p><p>選択できる BGP コミュニティの一覧は、以下の公式ドキュメントにまとまっています。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-routing#support-for-bgp-communities" target="_blank" rel="noopener">Azure ExpressRoute: ルーティングの要件 | Microsoft Docs</a></li></ul><p>簡単に例を挙げると、東日本リージョンのリージョン BGP コミュニティ (12076:51012) をルートフィルターで選択すれば、東日本リージョンで利用しているすべてのパブリック IP アドレスとの通信が ExpressRoute 回線を経由するようになります。</p><h3 id="その他の参考情報"><a href="#その他の参考情報" class="headerlink" title="その他の参考情報"></a>その他の参考情報</h3><p>より詳細については、以下の公式ドキュメントやブログ等をご参考にしていただければ幸いです。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-circuit-peerings#expressroute-peering" target="_blank" rel="noopener">Azure ExpressRoute: 回線とピアリング | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-faqs#microsoft-peering" target="_blank" rel="noopener">よくあるご質問 (FAQ) - Azure ExpressRoute | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/expressroute-deep-dive-part1" target="_blank" rel="noopener">詳説 Azure ExpressRoute - Part1: ExpressRoute を導入する前に | Microsoft Docs</a></li></ul><h2 id="導入手順"><a href="#導入手順" class="headerlink" title="導入手順"></a>導入手順</h2><p>Microsoft Peering は、大まかに以下の手順で構成いただけます。</p><ol><li>ExpressRoute 回線リソースを作成</li><li>プロバイダー側でプロビジョニング作業を実施</li><li>Microsoft Peeirng の構成を実施</li><li>NAT アドレス利用の承認を待機</li><li>ルートフィルターを構成</li></ol><p>Azure Portal 上での操作方法等は公式ドキュメントに記載されておりますので、詳細はこちらをご覧ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-routing-portal-resource-manager#microsoft-peering" target="_blank" rel="noopener">Azure ExpressRoute: ピアリングの構成 | Microsoft Docs</a></li></ul><p>続くセクションでは、導入に際してご留意いただく必要がある点を幾つかご紹介します。</p><h3 id="注意点-プロビジョニング作業の要不要"><a href="#注意点-プロビジョニング作業の要不要" class="headerlink" title="注意点: プロビジョニング作業の要不要"></a>注意点: プロビジョニング作業の要不要</h3><p>まずはじめに注意が必要なのは、手順 2. のプロビジョニング作業です。多くの ExpressRoute 回線プロバイダーでは、回線のプロビジョニング作業を代行して実施するサービスを提供しており、その場合はお客様側で実際に作業が必要となる工程は存在いたしません (このような回線プロバイダーは、L3 プロバイダーと呼ばれることもあります)。</p><p>一方で、お客様側でルーターの管理/構成を実施する必要のある回線プロバイダー (L2 プロバイダーと呼ばれます) も存在します。L2 プロバイダーの場合は、インターフェイスへの IP の割り当て、BGP、経路広報の設定といったルーターの構成を、お客様ご自身で実施して頂く必要があります。お客様の所有するルーターの構成方法については弊サポートでご支援することが叶わない為、プロビジョニング時の技術支援に関しては、別途ベンダー様にお問い合わせいただく必要があります。</p><p>以下の弊社エンジニアによる発表スライド (p10–12) でも L2 / L3 プロバイダーの違いを簡単にご説明をしていますので、こちらも併せてご参考ください。</p><ul><li><a href="https://eventmarketing.blob.core.windows.net/mstechsummit2018-after/CI27_PDF_TS18.pdf" target="_blank" rel="noopener">詳説 Azure ExpressRoute | 発表スライド</a></li><li><a href="https://www.youtube.com/watch?v=xBI-RA8wLqc" target="_blank" rel="noopener">[TS18] CI27 | 詳説 Azure ExpressRoute</a></li></ul><h3 id="注意点-Microsoft-Peering-構成時のパラメータ"><a href="#注意点-Microsoft-Peering-構成時のパラメータ" class="headerlink" title="注意点: Microsoft Peering 構成時のパラメータ"></a>注意点: Microsoft Peering 構成時のパラメータ</h3><p>次に、手順 3. で Microsoft Peering 構成時に入力する項目 (パラメータ) についてです。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-routing-portal-resource-manager#to-create-microsoft-peering" target="_blank" rel="noopener">Azure ExpressRoute: ピアリングの構成 | Microsoft Docs</a></li></ul><p>基本的な説明は上記ドキュメント内に記載されていますが、特にご質問をいただくことが多いパラメータについて以下で簡単に説明させていただきます。</p><p><strong>アドバタイズされたパブリック プレフィクス (Advertised public prefixes)</strong>:</p><p>オンプレミス側のルーターから広報するプレフィックスをご設定ください。10.x.x.x/28 等のプライベート IP アドレス (RFC 1918) は利用できず、ICANN や RIR から分配されたグローバル IP アドレスを利用する必要があります。<br>Microsoft Peering は、グローバル IP アドレス (いわゆるインターネット) の世界でルーティングを変更するサービスです。一般に、オンプレミス拠点のプライベート ネットワークからインターネットに出ていく際は、グローバル IP アドレスで SNAT する必要がありますが、その NAT アドレスのプールが <code>Advertised public prefixes</code> に該当することが一般的です。</p><p><strong>顧客 ASN (Customer ASN)</strong>:</p><p>前述の <code>Advertised public prefixes</code> として設定されるパブリック IP アドレスが、Peer AS と異なる AS に所属している場合に設定が必要となる場合があります。例えば、PE ルーターではプロバイダーの AS 番号 (これは <code>Peer AS</code> と呼ばれるパラメータです) を利用し、<code>Advertised public prefixes</code> はお客様所有の AS (これが <code>Customer AS</code> です) のパブリック IP アドレスを利用する場合などが該当します。</p><p><strong>ルーティング レジストリ名 (Routing registry name)</strong>:</p><p>BGP ハイジャッキングを防止する目的で、<code>Advertised public prefixes</code> がお客様所有のパブリック IP アドレスかを確認・検証しております。この検証時に RIR / IRR のデータベースを参照しますので、当該アドレスの割り当て元にあたる機関をご選択ください。</p><h3 id="注意点-Advertised-public-prefixes-の手動検証"><a href="#注意点-Advertised-public-prefixes-の手動検証" class="headerlink" title="注意点: Advertised public prefixes の手動検証"></a>注意点: Advertised public prefixes の手動検証</h3><p>選択したルーティング レジストリ (RIR/IRR) のデータベースに <code>Advertised public prefixes</code> が存在しない場合、システムによる自動検証が失敗します。この場合、サポート窓口お問い合わせをいただくことで、担当部門で手動の検証を実施することが出来ます。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-routing-portal-resource-manager#to-create-microsoft-peering" target="_blank" rel="noopener">Azure ExpressRoute: ピアリングの構成 | Microsoft Docs</a></li></ul><blockquote><p>‘検証が必要です’ というメッセージが表示された場合は、ルーティング レジストリにプレフィックスの所有者として一覧表示されているエンティティによって組織にパブリック プレフィックスが割り当てられていることを示すドキュメントを収集し、下に示すようにサポート チケットを開くことにより、これらのドキュメントを手動検証のために送信してください。</p></blockquote><p>お問い合わせの際には、承認を受ける ExpressRoute 回線を対象製品としてご選択ください。また、手動検証には以下の 5 つの情報が必要となりますので、こちらの情報を含めてご起票いただければスムーズに手動検証が実施出来ます。</p><ul><li>ExpressRoute 回線のサービス キー</li><li>ExpressRoute 回線をデプロイしたリージョン</li><li><code>Advertised public prefixes</code> (オンプレミス拠点から広報するパブリック IP アドレス)</li><li><code>Peer ASN</code> (MSEE と BGP ピアを張る AS 番号。<code>Customer ASN</code> ではありません)</li><li><code>Advertised public prefixes</code> を <code>Peer ASN</code> で利用出来ることを示す証跡。例えば、他社様から借り受けたグローバル IP アドレスであれば、借り受けたことを示すメールの文面や pdf の文書等が該当します</li></ul><h3 id="注意点-O365-利用時の承認について"><a href="#注意点-O365-利用時の承認について" class="headerlink" title="注意点: O365 利用時の承認について"></a>注意点: O365 利用時の承認について</h3><p>BGP コミュニティのうち、”その他の Office 365 Online サービス” (12076:5100) を選択するには、事前に Microsoft から承認を受ける必要があります。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-routing#service-to-bgp-community-value" target="_blank" rel="noopener">Azure ExpressRoute: ルーティングの要件 | Microsoft Docs</a></li></ul><blockquote><p>** Microsoft からの承認が必要です。「Microsoft ピアリングにルート フィルターを構成する\」を参照してください</p></blockquote><p>承認のフォームは以下のリンクから提供しておりますが、フォーム冒頭にも記載がある通り、法的規制などにより閉域網接続の正当性が認められる金融機関などのお客様を除いては、原則申請は承認されない点については予めご留意ください。</p><ul><li><a href="https://forms.office.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbRyOZxByRF1dLgv7k6ye5z8pUQkdLRTQ5QkcyOTU3VkNEOFdOWk9IRDZTUy4u" target="_blank" rel="noopener">ExpressRoute for Office 365 Request Form</a></li></ul><blockquote><p>Microsoft authorization is required to use ExpressRoute for Office 365. Microsoft reviews every customer request and authorizes ExpressRoute for Office 365 usage when a customer’s regulatory requirement mandates direct connectivity. If you have such requirements, please provide the text excerpt and web link to the regulation which you interpret to mean that direct connectivity is required in the ExpressRoute for Office 365 Request Form to begin a Microsoft review. </p><p>(抄訳)<br>ExpressRoute for Office 365 のご利用には Microsoft による承認が必要です。<br>Microsoft では、お客様の申請を検証して、閉域網での接続がお客様の規制要件によって義務付けられていると判断した場合に限り、ExpressRoute for Office 365 の使用を承認しています。<br>そのような要件がある場合は、ExpressRoute for Office 365 リクエスト フォームにて、閉域網接続が必要であることを示す規制文章の抜粋や Web リンクを提供してください。</p></blockquote><h2 id="Microsoft-Peering-に関する-FAQ"><a href="#Microsoft-Peering-に関する-FAQ" class="headerlink" title="Microsoft Peering に関する FAQ"></a>Microsoft Peering に関する FAQ</h2><p>最後に、頻繁にお問い合わせをいただくものの、公式ドキュメントには掲載のないご質問について簡単に回答を掲載させていただきます。</p><p>公式ドキュメントの FAQ ページは以下からアクセス出来ますので、こちらも併せてご参考としていただければと思います。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-faqs" target="_blank" rel="noopener">よくあるご質問 (FAQ) - Azure ExpressRoute | Microsoft Docs</a></li></ul><p>以下でも解決できないご不明点等がありましたら、ご利用の ExpressRoute 回線を対象製品として選択いただき、弊社技術サポートまでお問い合わせいただければ幸いです。</p><h3 id="Q-選択すべき-BGP-コミュニティはどれですか"><a href="#Q-選択すべき-BGP-コミュニティはどれですか" class="headerlink" title="Q. 選択すべき BGP コミュニティはどれですか?"></a>Q. 選択すべき BGP コミュニティはどれですか?</h3><p>BGP コミュニティでは、サービス カットで IP アドレスを集約していません。そのため、ある 1 つのサービス (製品) を利用する為に、複数 BGP コミュニティの広報が必要となる場合があります。</p><p>必要な BGP コミュニティはサービスの通信要件に依存しますので、通信要件が不明であれば、Azure Portal から技術サポートを起票する際の製品選択において該当するサービス名を選択し、弊社の技術サポートまでお問い合わせください。</p><h3 id="Q-ルート-フィルターで広報経路を追加した際の影響はありますか"><a href="#Q-ルート-フィルターで広報経路を追加した際の影響はありますか" class="headerlink" title="Q. ルート フィルターで広報経路を追加した際の影響はありますか?"></a>Q. ルート フィルターで広報経路を追加した際の影響はありますか?</h3><p>基本的には、新たに経路を追加しても既存の通信に関して影響が出ることはありません。</p><p>ただ、SLA で無影響 (ダウンタイムが発生しないこと) を保証している訳ではなく、さらにプロバイダー側やお客様でご利用されているルーターの動作については保証いたしかねます。少しでも影響が懸念される場合は、夜間帯等での作業実施を推奨させていただきます。</p><h3 id="Q-回線の切り替え時にはダウンタイムは発生しますか"><a href="#Q-回線の切り替え時にはダウンタイムは発生しますか" class="headerlink" title="Q. 回線の切り替え時にはダウンタイムは発生しますか?"></a>Q. 回線の切り替え時にはダウンタイムは発生しますか?</h3><p>はい。別の回線に切り替える際には NAT アドレス (Advertised public prefixes) も変わることが一般的ですので、既存回線の PE で NAT されている既存セッションは切断されることが期待されます。</p><h3 id="Q-Azure-から広報する経路をフィルターできますか"><a href="#Q-Azure-から広報する経路をフィルターできますか" class="headerlink" title="Q. Azure から広報する経路をフィルターできますか?"></a>Q. Azure から広報する経路をフィルターできますか?</h3><p>恐れ入りますが、現時点 (2020/06/13) では Azure から広報する経路を ExpressRoute 回線でフィルタリングする機能は提供がございません。別の言い方をすれば、BGP コミュニティよりも小さい単位で経路を広報することが出来ません。<br>PE ルーター、あるいはお客様拠点のルーターで経路のフィルタリングをご実施ください。</p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Azure Networking テクニカル サポートの山口です。&lt;/p&gt;
&lt;p&gt;Azure のネットワークとオンプレミス拠点ネットワークを直接接続する ExpressRoute と呼ばれるサービスがあります。ExpressRoute では利用目的に応じた複数のピアリング方法が用意されているのですが、今回は Microsoft Peering と呼ばれるピアリング サービスについて注目して、その構築時に留意いただく必要のあるポイントをいくつかご紹介したいと思います。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
      <category term="Microsoft Peering" scheme="https://jpaztech.github.io/blog/tags/Microsoft-Peering/"/>
    
  </entry>
  
  <entry>
    <title>Azure 環境における Windows Server 2019 の日本語の言語パック適用手順について</title>
    <link href="https://jpaztech.github.io/blog/vm/win2019-jp-lpk/"/>
    <id>https://jpaztech.github.io/blog/vm/win2019-jp-lpk/</id>
    <published>2020-06-10T08:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.901Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの山下です。</p><p>Azure Marketplace における Windows Server イメージは、基本的に英語版をベースとしたものが公開されておりますが、言語パックをインストールいただくことで、表示言語を日本語に変更してご利用いただくことが可能でございます。しかしながら、現在の Windows Server 2019 においては、Windows Server 2016 とは手順が異なることから、下記画像の赤枠のように日本語を追加したにも関わらず、表示言語に日本語を設定できないというお問い合わせをよくいただきます。<br><img src="/blog/vm/win2019-jp-lpk/1-issue.png" alt="">  </p><p>そこで今回は Windows Server 2019 における日本語の言語パックの適用手順についてご紹介させていただきます。</p><p>なお、Windows Server 2016 以前の手順については、以下の Blog 記事をご参照いただけますと幸いです。</p><blockquote><p>Azure 環境における Windows Server の日本語環境化について<br><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/japanese_langpack_etc" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/japanese_langpack_etc</a>  </p></blockquote><h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><p>言語パックのインストールは、更新プログラムやアプリをインストールする前に実施いただく必要があります。詳細は以下の弊社公開情報をご確認くださいますと幸いです。</p><blockquote><p>Windows イメージへの言語の追加 - 考慮事項<br><a href="https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/add-language-packs-to-windows#considerations" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/add-language-packs-to-windows#considerations</a>  </p><blockquote><p>言語をインストールしてから、更新プログラムとアプリをインストールします。 アプリまたは更新プログラム (サービス スタック更新プログラム (SSU) または累積更新プログラム (CU) など) を既に含むイメージに言語を追加する場合は、アプリと更新プログラムを再インストールします。</p></blockquote></blockquote><h2 id="適用手順"><a href="#適用手順" class="headerlink" title="適用手順"></a>適用手順</h2><p>以下の操作は Windows Server 2019 の Azure VM 上で行います。  </p><ol><li><p>下記より言語パックの iso ファイルをダウンロードします。  </p><blockquote><p>Windows Server 2019 デスクトップ エクスペリエンスの言語パックを構成できない<br><a href="https://support.microsoft.com/ja-jp/help/4466511/cannot-configure-language-pack-for-windows-server-2019" target="_blank" rel="noopener">https://support.microsoft.com/ja-jp/help/4466511/cannot-configure-language-pack-for-windows-server-2019</a><br>※ 方法 2: LPKSetupを使用 の手順 1 の [ここ] をクリックすることでダウンロードが可能です。<br>※ ダウンロード先の URL が変更される可能性もございますので、本記事では公開情報へのリンクを紹介しております。<br><img src="/blog/vm/win2019-jp-lpk/2-lpk-dl.png" alt="">  </p></blockquote></li><li><p>ダウンロードした言語パックをマウントします。下記画像では、E ドライブにマウントしています。<br><img src="/blog/vm/win2019-jp-lpk/3-mount.png" alt="">  </p></li><li><p>Windows キー を押下、”lpksetup.exe” と入力し、検索結果から起動します。<br><img src="/blog/vm/win2019-jp-lpk/4-lpksetup.png" alt="">  </p></li><li><p>“Install display languages” をクリックします。<br><img src="/blog/vm/win2019-jp-lpk/5-install.png" alt="">  </p></li><li><p>[Browse…] をクリックします。<br><img src="/blog/vm/win2019-jp-lpk/6-browse.png" alt="">  </p></li><li><p>“マウントされている言語パックのドライブ” &gt; “x64” &gt;  “langpacks” &gt; “Microsoft-Windows-Server-LanguagePack_x64_ja-jp” を選択し、[OK] をクリックします。<br><img src="/blog/vm/win2019-jp-lpk/7-select-ja-jp.png" alt="">  </p></li><li><p>Language 欄に「Japanese(日本語)」が表示されたことを確認し、[Next] をクリックします。<br><img src="/blog/vm/win2019-jp-lpk/8-select2.png" alt="">  </p></li><li><p>「マイクロソフト ソフトウェア追加ライセンス契約」の内容をご確認いただき、問題がなければ、”I accept the license terms. (同意する)” ラジオボタンにチェックを入れ、[Next] をクリックします。<br><img src="/blog/vm/win2019-jp-lpk/9-license.png" alt="">  </p></li><li><p>「Japanese(日本語)」のインストールが完了しましたら、[Close] をクリックします。<br><img src="/blog/vm/win2019-jp-lpk/10-completed.png" alt="">  </p></li><li><p>“Setting”  &gt; ”Time &amp; Language” &gt; “Language” を開き、[Language pack installed] が表示されていることを確認し、プルダウンより [日本語] を選択します。<br><img src="/blog/vm/win2019-jp-lpk/11-language.png" alt="">  </p></li><li><p>Windows display language に [日本語] が表示され、次回サインイン時に表示言語が切り替わることを示す [Will be display language after next sign-in] が表示されていることを確認し、一度サインアウトします。<br><img src="/blog/vm/win2019-jp-lpk/12-select-jp.png" alt="">  </p></li><li><p>サインインしなおすことで、表示言語が日本語になったことをご確認ください。下記画像はサーバー マネージャー の表示例です。<br><img src="/blog/vm/win2019-jp-lpk/13-servermanager-jp.png" alt="">  </p></li></ol><p>表示言語の切り替え後、更新プログラムやアプリのインストールをご実施ください。<br>タイムゾーンの変更等の手順は Windows Server 2016 と同様となりますので、再掲となりますが、以下の Blog 記事をご参照いただきますようお願い申し上げます。</p><blockquote><p>Azure 環境における Windows Server の日本語環境化について<br><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/japanese_langpack_etc" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/japanese_langpack_etc</a></p></blockquote><p>こちらの情報が、少しでも皆様のご参考となれば幸いでございます。</p><style>#article-entry img{  border: 1px royalblue solid !important;}</style>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの山下です。&lt;/p&gt;
&lt;p&gt;Azure Marketplace における Windows Server イメージは、基本的に英語版をベースとしたものが公開されておりますが、言語パックをインストールいただくことで、表示言語を
      
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway の証明書関連のトラブルシューティング</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-troubleshooting-cert/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-troubleshooting-cert/</id>
    <published>2020-05-11T03:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.873Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チーム檜山です。</p><p>今回は Application Gateway の証明書まわりについてよくお問い合わせをいただくものをご紹介させていただきます。</p><hr><p>Application Gateway をご利用時に証明書が関連する設定としては、リスナーと HTTP 設定があります。<br>リスナーはクライアントからのアクセスを受け付ける部分で、HTTP 設定はバックエンドの Web サーバーへ接続するための定義を行う部分となります。Application Gateway の設定や構成例については以下もご参照ください。</p><ul><li><a href="https://jpaztech1.z11.web.core.windows.net/ApplicationGateway%E3%81%AE%E6%A7%8B%E6%88%90%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6.html" target="_blank" rel="noopener">Application Gateway の構成について</a></li></ul><p>Application Gateway にて End to End の TLS (クライアントからバックエンドまですべて HTTPS による通信) を構成する場合、リスナーとバックエンドの Web サーバーにて証明書を構成する必要があります (HTTP 設定も構成により証明書の設定が必要)。</p><p><img src="/blog/network/appgw-troubleshooting-cert/TLS-End2End.png" alt="TLS-End2End"></p><p>End to End の TLS にはせずに、クライアントと Application Gateway の間だけを TLS 化する場合は、バックエンドのサーバーや HTTP 設定に対する証明書の設定は必要ありません。Application Gateway に証明書を設定したり、証明書の更新などを行う場合、どちらの証明書が必要か、どの証明書の更新が必要かなどを区別して考える必要があります。</p><p><img src="/blog/network/appgw-troubleshooting-cert/TLS-Offload.png" alt="TLS-Offload"></p><p><span id="application-gateway-error"></span></p><h2 id="Application-Gateway-へアクセスした際の証明書エラー"><a href="#Application-Gateway-へアクセスした際の証明書エラー" class="headerlink" title="Application Gateway へアクセスした際の証明書エラー"></a><a href="#application-gateway-error">Application Gateway へアクセスした際の証明書エラー</a></h2><p>FQDN を使用して Application Gateway のフロントエンド IP アドレスにアクセスした際に証明書のエラーが出る場合、リスナーの証明書に問題がある可能性があります。ブラウザ/ OS により動作が変わる場合があるので、念のため、複数のブラウザ/ OS にてご確認いただくことをお勧めいたします。</p><h4 id="出力例"><a href="#出力例" class="headerlink" title="出力例"></a>出力例</h4><p>Windows の Firefox ブラウザ<br><img src="/blog/network/appgw-troubleshooting-cert/Windows-FireFox.jpg" alt="Windows-Firefox"></p><p>Windows の Chrome ブラウザ<br><img src="/blog/network/appgw-troubleshooting-cert/Windows-Chrome.png" alt="Windows-Chrome"></p><p>Linux の curl コマンド</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl https:&#x2F;&#x2F;xxxxx.com</span><br><span class="line">curl: (60) SSL certificate problem: unable to get local issuer certificate</span><br><span class="line">More details here: https:&#x2F;&#x2F;curl.haxx.se&#x2F;docs&#x2F;sslcerts.html</span><br><span class="line"></span><br><span class="line">curl failed to verify the legitimacy of the server and therefore could not</span><br><span class="line">establish a secure connection to it. To learn more about this situation and</span><br><span class="line">how to fix it, please visit the web page mentioned above.</span><br></pre></td></tr></table></figure><p>念のため、以下の点についてもご確認ください。</p><ul><li>証明書の CN (Common Name) と URL で指定した FQDN があってない</li><li>証明書の有効期限が切れている</li><li>自己証明書を使用しており、ルート証明書とのチェーンの検証で失敗している</li><li>リスナーに登録した証明書に中間証明書が含まれていない</li></ul><p>4 点目の中間証明書についてですが、リスナーに登録した証明書に中間証明書が含まれていない場合、証明書の検証に失敗し、エラーになる場合があることを確認しております。(クライアントやブラウザによって動作が異なりますが、特に Linux 系のクライアントにて失敗することを確認済)<br>そのため、Application Gateway のリスナーに登録する PFX 形式の証明書は中間証明書を含む形で構成いただく必要がございます。</p><p>Edge や Chrome ブラウザの場合、クライアント側で中間証明書を補完するため、中間証明書に起因する問題が発生しているかがわからないことがあります。その場合、下記に記載の openssl コマンドにて証明書の状態を確認することが可能ですので、念のためご確認いただくことをお勧めいたします。</p><p><span id="probe-error"></span></p><h2 id="正常性プローブのエラー"><a href="#正常性プローブのエラー" class="headerlink" title="正常性プローブのエラー"></a><a href="#probe-error">正常性プローブのエラー</a></h2><p>Application Gateway V2 のバックエンドプールにて証明書が正しく構成されていない場合、バックエンド正常性の画面に以下のエラーが出ることがあります。</p><p><img src="/blog/network/appgw-troubleshooting-cert/RootCert.png" alt="RootCert"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The root certificate of the server certificate used by the backend does not match the trusted root certificate added to the application gateway.</span><br><span class="line">Ensure that you add the correct root certificate to whitelist the backend</span><br><span class="line">(バックエンドによって使用されるサーバー証明書のルート証明書が、アプリケーション ゲートウェイに追加されている信頼されたルート証明書と一致しません。バックエンドをホワイトリストに登録するために適切なルート証明書を追加していることを確認してください。)</span><br></pre></td></tr></table></figure><p>以下は SNI が不一致している場合の例。<br><img src="/blog/network/appgw-troubleshooting-cert/SNI-error.png" alt="SNI-Error"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The Common Name (CN) of the backend certificate does not match the host header of the probe. </span><br><span class="line">(バックエンド証明書の共通名 (CN) が probe のホスト ヘッダーと一致しません。)</span><br></pre></td></tr></table></figure><p>原因としては以下が考えられます。</p><ul><li>証明書の CN (Common Name) と 正常性プローブの SNI が一致していない</li><li>証明書の有効期限が切れている</li><li>自己証明書を使用しており、ルート証明書とのチェーンの検証で失敗している</li><li>証明書に中間証明書が含まれていない</li></ul><p>バックエンド側にバインドされている証明書の構成が正しいかどうかについても、下記に記載の openssl コマンドにて証明書の状態を確認することが可能ですので、念のためご確認いただくことをお勧めいたします。</p><p><span id="openssl-command"></span></p><h2 id="openssl-コマンドによる確認方法"><a href="#openssl-コマンドによる確認方法" class="headerlink" title="openssl コマンドによる確認方法"></a><a href="#openssl-command">openssl コマンドによる確認方法</a></h2><p>openssl はオープンソースのソフトウェアで Linux 系の OS で利用することができます。<br>Windows OS (Windows 10) の場合でも Windows Subsystem for Linux (WSL) を導入することで利用可能となります。</p><p>以下のコマンドを実行し、実行結果の CN が正しいか、エラーが表示されていないかを等を確認します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Application Gateway への接続確認]</span><br><span class="line">openssl s_client -connect &lt;Application Gateway の IP アドレス&gt;:443 -servername &lt;FQDN&gt; -showcerts</span><br><span class="line"></span><br><span class="line">[バックエンドへの接続確認]</span><br><span class="line">openssl s_client -connect &lt;バックエンドの IP アドレス&gt;:443 -servername &lt;FQDN&gt; -showcerts</span><br><span class="line"></span><br><span class="line">※バックエンドが内部 IP の場合は同一 VNET 上の VM からコマンドの実施を行ってください。</span><br></pre></td></tr></table></figure><p>以下の例の赤字部分のようなエラーが表示された場合、使用している証明書に中間証明書が含まれていない可能性がありますので、証明書の構成をご確認ください。</p><p>例 )<br>openssl s_client -connect 52.224.201.173:443 -servername azurecerttest.testacert.com -showcerts</p><p>CONNECTED(00000003)</p><p>depth=0 OU = Domain Control Validated, CN = azurecerttest.testacert.com</p><p><span style="color: red">verify error:num=20:unable to get local issuer certificate</span></p><p>verify return:1</p><p>depth=0 OU = Domain Control Validated, CN = azurecerttest.testacert.com</p><p><span style="color: red">verify error:num=21:unable to verify the first certificate</span></p><p>verify return:1</p><p>～省略～</p><p>Timeout   : 7200 (sec)</p><p><span style="color: red">Verify return code: 21 (unable to verify the first certificate)</span></p><p><span id="intermediate-cert"></span></p><h2 id="中間証明書の構成方法"><a href="#中間証明書の構成方法" class="headerlink" title="中間証明書の構成方法"></a><a href="#intermediate-cert">中間証明書の構成方法</a></h2><p>AppService 証明書を Powershell で Export した場合は中間証明書が含まれていない構成となり、別途、中間証明書を含む形で構成する必要があります。</p><p>AppService 証明書を Azure Portal, Azure CLI でエクスポートした場合、中間証明書は含まれた状態となりますので問題ありませんが、証明書のパスワードを明示的に設定する必要があります。その場合も以下の手順を実施することでパスワードを設定できますのでご利用ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/app-service/configure-ssl-certificate#export-certificate" target="_blank" rel="noopener">App Service 証明書を管理する (証明書をエクスポートします。)</a></li></ul><p>他の証明書においても PFX 形式の証明書に中間証明書が含まれていない場合、Windows 端末にて以下の手順を実施することで中間証明書を含む形で PFX 形式の証明書を構成可能ですので、お試しください。</p><p>※ 以下は Windows 10 の手順ですので、OS によっては少し手順が異なる場合がございます。</p><p>【証明書のインポート &amp; エクスポート】</p><ol><li><p>Azure ポータルから Export した証明書 (PFX) を Windows 端末の任意の場所に配置します。</p></li><li><p>証明書をダブルクリックし、”現在のユーザー” を選択し、”次へ” をクリックします。 </p></li><li><p>インポートするファイルが選択されていることを確認し、”次へ” をクリックします。</p></li><li><p>証明書の“パスワード” を入力し、”このキーをエクスポート可能にする” にチェックをいれ “次へ” をクリックします。<br>※証明書の ”パスワード” が空の場合は ”パスワード” を空にしたまま、”次へ” をクリックします。</p></li><li><p>“証明書の種類に基づいて、自動的に証明書ストアを選択する” を選択し、”次へ” をクリックします。</p></li><li><p>“完了” をクリックします。</p></li><li><p>Windows 端末の左下の Windows マークをクリックし、”certmgr.msc” と入力し、Enter キーを押します。</p></li><li><p>“個人” &gt; “証明書” をクリックし、Import した証明書を右クリックし、”すべてのタスク” &gt; “エクスポート” をクリックします。</p></li><li><p>最初の画面で “次へ” をクリックします。</p></li><li><p>秘密キーのエクスポート画面で “はい、秘密キーをエクスポートします” を選択肢、”次へ” をクリックします。</p></li><li><p>“証明のパスにある証明書を可能であればすべて含む” にチェックが入っていることを確認し、”次へ” をクリックします。</p></li><li><p>証明書の “パスワード” を設定して、”暗号化” が ”TripleDES-SHA1” であることを確認し、”次へ” をクリックします。</p></li><li><p>配置場所を選択して、証明書のファイル名を入力し、”次へ” をクリックします。</p></li><li><p>“完了” をクリックします。</p></li></ol><p><span id="faq"></span></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a><a href="#faq">FAQ</a></h2><h4 id="リスナーに設定した証明書の更新時に切断は発生しますか？"><a href="#リスナーに設定した証明書の更新時に切断は発生しますか？" class="headerlink" title="- リスナーに設定した証明書の更新時に切断は発生しますか？"></a>- リスナーに設定した証明書の更新時に切断は発生しますか？</h4><p>現時点で確認できている動作として V1, V2 共に証明書の更新時に数秒程度の切断が発生することを確認できております。そのため、少しの切断も許容されない環境である場合は、メンテナンス期間等の影響が少ないタイミングで更新いただくことをご検討ください。</p><h4 id="PFX-証明書の中身を確認する方法はありますか？"><a href="#PFX-証明書の中身を確認する方法はありますか？" class="headerlink" title="- PFX 証明書の中身を確認する方法はありますか？"></a>- PFX 証明書の中身を確認する方法はありますか？</h4><p>以下のコマンドを実施することで証明書の構成を確認することができます。</p><p>【Windows】</p><p>コマンドプロンプトで以下を実施します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certutil -dump &quot;ファイルのパス&#x2F;xxxxx.pfx&quot;</span><br></pre></td></tr></table></figure><p>【Linux】</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -info -in &lt;ファイルのパス&#x2F;xxxxx.pfx&gt;</span><br></pre></td></tr></table></figure><h4 id="利用可能な証明書の一覧はありますか？"><a href="#利用可能な証明書の一覧はありますか？" class="headerlink" title="- 利用可能な証明書の一覧はありますか？"></a>- 利用可能な証明書の一覧はありますか？</h4><p>公開情報として利用可能な証明書の情報はありません。<br>公開情報の要件を満たす証明書であれば利用可能です。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/ssl-overview#certificates-supported-for-tls-termination" target="_blank" rel="noopener">TLS 終了でサポートされる証明書</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits" target="_blank" rel="noopener">Application Gateway の制限</a></li></ul><h4 id="ポータルから証明書を削除する方法はありますか？"><a href="#ポータルから証明書を削除する方法はありますか？" class="headerlink" title="- ポータルから証明書を削除する方法はありますか？"></a>- ポータルから証明書を削除する方法はありますか？</h4><p>現状、ポータルから証明書を削除する方法は提供されておりません。以下の Powershell or Azure CLI のコマンドにて削除可能ですので、ご確認ください。使用中の証明書は削除できませんので、証明書が利用されていないことを事前にご確認ください。<br>また、HTTP 設定用の証明書削除手順は V1, V2 SKU でコマンドが異なりますので、ご留意ください。</p><ul><li>証明書削除 (リスナー用)</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">【Powershell】</span><br><span class="line">1. Application Gateway の情報を取得します。</span><br><span class="line">$appgw &#x3D; Get-AzApplicationGateway -Name &quot;アプリケーション ゲートウェイ名&quot; -ResourceGroupName &quot;リソース グループ名&quot;</span><br><span class="line"> </span><br><span class="line">2. 削除したい SSL サーバー証明書の名前を指定します。</span><br><span class="line">Remove-AzApplicationGatewaySslCertificate -ApplicationGateway $appgw -Name &quot;証明書名&quot;</span><br><span class="line"> </span><br><span class="line">3. Application Gateway に設定を反映します。</span><br><span class="line">Set-AzApplicationGateway -ApplicationGateway $appgw</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">【Azure CLI】</span><br><span class="line">az network application-gateway ssl-cert delete -g &lt;リソースグループ名&gt; --gateway-name &lt;Application Gateway 名&gt; -n &lt;証明書名&gt;</span><br></pre></td></tr></table></figure><ul><li>証明書削除 (HTTP 設定用 [V1 のバックエンド認証用証明書])</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">【Powershell】</span><br><span class="line">1. 対象の Application Gateway を取得します。</span><br><span class="line">$appgw &#x3D; Get-AzApplicationGateway -Name &quot;Application Gateway 名&quot; -ResourceGroupName &quot;ResourceGroup 名&quot;</span><br><span class="line"> </span><br><span class="line">2. 既存のサーバ証明書を削除します。※現在登録されている証明書名を指定します。</span><br><span class="line">Remove-AzApplicationGatewayAuthenticationCertificate -ApplicationGateway $appgw -Name &quot;証明書名&quot;</span><br><span class="line"></span><br><span class="line">3. Application Gateway に設定を反映します</span><br><span class="line">Set-AzApplicationGateway -ApplicationGateway $appgw</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">【Azure CLI】</span><br><span class="line">az network application-gateway auth-cert delete -g &lt;リソースグループ名&gt; --gateway-name &lt;Application Gateway 名&gt; -n &lt;証明書名&gt;</span><br></pre></td></tr></table></figure><ul><li>証明書削除 (HTTP 設定用 [V2 のルート証明書])</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">【Powershell】</span><br><span class="line">1. 対象の Application Gateway を取得します。</span><br><span class="line">$appgw &#x3D; Get-AzApplicationGateway -Name &quot;Application Gateway 名&quot; -ResourceGroupName &quot;ResourceGroup 名&quot;</span><br><span class="line"></span><br><span class="line">2. 既存のルート証明書を削除します。※現在登録されている証明書名を指定します。</span><br><span class="line">Remove-AzApplicationGatewayTrustedRootCertificate -ApplicationGateway $appgw -Name &quot;証明書名&quot;</span><br><span class="line"></span><br><span class="line">3. Application Gateway に設定を反映します</span><br><span class="line">Set-AzApplicationGateway -ApplicationGateway $appgw</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">【Azure CLI】</span><br><span class="line">az network application-gateway root-cert delete -g &lt;リソースグループ名&gt; --gateway-name &lt;Application Gateway 名&gt; -n &lt;証明書名&gt;</span><br></pre></td></tr></table></figure><p><span id="reference"></span></p><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a><a href="#reference">参考情報</a></h2><p>Application Gateway のトラブルシューティングについては以下にも情報がございますので、ご参照ください。</p><ul><li><a href="./application-gateway-troubleshooting-502">Application Gateway での無効なゲートウェイによるエラーのトラブルシューティング</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-backend-health-troubleshooting" target="_blank" rel="noopener">Application Gateway のバックエンドの正常性に関する問題のトラブルシューティング</a></li></ul><p>証明書の要件については以下にも記載がありますので、ご参照ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/ssl-overview" target="_blank" rel="noopener">Application Gateway での TLS 終了とエンド ツー エンド TLS の概要</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チーム檜山です。&lt;/p&gt;
&lt;p&gt;今回は Application Gateway の証明書まわりについてよくお問い合わせをいただくものをご紹介させていただきます。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;Application Gateway を
      
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="ApplicationGateway" scheme="https://jpaztech.github.io/blog/tags/ApplicationGateway/"/>
    
      <category term="Certficate" scheme="https://jpaztech.github.io/blog/tags/Certficate/"/>
    
      <category term="SSL" scheme="https://jpaztech.github.io/blog/tags/SSL/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway でサブネットを変更する方法</title>
    <link href="https://jpaztech.github.io/blog/network/appgw_change_subnet/"/>
    <id>https://jpaztech.github.io/blog/network/appgw_change_subnet/</id>
    <published>2020-04-21T05:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.873Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの薄井です。<br>今回は Application Gateway V1 および V2 でサブネットを変更する方法についてご紹介します。</p><p>残念ながら現在の Azure ポータルからは、すでにデプロイした Application Gateway のサブネットを後から変更することはできません。<br>サブネットを変更する必要性が生じたら、新しく Application Gateway を作り直すしかありません。</p><p>しかし Azure PowerShell を使うことで、 Application Gateway を作り直すことなく、既存のサブネットの設定を変更することができます。</p><h2 id="サブネット変更方法"><a href="#サブネット変更方法" class="headerlink" title="サブネット変更方法"></a>サブネット変更方法</h2><p>※ 弊社検証環境でも動作の確認を行っておりますが念のため、お客様環境におかれましても事前に検証環境で動作をご確認のうえ本番環境への適用をお願いいたします。</p><p>※ Application Gateway のフロントエンド IP 構成において、プライベート IP アドレスが固定で設定されている場合は、プライベート IP アドレスと関連するリスナー設定等を削除しておく必要があります。</p><hr><ol><li><p>あらかじめ同一 VNET 内に変更先の新しいサブネットを作成しておきます。</p></li><li><p>Azure PowerShell または ポータルより Cloud Shell を起動し、以下のコマンドレットを入力します。（&lt;&gt;の部分は環境に合わせて変更が必要となります）</p></li><li><p>構成を変更する対象のサブスクリプションを指定します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select-AzSubscription -SubscriptionId &lt;サブスクリプション ID&gt;</span><br></pre></td></tr></table></figure></li><li><p>構成を変更する対象の仮想ネットワークを指定します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$VNet</span> = Get-AzVirtualNetwork -Name &lt;対象の仮想ネットワーク&gt; -ResourceGroupName &lt;変更対象のリソースグループ&gt;</span><br></pre></td></tr></table></figure></li><li><p>変更先のサブネットを取得します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Subnet</span> = Get-AzVirtualNetworkSubnetConfig -Name &lt;変更先のサブネット名&gt; -VirtualNetwork <span class="variable">$VNet</span></span><br></pre></td></tr></table></figure></li><li><p>変更対象の Application Gateway を取得します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$gw</span>=Get-AzApplicationGateway -name &lt;変更対象の Application Gateway 名&gt; -ResourceGroupName &lt;変更対象のリソースグループ&gt;</span><br></pre></td></tr></table></figure></li><li><p>サブネットの変更を加えます。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$gw2</span>=Set-AzApplicationGatewayIPConfiguration -ApplicationGateway <span class="variable">$gw</span> -Name <span class="string">"appGatewayIpConfig"</span> -Subnet <span class="variable">$Subnet</span></span><br></pre></td></tr></table></figure></li><li><p>稼働中の Application Gateway を停止します。※ 停止に数分かかります</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stop-AzApplicationGateway -ApplicationGateway <span class="variable">$gw</span></span><br></pre></td></tr></table></figure></li><li><p>Application Gatewayを設定、開始します。※ 開始に 10 分以上かかります</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-AzApplicationGateway -ApplicationGateway <span class="variable">$gw2</span></span><br></pre></td></tr></table></figure></li><li><p>開始後に以前と同様に Web サーバへアクセスできるか確認します。</p></li></ol><hr><p>以上、ご参考になれば幸いです。</p><h2 id="その他の-Application-Gateway-のサブネットに関連する情報"><a href="#その他の-Application-Gateway-のサブネットに関連する情報" class="headerlink" title="その他の Application Gateway のサブネットに関連する情報"></a>その他の Application Gateway のサブネットに関連する情報</h2><p>Application Gateway のサブネットについて関連する情報が以下のページにあります。<br>併せてご参考いただければと思います。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/configuration-overview#size-of-the-subnet" target="_blank" rel="noopener">アプリケーション ゲートウェイ構成の概要 &gt; サブネットのサイズ</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/configuration-overview#network-security-groups-on-the-application-gateway-subnet" target="_blank" rel="noopener">アプリケーション ゲートウェイ構成の概要 &gt; アプリケーション ゲートウェイ サブネット上のネットワーク セキュリティ グループ</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-faq" target="_blank" rel="noopener">Application Gateway に関してよく寄せられる質問</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの薄井です。&lt;br&gt;今回は Application Gateway V1 および V2 でサブネットを変更する方法についてご紹介します。&lt;/p&gt;
&lt;p&gt;残念ながら現在の Azure ポータルからは、すでにデプロイした Ap
      
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="ApplicationGateway" scheme="https://jpaztech.github.io/blog/tags/ApplicationGateway/"/>
    
  </entry>
  
  <entry>
    <title>Azure リソースの意図しない削除について</title>
    <link href="https://jpaztech.github.io/blog/vm/resource-delete/"/>
    <id>https://jpaztech.github.io/blog/vm/resource-delete/</id>
    <published>2020-03-12T08:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.897Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの安田です。</p><p>今回は意図せずリソースやリソースグループを消してしまった際のトラブルシューティングおよび、誤削除が発生しないような運用についてご案内させていただきます。</p><span style="color:gray;"></span><h2 id="リソースの復旧について"><a href="#リソースの復旧について" class="headerlink" title="リソースの復旧について"></a>リソースの復旧について</h2><p>トラブルシューティングと銘打っておきながら大変恐縮ですが、基本的に IaaS 領域のリソースについては削除されたリソースを復元するということはできません。<br><span style="font-size: 75%">(お客様から消してください。と言われたリソース・データを保持しておく方が色々と問題となりますので。。。) </span></p><p>このような背景からも、「リソースグループ / リソースを誤って削除してしまいました。どうにかなりませんか？」と弊サポート部門にお問い合わせいただいても大変心苦しいのですが、復旧することは叶いません。<br>ただし、Storage Account に限ってはわずかですが復旧できる可能性があります。</p><h2 id="Storage-Account-の復旧について"><a href="#Storage-Account-の復旧について" class="headerlink" title="Storage Account の復旧について"></a>Storage Account の復旧について</h2><p>Storage Account （の特定の SKU）に限り、Azure 基盤側から復旧を行うことが可能な場合があります。具体的には GRS と RA-GRS （セカンダリリージョンへの地理冗長が組まれている SKU） が前提となります。<br>これは Storage Account のセカンダリリージョンのデータが削除されるまでに時差があるため、セカンダリリージョンからデータを持ってくることとなります。<br>なお、復旧対象は Storage Account か コンテナ を丸ごと消してしまった場合のみが対象となり、単一のデータを誤削除しても復旧することは叶いませんので、予めご了承ください。</p><p>万が一、誤ってストレージアカウント・コンテナを削除してしまった場合は、削除してしまった Storage Account 名・サブスクリプション ID (英数字32桁)・削除されたおおまかな時刻を記載のうえ弊サポート部門までお問い合わせください。基本的には時間との勝負なので、判明次第すぐにお問い合わせください。<br>また、復旧を行う際に整合性の問題が発生することを避けるため、同名の Stoage Account・コンテナは<span style="font-size: 150%; color: red;">作成しないように</span>お願いいたします。</p><p>なお、復旧が可能となる期間についてはリージョンやデータセンター内部の動作等、様々な要因にて前後するためお伝えすることはできません。過去の事例から削除後すぐにお問い合わせをしたものの、復旧できなかったという事例もございますし、お問い合わせの起票が削除から数日後であったものの復元できたというケースもございます。弊サポート部門でもできる限り復旧できるようにご支援いたしますが、ベストエフォートでの対応となり、復旧が叶わない可能性も十分ございますので、予めご了承ください。</p><h2 id="リソースの誤削除を未然に防ぐ方法について（リソースロック機能のご紹介）"><a href="#リソースの誤削除を未然に防ぐ方法について（リソースロック機能のご紹介）" class="headerlink" title="リソースの誤削除を未然に防ぐ方法について（リソースロック機能のご紹介）"></a>リソースの誤削除を未然に防ぐ方法について（リソースロック機能のご紹介）</h2><p>リソースの誤削除は得てしてヒューマンエラーから発生するものであり、注意していても発生してしまうものです。<br>よくある事例として、検証用環境と運用環境でサブスクリプションを分けていたものの、リソース名が同名となっており、コマンドラインから検証用環境のリソースを削除しようとして誤って運用環境リソースを消してしまう等、様々なシナリオが挙げられます。<br>そのため検証用環境と本番用環境で名前を明確に区別しておく、Backup 用のリソースのみ別のリソースグループに保存しておく等、構築段階でヒューマンエラーをできるだけを招きにくくし、発生しても影響が最低限となるように設計しておくことを推奨いたします。</p><p>また、Azure のリソースにはロック機能という誤削除・誤操作防止用の機能を無償にて提供しております。リソースグループやサブスクリプション単位でリソースの削除を防止するだけでなく、Read Only として変更を実行できないようにすることも可能なので、”運用環境に展開済みでこれ以上手を加えたくない。”という場合にもお使いいただく事のできる機能となります。</p><p>設定方法や注意事項については下記のドキュメントに記載されておりますので、ご確認ください。</p><blockquote><p>参考URL: リソースのロックによる予期せぬ変更の防止<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/lock-resources" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/lock-resources</a></p></blockquote><p>画像例: 仮想マシンにロック機能を使用</p><p><img src="/blog/vm/resource-delete/delete.jpg" alt=""></p><p>画像例: 削除時に失敗する</p><p><img src="/blog/vm/resource-delete/delete2.jpg" alt=""></p><p>なお、下記の通り、リソースロックは 所有者 と ユーザー アクセス管理者 等、Microsoft.Authorization/* または Microsoft.Authorization/locks/* アクション へアクセス可能であるユーザーしか作成・削除することはできません。</p><p>※上記公開情報より抜粋</p><blockquote><p><strong>誰がロックを作成または削除できるか</strong><br>管理ロックを作成または削除するには、Microsoft.Authorization/* または Microsoft.Authorization/locks/* アクションにアクセスできる必要があります。 組み込みロールのうち、所有者とユーザー アクセス管理者にのみこれらのアクションが許可されています。</p></blockquote><p>そのため、IAM の項目から対象のリソースやリソースグループに対して、下記のように特定のユーザーに対して “所有者” か “ユーザー アクセス管理者” の権限を割り当てください。</p><p>Azure Portal &gt; Virtual Machines &gt; 対象の仮想マシン &gt; アクセス制御(IAM) &gt; ロール割り当て &gt; 追加 &gt; 役割とユーザーを選択し、追加</p><p>画像例: 仮想マシンに特定のユーザーに “ユーザー アクセス管理者” を付与<br><img src="/blog/vm/resource-delete/IAM.jpg" alt=""></p><h2 id="BLOB-ファイルの誤削除を未然に防ぐ方法について（Soft-Delete-機能のご紹介）"><a href="#BLOB-ファイルの誤削除を未然に防ぐ方法について（Soft-Delete-機能のご紹介）" class="headerlink" title="BLOB ファイルの誤削除を未然に防ぐ方法について（Soft Delete 機能のご紹介）"></a>BLOB ファイルの誤削除を未然に防ぐ方法について（Soft Delete 機能のご紹介）</h2><p>リソースロック機能は Azure のリソースが対象ですが、”Soft Delete (論理的な削除)機能” を事前に登録いただく事で、Storage Account 内の BLOB ファイルを操作ミス等で削除してしまっても設定した期間内であれば復旧することが可能となります。</p><p>ポータルからさくっと設定・復元することができるため、重要なデータを保護している場合には、有効化いただくことを推奨いたします。設定手順や詳細については下記公開ドキュメントをご確認ください。</p><blockquote><p>参考URL: Azure Storage Blob の論理的な削除<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/blobs/storage-blob-soft-delete?tabs=azure-portal" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/storage/blobs/storage-blob-soft-delete?tabs=azure-portal</a></p></blockquote><p># 現段階では Azure Data Lake Storage Gen2 の Storage Account についてはSoft Deleteの機能はサポートされておりませんので、予めご了承ください。</p><blockquote><p>参考URL: Azure Data Lake Storage Gen2 に関する既知の問題<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/blobs/data-lake-storage-known-issues#support-for-other-blob-storage-features" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/storage/blobs/data-lake-storage-known-issues#support-for-other-blob-storage-features</a><br>※ 抜粋<br>論理的な削除 : まだサポートされていません</p></blockquote><p>以上、少しでもご参考となれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの安田です。&lt;/p&gt;
&lt;p&gt;今回は意図せずリソースやリソースグループを消してしまった際のトラブルシューティングおよび、誤削除が発生しないような運用についてご案内させていただきます。&lt;/p&gt;
&lt;span style=&quot;col
      
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Troubleshooting" scheme="https://jpaztech.github.io/blog/tags/Troubleshooting/"/>
    
  </entry>
  
  <entry>
    <title>リソース正常性（Resource Health）アラートの構成方法</title>
    <link href="https://jpaztech.github.io/blog/vm/resource-health-alert/"/>
    <id>https://jpaztech.github.io/blog/vm/resource-health-alert/</id>
    <published>2020-01-24T08:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.897Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの安田です。</p><p>「Azure 基盤側の障害によって仮想マシンが ダウン / 復旧 した際に通知を受け取りたい。」<br>サポート業務をしていてそういったご要望をよくいただきます。<br>そこで今回は、リソース正常性アラートという機能を用いて、障害発生時に仮想マシンがダウンした際に、アラートを受け取る方法をお伝えします。</p><span style="color:gray;"><ul>    <li>ブログ執筆時点では本機能はプレビュー段階となりますので、通知が正常に送付されない可能性がありますので、予めご了承ください。</li>    <li>(鋭意開発中ですが、現段階では一般公開の目途は決まっておりません。)</li>    <li>また、リソース正常性についても、正しく表記されないことがあることもあるため、表記に差異があれば、サポート部門までお問い合わせください。</li></ul></span><h2 id="サービス正常性監視やハートビート監視との住み分けについて"><a href="#サービス正常性監視やハートビート監視との住み分けについて" class="headerlink" title="サービス正常性監視やハートビート監視との住み分けについて"></a>サービス正常性監視やハートビート監視との住み分けについて</h2><p>Azure が提供している他のリソース監視サービスとの違いを簡単に記載します。それぞれ用途や動作が異なるため、ご要件にあったものを選択ください。</p><h3 id="■-リソース正常性アラート"><a href="#■-リソース正常性アラート" class="headerlink" title="■ リソース正常性アラート"></a>■ リソース正常性アラート</h3><p>リソース正常性アラートはリソース正常性に変化が発生した際に、任意の連絡先に通知を飛ばす機能となります。リソース正常性ではリソース単位で発生した障害について確認することができます。仮想マシンに限らず、Storage Account や Microsoft SQL 等、様々なリソースの稼働状況を確認することができます。</p><p>リソース正常性の詳細については、公式ドキュメントおよび、過去の記事とはなりますが、以下の URL を参照ください。</p><blockquote><p>Resource Health の概要<br><a href="https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-overview" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-overview</a></p></blockquote><blockquote><p>リソース正常性を使って、自分のリソースに何が起きたのかを確認する<br><a href="https://blogs.technet.microsoft.com/jpaztech/2017/04/12/resourcehealth/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpaztech/2017/04/12/resourcehealth/</a></p></blockquote><p>仮想マシンの場合、リソース正常性は Azure 基盤側から仮想マシンを展開する物理ホストサーバー単位で下記の内容を監視しており、ゲスト OS にて異常を検知した際に、”使用不可”　に変更されることが想定されます。</p><blockquote><p>Azure Resource Health で利用できるリソースの種類と正常性チェック<br><a href="https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-checks-resource-types#microsoftcomputevirtualmachines" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-checks-resource-types#microsoftcomputevirtualmachines</a><br><br>　　・　ホスト サーバーが稼働しているか<br>　　・　ホスト OS の起動が完了しているか<br>　　・　仮想マシン コンテナーがプロビジョニングされ、オンになっているか<br>　　・　ホストとストレージ アカウント間のネットワーク接続が存在する<br>　　・　ゲスト OS の起動が完了しているか<br>　　・　進行中の定期的なメンテナンスはあるか</p></blockquote><h3 id="■-サービス正常性アラート"><a href="#■-サービス正常性アラート" class="headerlink" title="■ サービス正常性アラート"></a>■ サービス正常性アラート</h3><p>下記の公開情報の通り、サービス正常性アラートはサービスに変更があった際にアラートが発報されます。サービス正常性は仮想マシンのメンテナンス通知やお使いいただいている各サービスの障害についての情報を確認することができます。本機能はリージョン単位での障害など、大規模な障害に対してのみ通知を行うため、物理ホストサーバー単位といった個別の障害についてはアラートは発報されません。</p><p>※公開情報より抜粋</p><blockquote><p>Azure Resource Health の FAQ<br><a href="https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-faq#how-is-resource-health-different-from-azure-status-or-the-service-health-dashboard" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-faq#how-is-resource-health-different-from-azure-status-or-the-service-health-dashboard</a><br><br>Resource Health は Azure の状態や Service Health ダッシュボードと何が違うのでしょうか。<br>Resource Health の方が、Azure の状態や Service Health ダッシュボードと比べて具体的な細かい情報が得られます。<br><a href="https://status.azure.com/" target="_blank" rel="noopener">Azure の状態</a>と Service Health ダッシュボードでは広範な顧客 (Azure リージョンなど) に影響するサービスの問題に関する情報を通知しますが、Resource Health では特定のリソースのみに関連するより詳細なイベントを公開します。<br>たとえば、ホストが予期せず再起動するとき、Resource Health はそのホスト上で仮想マシンが実行されている顧客のみに警告します。<br>リソースに影響を与えるイベントを完全に可視化することが重要であるため、Resource Health には、Service Health ダッシュボードで発行されたイベントも表示されます。</p></blockquote><p>サービス正常性アラートについては下記ドキュメントをご確認ください。</p><blockquote><p>サービス通知のアクティビティ ログ アラートを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/service-health/alerts-activity-log-service-notifications" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/service-health/alerts-activity-log-service-notifications</a></p></blockquote><h3 id="■-ハートビート監視（Log-Analytics）"><a href="#■-ハートビート監視（Log-Analytics）" class="headerlink" title="■ ハートビート監視（Log Analytics）"></a>■ ハートビート監視（Log Analytics）</h3><p>仮想マシン内にインストールした Log Analytics のエージェントから定期的に Azure 基盤通信を行い、仮想マシンが正常かどうか確認します。特定の期間、仮想マシンからの通信が途絶えた場合に、アラートが発報されます。仮想マシン内で発生したや通信断等の問題を検知できる一方で、エージェントの不具合やAzure 基盤側のワイヤーサーバー側が原因となってアラートが誤発報されることもあります。また、Log Analytics では OS 内のメトリック（メモリ使用率や CPU 使用率等）をトリガーとしてアラートを発報することも可能です。ハートビート監視の設定手順については、下記のドキュメント内の「Q. データ収集が停止したときに通知を受けるにはどうすればよいですか?」の項目を参照ください。</p><blockquote><p>Log Analytics についてよく寄せられる質問<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/platform/log-faq#q-how-can-i-be-notified-when-data-collection-stops" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/azure-monitor/platform/log-faq#q-how-can-i-be-notified-when-data-collection-stops</a></p></blockquote><h2 id="アラート作成前に"><a href="#アラート作成前に" class="headerlink" title="アラート作成前に"></a>アラート作成前に</h2><p>前提として、現段階ではアラートはポータルから作成することはできず、 Resource Manager テンプレートをデプロイして作成する必要があります。テンプレート内容やデプロイ手順の詳細は下記ドキュメントを参考ください。</p><blockquote><p>Resource Manager テンプレートを使用して Resource Health アラートを構成する<br><a href="https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-alert-arm-template-guide" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-alert-arm-template-guide</a></p></blockquote><h3 id="■-Azure-PowerShell-のインストール"><a href="#■-Azure-PowerShell-のインストール" class="headerlink" title="■ Azure PowerShell のインストール"></a>■ Azure PowerShell のインストール</h3><p>テンプレートは Azure PowerShell というモジュールを用いてデプロイを行います。そのため、Azure PowerShell が既に導入されている Cloud shell で代用いただくか、下記のドキュメントよりお手元の環境にインストールください。</p><blockquote><p>Azure Cloud Shell の概要<br><a href="https://docs.microsoft.com/ja-jp/azure/cloud-shell/overview" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cloud-shell/overview</a></p></blockquote><blockquote><p>Azure PowerShell モジュールのインストール<br><a href="https://docs.microsoft.com/ja-jp/powershell/azure/install-Az-ps?view=azps-3.1.0" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/powershell/azure/install-Az-ps?view=azps-3.1.0</a></p></blockquote><h3 id="■-アクション-グループの作成"><a href="#■-アクション-グループの作成" class="headerlink" title="■ アクション グループの作成"></a>■ アクション グループの作成</h3><p>本アラート作成前に、アクション グループというリソースを作成しておく必要があります。<br>アクショングループはアラートのトリガーを満たした際に、何処の宛先にどういった通知を行うかを登録しておくリソースとなります。<br>作成手順については下記ドキュメントをご確認ください。</p><h2 id="JSONテンプレートの内容について"><a href="#JSONテンプレートの内容について" class="headerlink" title="JSONテンプレートの内容について"></a>JSONテンプレートの内容について</h2><p>リソース正常性アラート設定について、公開ドキュメントの補足、Json 内の各パラメータについて自分流にカスタマイズを行うにあたってのポイントを記載します。まずは、公開ドキュメント内の「Resource Health アラートの Resource Manager テンプレート オプション」のテンプレートを参考にして参考にしましょう。手を加える必要のある部分についてそれぞれ説明します。</p><h3 id="■-スコープ-“scopes”"><a href="#■-スコープ-“scopes”" class="headerlink" title="■ スコープ(“scopes”)"></a>■ スコープ(“scopes”)</h3><p>本項目で、対象とするリソースを選択します。規定ではサブスクリプション内の（リソース正常性が確認できる）リソース全てを対象としていますが、リソースグループ単位で対象を選択することができます。リソースは下記のように指定ください。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;scopes&quot;: [</span><br><span class="line">#リソースグループをスコープとした場合</span><br><span class="line">&quot;&#x2F;subscriptions&#x2F;\&lt;subscription id&gt;&#x2F;resourcegroups&#x2F;\&lt;resource group&gt;&quot;</span><br><span class="line"></span><br><span class="line">#1つのリソースをスコープとした場合</span><br><span class="line">&quot;&#x2F;subscriptions&#x2F;\&lt;subscription id&gt;&#x2F;resourcegroups&#x2F;\&lt;resource group&gt;&#x2F;providers&#x2F;&lt;resource&gt;&quot;</span><br><span class="line"></span><br><span class="line">#サブスクリプション全体をスコープとした場合</span><br><span class="line">&quot;&#x2F;subscriptions&#x2F;\&lt;subscription id&gt;&quot;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>providers 以下の項目は、Azure ポータルにてリソースのプロパティ内画面を確認いただき、“リソース ID” の項目から引用ください。</p><p>#抜粋例<br><img src="/blog/vm/resource-health-alert/resoruceid.png" alt=""></p><p>また、サブスクリプションやリソースグループ単位でアラートを設定する場合、特定のサービスからのみ通知を受け取りたい場合には、「アラートを生成するリソースの種類の調整」の項目に従って、受け取るサービスを指定ください。</p><h3 id="■-発報のトリガー-リソースの状態-“condition”"><a href="#■-発報のトリガー-リソースの状態-“condition”" class="headerlink" title="■ 発報のトリガー / リソースの状態 (“condition”)"></a>■ 発報のトリガー / リソースの状態 (“condition”)</h3><h4 id="▼-発報のトリガーについて"><a href="#▼-発報のトリガーについて" class="headerlink" title="▼ 発報のトリガーについて"></a>▼ 発報のトリガーについて</h4><p>アラートはリソースのステータス（<strong>Available</strong> / <strong>Unavailable</strong> 等）の変化（<strong>Active</strong> や <strong>Resolved</strong> 等）をトリガーとして発報されます。リソース正常性の変更が発生したタイミング、解消したタイミングでアラートを受け取るために <strong>Active</strong> および  <strong>Resolved</strong> のみをスコープに含めます。 <strong>Update</strong> / <strong>In Progress</strong> は問題の継続中に常に出力されるステータスなので、取得することは推奨しません。 <strong>Degraded</strong> の項目は Storage Account 等の可用性が下がり、一部のアクセスに失敗する際などに発生しますが、仮想マシンの場合に、このステータスが発生することはありません。</p><h4 id="▼-Unkown-状態について"><a href="#▼-Unkown-状態について" class="headerlink" title="▼ Unkown 状態について"></a>▼ Unkown 状態について</h4><p>リソース正常性には Azure 基盤側から仮想マシンまでの正常性が一時的に確認ができない際に表記される <strong>Unknown</strong> という状態があります。 <strong>Unknown</strong> 状態となった際にも、リソース正常性のトリガーは <strong>Active</strong> となり、<strong>Active</strong> をトリガーとしていた状態ではアラートが発報されます。 <strong>Unknown</strong> は基盤側にて問題が発生していない場合にも発生することがあるため、正確なアラートを受け取るためには、<strong>Unknown</strong> 時にアラートが発報されないように設定しておくことが無難です。<br>アラートが <strong>Active</strong> / <strong>Resolved</strong> で、且つ前回 / 現在の仮想マシンの状態が　<strong>Available</strong>　や <strong>Unavailable</strong> であるときにアラートを発生するように指定しておきましょう。（前述の通り、仮想マシンに関しては <strong>Degraded</strong> は発生しないため、こちらは記載してもしなくても大丈夫です。）</p><p>記載の方法については、「”Unknown” イベントを回避するための Resource Health アラートの調整」/ 「完全な Resource Health アラート テンプレート」の項目にて記載されているロジックを参考ください。</p><h4 id="▼-発生起因の指定について"><a href="#▼-発生起因の指定について" class="headerlink" title="▼ 発生起因の指定について"></a>▼ 発生起因の指定について</h4><p><strong>properties.cause</strong> の項目では、原因となるトリガーの発生起因について、指定することができます。  <strong>PlatformInitiated</strong>  と指定することで、基盤側の障害発生時のみアラート対象とすることができます。一方、<strong>UserInitiated</strong> と指定することで、ユーザー起因の操作（停止 / 再起動 / OS 内再起動 等）でアラートが発報されます。<strong>PlatformInitiated</strong> を指定しない場合には、どちらが原因でもアラートが発報されることとなります。記載手順は、「ユーザーが開始したイベントを回避するためのアラートの調整」の項目を参照ください。</p><p>テンプレートが完了したらドキュメント内の ”Instructions”  の項目に従って Azure PowerShell からデプロイを行います。ProvisioningState が Succeeded であれば、作成が正常に完了しています。（アラートが適用されるまで 5 分程度かかる可能性があります。）</p><h3 id="■-発報されるアラートのサンプル"><a href="#■-発報されるアラートのサンプル" class="headerlink" title="■ 発報されるアラートのサンプル"></a>■ 発報されるアラートのサンプル</h3><p>アラートが発報されると下記画像のようなアラートが <a href="mailto:azure-noreply@microsoft.com">azure-noreply@microsoft.com</a> から届きます。</p><p><img src="/blog/vm/resource-health-alert/sample.png" alt=""></p><p>上記のサンプルでは対象の仮想マシン （”Resource ID”  に記載）が使用可能状態<font color="Lightblue">（青下線部）</font>から使用不可の状態<font color="red">（赤下線部）</font>に変更されたこと。ユーザーの操作<font color="green">（緑下線部）</font>による発生であることが記載されております。（基盤側の問題の場合には、<strong>PlatformInitiated</strong>  となることが想定されます。）</p><h3 id="■-アラートのテストについて"><a href="#■-アラートのテストについて" class="headerlink" title="■ アラートのテストについて"></a>■ アラートのテストについて</h3><p>残念ながら、現段階で意図的に Azure 基盤の障害を再現することはできません。そのため、 <strong>UserInitiated</strong>  をトリガーに加えた上で、仮想マシンを Azure ポータルから停止 / 起動等、一時的に使用不可能の状態を作りアラートが発報されるか確認ください。</p><h3 id="■-アラートの停止-削除について"><a href="#■-アラートの停止-削除について" class="headerlink" title="■ アラートの停止 / 削除について"></a>■ アラートの停止 / 削除について</h3><p>アラートの停止 / 削除 / 再有効化については、Azure ポータルから行うことが可能です。</p><p>Azure ポータル　＞　Azure Monitor　＞　アラート　＞　アラート ルールの管理　＞　対象のアラートを選択　＞　無効化 / 削除 / 再有効化</p><p>※画像例<br><img src="/blog/vm/resource-health-alert/delete.png" alt=""></p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>アラートには最低限の情報しか記載されないため、発生した事象のより詳細な切り分け・調査報告等が必要な場合には、Azure Portal より弊サポート部門へのお問い合わせを起票ください。  <br></p><p>以上、ご参考となれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの安田です。&lt;/p&gt;
&lt;p&gt;「Azure 基盤側の障害によって仮想マシンが ダウン / 復旧 した際に通知を受け取りたい。」&lt;br&gt;サポート業務をしていてそういったご要望をよくいただきます。&lt;br&gt;そこで今回は、リソース正
      
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Resource Health" scheme="https://jpaztech.github.io/blog/tags/Resource-Health/"/>
    
  </entry>
  
  <entry>
    <title>なぜ今サポートエンジニアが熱いか</title>
    <link href="https://jpaztech.github.io/blog/other/technical_support_engineer_explained/"/>
    <id>https://jpaztech.github.io/blog/other/technical_support_engineer_explained/</id>
    <published>2019-12-05T04:00:00.000Z</published>
    <updated>2020-08-18T00:45:29.881Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、マイクロソフトの石井 哲平です。<br>2007年に新卒でマイクロソフトのサポートエンジニアとして入社をし、長らくエンジニアを楽しんで来ました。<br>2018 年より、サポートエンジニアのチームでマネージャー職をしています。</p><p>サポートエンジニアという職業に魅力を感じ、都度サポートエンジニアであることを選び続けてきたという自負はありますが、あらためて、マネージャーという職について、その価値の言語化が必要だと感じた次第です。<br>サポートエンジニアって何？という方に知ってもらいたい。<br>あるいは、今サポートエンジニアだよという方、自信を持ちましょう！<br>そういう気持ちを込めて書いていきます。</p><p>極力一般化して書きたい部分ではありますが、経験上、部分部分でマイクロソフトに言及する点はあらかじめご了承ください。</p><h2 id="サポートエンジニアの仕事とは"><a href="#サポートエンジニアの仕事とは" class="headerlink" title="サポートエンジニアの仕事とは"></a>サポートエンジニアの仕事とは</h2><p>技術職です。IT (ソフトウェア、ハードウェア) 関連の技術を持って、お客様のお困りごとを解決するというサポートです。</p><p>私の5歳の子供には、「<u>コンピューターのお医者さんだよ</u>」と伝えています。医者や弁護士に負けないぐらい、日々専門知識を研鑽し、社会に役立つという側面では合っていると思います。</p><p>プログラマーやSIerさんとの違いは、トラブルシュートに重きが置かれている点でしょう。担当製品によってソースコードを読む・ネットワークパケットを分析する・デバッグをするといったことはありますが、プログラミングをすることが主業務ではありません。顧客と直接の電話・メール、あるいはチャット等を駆使して、問題点をヒアリング、到達目標を交渉します。このソフトスキルも重要となる点が大きな違いです。</p><p>コールセンターとの違いは、ある範囲の製品群・機能群にオーナーシップを持ち、調査と回答の責任を有するということです。企業によって、「初動をとり簡単な案件を対応するフロント・難しい案件の詳細調査を行うバックエンド」の分類がある場合があります。(マイクロソフトではこの分類はほぼ存在しません。) また、クレームを聞くだけ、というケースも非常に少ないです。技術力があること、そして会社の中でも製品へのフィードバックが出来る部署であるが故、技術的なソリューションや、今後の製品としてのロードマップなど、何らしか未来に繋げることが出来ることが多いためです。</p><p>私の主観が入ってしまいますが、様々にある仕事の中で、「目の前のお客様を助けてあげたい、そのために何ができるだろう」ということだけに真剣になれるということがとても響きます。お給料以外のところで、自分の社会的な価値が実感できる部分です。「何千万円の商談」「何百人の聴衆の前でプレゼン」といった派手さはなく、あくまで1人1人のお客様と向き合っての地道なやりとりですが、確かに「必要とされ、時に感謝していただける」という温度感がわかるものでした。</p><h2 id="なぜ今サポートが熱いか"><a href="#なぜ今サポートが熱いか" class="headerlink" title="なぜ今サポートが熱いか"></a>なぜ今サポートが熱いか</h2><p><u>皆さん、Youtubeを見ますか？</u>広告が出ますが、そのときにどのように感じるでしょうか。中には面白いものがあって、うっかり全部見てしまうようなこともあるでしょう。一方で、いかなる内容であれ、実際に見たいコンテンツではないものが強制的に表示され、時間が奪われてしまうわけですから、多少なりとも「鬱陶しい」「時間の無駄」「広告をスキップはよ」といったネガティブな感情を抱くことがあるのではないでしょうか。</p><p>企業は莫大な費用を払って、少しでも多くの人に商品や企業イメージの良さを伝えたいという一心でこれを行っていますが、必ずしもこれを広範に行うということが、個々人にとっての良い印象に繋がるわけではありません。</p><p>他方、サポートとはどういうものでしょうか。最初は「せっかく製品を買ったのに、問題があった、どうしてくれるんだ？」という<u>最悪の印象</u>からスタートします。問題が解消しなければ、その悪い印象を拭い去ることは難しいかもしれません。しかしながら、<u>時に何時間、何日といった期間、サポート担当者がその問題に向き合い、要望をしっかり聞いてくれる。</u>この体験を通じて、「<u>この会社、信頼出来るな。今回はちょっと苦労したけど、また次も使ってあげよう。</u>」という気持ちになる。</p><p>15秒のCMを我慢できない一方で、トラブルに対して何時間も付き合った結果、この時間のかけ方とはかけ離れた信頼関係に繋がるチャンスがあります。</p><p>※「ザッポス伝説」(トニー・シェイ著)という書籍もオススメです。サポートサービスの重要性、サービスを提供する人間の価値について書かれています。ひいては、サポートを提供する人間が「他者を幸福にする」という文化を持つことがいかに大事なのか、というような内容です。</p><p>現在、クラウドに限らず多くの業界がサブスクリプション ビジネスです。常に信頼と魅力を伝えていかないといけない中、サポートがどのような役割を担うのかという観点で見るとその重要性が分かります。</p><p>マイクロソフトでは、パブリッククラウドの世界一を目指して強烈に力を入れています。クラウドでは、「やーめた！乗り換えよう」が簡単にできる世界です。お客様となる企業は、製品の機能リストを見て比べているわけではなく、信頼を出来る会社かどうかを見ています。「自社のデータを置いてもいいのか？撤退しない？」「自社が使っている機能で問題が出たらさじを投げるのではないか」「お客様のことを見てくれているのか？自分たちに都合がよいように、儲かるものだけを続けて他を捨てるといったことがないか」このような不信感を拭うのは、CMでも現在の華々しい機能リストでもありません。サポート、ひいては「お客様を大事にする文化」です。サポートは、エンジニアとお客様、一対一のやりとりを通じてこれを行います。</p><p>本当に困ったとき、トラブったときこそ、人の本性が出るといいます。ここで粘り強く解決に向けて対応ができるかどうかが、そのお客様にとっての最後の砦ということです。</p><h2 id="サポートエンジニアで伸びる能力と価値"><a href="#サポートエンジニアで伸びる能力と価値" class="headerlink" title="サポートエンジニアで伸びる能力と価値"></a>サポートエンジニアで伸びる能力と価値</h2><p><strong>１. 技術力</strong> - 当然のことながら、特定の製品については内部的なドキュメント、トレーニング資料、データセンターに残るデータ分析、日々様々な角度からのお問い合わせを通じて圧倒的な速度で成長します。マイクロソフトでは、開発部門も多くは Dev&amp;Ops で運用していますので、現在進行形で仕様を把握し判断できる開発部門と問題について協議をすることも出来ます。彼らが、その製品の業界事情などをどのように見ているかが垣間見れる点も面白いところです。</p><p><strong>２．問題解決力</strong> – お客様からのお問い合わせは、その文面通り回答すればハッピー、というわけにはいきません。テック、ソフト、両面から問題を聞き混み、どのように力になれるのかということを考えます。マイクロソフトに限らずだと思いますが、メーカーのサポートは、「こうすれば万事OK」というソリューションがない世界です。大小様々な企業で、自社独自の製品の問題をどのように解決していくか、ということを試行錯誤しています。<u>プログラムを書いて新製品を生み出しているわけではありませんが、この世界の誰もがやったことのない、未知の世界で頑張っているわけです。</u>マイクロソフトはそれはもう特に顕著で、「パブリッククラウド特有の問題」「クラウド＋オンプレミスの複雑な問題」「インフラ、Windows、OSS、Office等々の異なる製品とそのカルチャーの混在」などなど、うまくいかないことを手探りでやり、お客様にとって今できるベストとは？を考えています。とてもクリエイティブな仕事です。</p><p><strong>３．チームワーク</strong> – もはや、1人のスーパーエンジニアが何もかも把握している、ということは不可能です。新人でも二ヶ月もすれば、その人しかしらない知識と経験が存在するでしょう。(そもそも、一部の限られた超人がいて、それに頼ったとしても、世界中で急速に成長するクラウドの領域において、スケールするのでしょうか。) このため、チームワークが何よりも大事です。マイクロソフトでは、Swarming (スウォーミング) というオペレーションを促進しており、これは、案件ごとに異なるテクノロジーを担当する複数のエンジニアを招集して、「問題解決チーム」を作りましょう、という文化であり仕組みです。このため、案件のオーナーは、知らない領域であっても、その問題にヘルプになる人間を集めるというリーダーシップをとる練習になりますし、何より、広域な問題について打ち込むという経験を積めるということになります。サポートエンジニアとして、特定の製品群に詳しいけども、さらに未知の様々な製品が関連した問題にもアプローチが出来るようになる、ということです。</p><p><strong>４．個人の価値と認知度</strong> – サポートエンジニアの仕事の多くは、日々お客様の困りごとを解決することです。しかしながら、今後は、個人としての価値も上げていく時代です。積み上げてきたナレッジを基に、情報を発信する (本を書く・イベントで登壇する)、社内外でコミュニティを築く、といったことに目を向けると、個人としての価値もより有形になってくるでしょう。</p><p><strong>５．英語力</strong> - 外資系企業の場合、日々、開発部門との連携において英語でやりとりをします。多くは読み書きでなんとかなりますが、興味があれば Teams で電話をしてみてもよいでしょう。かつて、外資系企業では、ミーティングで発言をしない参加者は無価値である、といった事が言われていましたが、今は時代が変わっています。Diversity &amp; Inclusion (D&amp;I) といった言葉がありますが、これはいわゆる女性採用に限らず、様々な文化圏、価値観がある人を尊重し、全員の意見を漏らさないようにしましょうということです。このため、特に社内の英語のオンライン会議では、「What else?(他には?)」というキーワードが飛び出し、完全な沈黙が続かない限り誰かがしゃべるタイミングを設けるということが増えてきました。ミーティングの後「英語が早くてしゃべりにくかったでしょ？後でメールしてもらったら、私が代わりに皆に伝えておくよ」といった個別の声がかかることがあります。技術的なやりとりでは、画面を共有して「THIS! THIS!ストレンジ！エラー！」と叫び続けることでなんとか相手に問題を伝えたらなんとかなるということも。相手も同じチームなわけですから、「これはまずい問題がおきているな。こっちで人をかきあつめて直しておくから、アップデートを待っててくれよ。」という感じで、オーナーシップを引き取ってくれることも。世界のエンジニアと協力して、お客様の問題が解決できたとしたら、カッコよすぎませんか？たぶんその日はスキップして家に帰ると思います。</p><p>最後に、サポートエンジニアそれぞれの心の持ち方も重要です。一部では、「過去にやったことのある、既知の問題について対応する案件はつまらなく飽きてしまう」という声を聞きます。程度の問題ではありますが、私はそうは思いません。あらゆるお客様について、腑に落ちていない点や、それを踏まえた説明の仕方は異なります。サポートエンジニアは、(少なくともマイクロソフトでは) 技術的な回答をすることは必要最低限の仕事であり、その先にある信頼の獲得がゴールです。お客様ごとに異なる特徴と、コミュニケーションにおける差が必ずあり、それに真摯に向き合った先には必ず自分、ひいては組織の成長があるはずです。</p><h2 id="転職-サポートエンジニア-→-他社のサポートエンジニア"><a href="#転職-サポートエンジニア-→-他社のサポートエンジニア" class="headerlink" title="転職: サポートエンジニア → 他社のサポートエンジニア"></a>転職: サポートエンジニア → 他社のサポートエンジニア</h2><p>同じサポートエンジニアという業務形態はそのままで、他の会社にいく必要性、これは3つほど理由があります。</p><h3 id="サポートに脚光があたり、投資がしっかりしている「報われる職場」を選ぶ"><a href="#サポートに脚光があたり、投資がしっかりしている「報われる職場」を選ぶ" class="headerlink" title="サポートに脚光があたり、投資がしっかりしている「報われる職場」を選ぶ"></a>サポートに脚光があたり、投資がしっかりしている「報われる職場」を選ぶ</h3><p>既にサポートエンジニア職についている技術者が、他のサポートエンジニア職に応募するとしたら、やはり<u>サポートに脚光があたり、投資がしっかりしている所を探す</u>のがよいでしょう。業界としてスポットライトが当たっている、口コミ、色々とあると思います。<br>サポート業務は、時と場合によっては「コストセンター」という扱いになります。新製品を開発し、販売するというプロフィット (利益) センターに対して、コストがかかるだけの組織、という見方ですね。そうなると、コストカットとなると少ない人員で、より短い解決時間でといった余計な達成目標が設定されてしまいます。コストとは非常にアンフェアな言い方だと思います。営業だってプログラマーだってコストは生じているでしょうに、会社によっては一部の組織に対してのみ、そう認識されてしまうようです。マイクロソフトも、私が入社した12年前はそう呼んでいましたが、カスタマーサービスの重要性に気付いてからはめっきりそのような呼ばれ方はしなくなりました。今や、製品の印象や将来を担う重要なドライバーという位置づけです。</p><p>サポートの声を会社として聞く気があるのか、ということにも繋がります。お客様の声を、よかれと思って開発部門に伝えて、それが反映されるかどうか。</p><p>是非、サポートエンジニアが輝ける職場を求められることをお勧めします。そして、今そういう場所にいるよ、という方は、あらためてその価値を再認識してほしいです。</p><h3 id="成長ができる企業文化を選ぶ"><a href="#成長ができる企業文化を選ぶ" class="headerlink" title="成長ができる企業文化を選ぶ"></a>成長ができる企業文化を選ぶ</h3><p>無駄なルールが無い合理性、人間としての成長、お互い尊敬をしあえる仲間、お客様や仲間の成功を喜ぶ、そういったものは、共通の価値観となる企業文化にて醸成されるものです。多くの企業がそういった素晴らしい企業文化を持っていると思いますが、そういった根本的な価値観 (コア バリュー) に変化を持たせるという観点で転職してみることも良いかもしれません。</p><p>マイクロソフトでは、「Growth Mindset(成長する考え方)」を根幹においてます。前述のとおり、世界最大規模のクラウドの構築・運用・サポート・営業、全てにおいて、手探りであり、今の時点での正解はありません。常に「あれがないこれがない」という世界で、成長に繋げられるようにという思いがあります。また、様々な部署・国・価値観によって構成される人間が手をとりあって成功に繋げられるよう、「お客様」を共通のキーワードにしています。外資ですが、なんとなくイメージされるような激しい競争、ライバルとの蹴落としあい、といったものとは正反対の文化です。</p><h3 id="スキルが伸びる職場を選ぶ"><a href="#スキルが伸びる職場を選ぶ" class="headerlink" title="スキルが伸びる職場を選ぶ"></a>スキルが伸びる職場を選ぶ</h3><p>ソフトスキル、技術スキル問わず、成長が行き詰まるということは、エンジニアを続ける上で危険信号です。日々、何かを覚えて成長したなという実感がありますか。無ければ、次のステージに行くきっかけかもしれません。</p><p>「決まったマニュアルを試したらすぐにバックエンド部隊に投げる」「深い調査権限を持たせてもらえない」このあたりに不満がある場合に、現職にて解決策が無いのであれば、是非外にも目を向けてみてください。</p><h2 id="転職-他の技術職-→-サポートエンジニア"><a href="#転職-他の技術職-→-サポートエンジニア" class="headerlink" title="転職: 他の技術職 → サポートエンジニア"></a>転職: 他の技術職 → サポートエンジニア</h2><p>前述のサポートエンジニア → 他社のサポートエンジニアの部分とも多くが共通します。加えるなら、他業種からのサポートエンジニアへの転向は、結局のところ、技術者である前に、「目の前で困っている人がいたら助けたいか」に興味が持てなければなりません。その点を除いては、おそらく IT 関係の技術職でしっかり研鑽を積んできたのであれば活躍できるでしょう。</p><p>さらに、「サポートエンジニアで伸びる能力と価値」の項に記載した領域に興味があれば、それは立派な「次のキャリアステップ」になります。</p><h2 id="キャリアプラン-サポートからさらに先の転職"><a href="#キャリアプラン-サポートからさらに先の転職" class="headerlink" title="キャリアプラン - サポートからさらに先の転職"></a>キャリアプラン - サポートからさらに先の転職</h2><p>サポートエンジニアとして、日々お客様の声を聞き、チームワークと技術力を発揮して解決する。それまでに身を置いてきた現場がチャレンジングであればあるほど、このスキルセットにかけ算で魅力が追加されるでしょう。</p><p>アーキテクトやプリセールス ロールに行って重宝されたという話も聞きます。お客様の目線や問題を抑止したいという目線も持ちうる開発者になる人もいます。</p><p>お客様の環境での Good / Bad Example を沢山目にしますから、SIer としてのさらに高度なロールにいくことも可能でしょう。</p><p>マイクロソフトでも、広範にわたる役職があります。営業職・データセンター運営・開発職・アカウントマネージャー・管理職・他の製品のサポートetc。マイクロソフトは幸い、会社自体が「Customer Obsession」(顧客への執着) というほどのお客様志向をかかげていますから、サポート出身者でこのマインドで負けることはありません。</p><h2 id="補足-マイクロソフトでは面接で何を見るか"><a href="#補足-マイクロソフトでは面接で何を見るか" class="headerlink" title="補足: マイクロソフトでは面接で何を見るか"></a>補足: マイクロソフトでは面接で何を見るか</h2><p>マイクロソフトでは、Growth Mindset (成長する考え方) というものを尊重しています。今できることをやるのではなく、今できないことについてどのようにして出来るようになるのか、そのアプローチ努力して継続し、効果的にプランすることが重要です。</p><p>面接でも、経験やスキルセットも見るには見るのですが、どちらかというと我々が知りたいのは「この人は、知らないことについてどのようにアプローチして、身につけるのだろう？(これまで身につけてきたのだろう？)」ということです。Azure のように、年間何十という機能追加や変更が行われる世界では、今持っているものだけではその人の適性は図れません。(前述のように、お客様はクラウドという製品を買うのではなく、信頼性を買うのだ、というのとちょっと似ていますね)</p><p>また、こう言ってしまうとなんですが、私達、特にエンジニアが面接する場合、彼らは面接という技術のプロではありません。ですので、面接中の質問に対して答えを持っていない場合も、是非、臆さず双方向にコミュニケーションを取ってみてください。</p><p>「何故そのような質問をするのでしょうか」と深掘りをしてみましょう。</p><p>面接官となるエンジニアも、おそらく技術力をみたい、その一心だと思います。質問には直接わからないけど、それに近い何かを深く追求したことに自信があれば、そちらに誘導してみてもよいでしょう。<u>その質問をしているのがお客様だったとしたら？</u>「分からないです、すいません・・・」と暗い雰囲気で終わらせるのではなく、建設的な、未来を向いたアプローチがあるはずです。</p><p>「その技術について直接はわからないけど、○○という情報を参照することで答えられます。」「私の知識の中で、類似するこういうものがあり、それに近い考え方だとすると～」といった会話を極力繋いでみましょう。</p><h2 id="宣伝-マイクロソフトのサポートエンジニア募集中"><a href="#宣伝-マイクロソフトのサポートエンジニア募集中" class="headerlink" title="宣伝: マイクロソフトのサポートエンジニア募集中"></a>宣伝: マイクロソフトのサポートエンジニア募集中</h2><p>現在、マイクロソフトのサポート職を募集しています。この項、あるいは私の LinkedIn では、募集要項や採用イベントがありましたらお伝えしていきます。</p><p>私のチームでは、Azure の Networking 分野で募集しています。IaaS/インフラ/ネットワークあたりのキーワードが刺さる方は是非ご検討下さい。</p><p>Support Escalation Engineer - Azure Networking (複数枠有り！)<br><a href="https://careers.microsoft.com/i/us/en/job/715208/Support-Escalation-Engineer-Azure-Networking" target="_blank" rel="noopener">https://careers.microsoft.com/i/us/en/job/715208/Support-Escalation-Engineer-Azure-Networking</a></p><p>他にも、様々なエリアで募集がありますので、もし興味がありましたら、是非「石井の LinkedIn を見たよ」と記載下さい。直接のご相談も Welcome です。</p><p>私のチームに限らず、マイクロソフトのサポートとして、少しでもチャンスに繋げられるようご協力させていただきます。</p><iframe width="560" height="315" src="https://www.youtube.com/embed/yThRRLBnxJ4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、マイクロソフトの石井 哲平です。&lt;br&gt;2007年に新卒でマイクロソフトのサポートエンジニアとして入社をし、長らくエンジニアを楽しんで来ました。&lt;br&gt;2018 年より、サポートエンジニアのチームでマネージャー職をしています。&lt;/p&gt;
&lt;p&gt;サポートエンジニアと
      
    
    </summary>
    
    
    
      <category term="Other" scheme="https://jpaztech.github.io/blog/tags/Other/"/>
    
      <category term="Support Explained" scheme="https://jpaztech.github.io/blog/tags/Support-Explained/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft ピアリングを経由するかどうかの確認方法</title>
    <link href="https://jpaztech.github.io/blog/network/judge-via-ms-peering/"/>
    <id>https://jpaztech.github.io/blog/network/judge-via-ms-peering/</id>
    <published>2019-11-26T08:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.877Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの山崎です。<br>今回は対象の通信が Microsoft ピアリングを経由するかどうかの確認方法についてご紹介します。</p><h2 id="Microsoft-ピアリングで広報される経路について"><a href="#Microsoft-ピアリングで広報される経路について" class="headerlink" title="Microsoft ピアリングで広報される経路について"></a>Microsoft ピアリングで広報される経路について</h2><p>ExpressRoute の Microsoft ピアリングをご利用の場合、ルートフィルターの設定でどのような経路を広報するかを設定します。</p><p><strong>(ルートフィルターの設定画面 - Azure ポータル)</strong><br><img src="/blog/network/judge-via-ms-peering/judge-via-ms-peering-01.png" alt=""> </p><p><strong>(実行コマンド)</strong><br>各サービスコミュニティで広報される経路については以下の PowerShell コマンドからご確認いただけます。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-AzBgpServiceCommunity</span><br></pre></td></tr></table></figure><p><strong>(出力例)</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">Name           : Exchange</span><br><span class="line">Id             : &#x2F;subscriptions&#x2F;&#x2F;resourceGroups&#x2F;&#x2F;providers&#x2F;Microsoft.Network&#x2F;bgpServiceCommunities&#x2F;Exchange</span><br><span class="line">Type           : Microsoft.Network&#x2F;bgpServiceCommunities</span><br><span class="line">BgpCommunities : [</span><br><span class="line">                   &#123;</span><br><span class="line">                     &quot;ServiceSupportedRegion&quot;: &quot;Global&quot;,</span><br><span class="line">                     &quot;CommunityName&quot;: &quot;Exchange&quot;,</span><br><span class="line">                     &quot;CommunityValue&quot;: &quot;12076:5010&quot;,</span><br><span class="line">                     &quot;CommunityPrefixes&quot;: [</span><br><span class="line">                       &quot;13.107.6.152&#x2F;31&quot;,</span><br><span class="line">                       &quot;13.107.18.10&#x2F;31&quot;,</span><br><span class="line">                       &quot;13.107.128.0&#x2F;22&quot;,</span><br><span class="line">                       &quot;23.103.160.0&#x2F;20&quot;,</span><br><span class="line">                       &quot;40.92.0.0&#x2F;15&quot;,</span><br><span class="line">                       &quot;40.96.0.0&#x2F;13&quot;,</span><br><span class="line">                       &quot;40.104.0.0&#x2F;15&quot;,</span><br><span class="line">                       &quot;40.107.0.0&#x2F;16&quot;,</span><br><span class="line">                       &quot;52.96.0.0&#x2F;14&quot;,</span><br><span class="line">                       &quot;52.100.0.0&#x2F;14&quot;,</span><br><span class="line">                       &quot;52.238.78.88&#x2F;32&quot;,</span><br><span class="line">                       &quot;104.47.0.0&#x2F;17&quot;,</span><br><span class="line">                       &quot;131.253.33.215&#x2F;32&quot;,</span><br><span class="line">                       &quot;132.245.0.0&#x2F;16&quot;,</span><br><span class="line">                       &quot;150.171.32.0&#x2F;22&quot;,</span><br><span class="line">                       &quot;191.234.140.0&#x2F;22&quot;,</span><br><span class="line">                       &quot;204.79.197.215&#x2F;32&quot;,</span><br><span class="line">                       &quot;13.107.128.0&#x2F;24&quot;,</span><br><span class="line">                       &quot;13.107.129.0&#x2F;24&quot;,</span><br><span class="line">                       &quot;150.171.32.0&#x2F;24&quot;,</span><br><span class="line">                       &quot;150.171.34.0&#x2F;24&quot;,</span><br><span class="line">                       &quot;150.171.35.0&#x2F;24&quot;,</span><br><span class="line">                       &quot;52.96.38.0&#x2F;24&quot;</span><br><span class="line">                     ],</span><br><span class="line">                     &quot;IsAuthorizedToUse&quot;: false,</span><br><span class="line">                     &quot;ServiceGroup&quot;: &quot;O365&quot;</span><br><span class="line">                   &#125;</span><br><span class="line">                 ]</span><br><span class="line"></span><br><span class="line">Name           : OtherOffice365Services</span><br><span class="line">Id             : &#x2F;subscriptions&#x2F;&#x2F;resourceGroups&#x2F;&#x2F;providers&#x2F;Microsoft.Network&#x2F;bgpServiceCommunities&#x2F;OtherOffice365Servic</span><br><span class="line">                 es</span><br><span class="line">Type           : Microsoft.Network&#x2F;bgpServiceCommunities</span><br><span class="line">BgpCommunities : [</span><br><span class="line">                   &#123;</span><br><span class="line">                     &quot;ServiceSupportedRegion&quot;: &quot;Global&quot;,</span><br><span class="line">                     &quot;CommunityName&quot;: &quot;Other Office 365 Services&quot;,</span><br><span class="line">                     &quot;CommunityValue&quot;: &quot;12076:5100&quot;,</span><br><span class="line">                     &quot;CommunityPrefixes&quot;: [</span><br><span class="line">                       &quot;13.80.125.22&#x2F;32&quot;,</span><br><span class="line">                       &quot;13.91.91.243&#x2F;32&quot;,</span><br><span class="line">                       &quot;13.106.4.128&#x2F;25&quot;,</span><br><span class="line">                       (... 省略)</span><br></pre></td></tr></table></figure><h2 id="宛先が-FQDN-の場合"><a href="#宛先が-FQDN-の場合" class="headerlink" title="宛先が FQDN の場合"></a>宛先が FQDN の場合</h2><p>通信対象が IP の場合、上記の手順で IP をご確認いただくことで対象のサービスコミュニティが確認可能で、ルートフィルターの設定状況により Microsoft ピアリングを経由するかどうかを確認することが可能です。また、各サービス毎に以下のようなドキュメントでも ExpressRoute の対応状況について記載がされています。</p><p>  [Office 365 の URL と IP アドレスの範囲]<br>  <a href="https://docs.microsoft.com/ja-jp/office365/enterprise/urls-and-ip-address-ranges" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/office365/enterprise/urls-and-ip-address-ranges</a></p><p>  [Azure ExpressRoute と Azure Site Recovery]<br>  <a href="https://docs.microsoft.com/ja-jp/azure/site-recovery/concepts-expressroute-with-site-recovery" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/site-recovery/concepts-expressroute-with-site-recovery</a></p><p>ドキュメントに記載がなく、対象が FQDN の場合には個別に調査が必要となります。Microsoft ピアリング観点としては IP を特定いただくことで経由、非経由が判断出来ますため、調査としては対象の FQDN に紐づく IP 情報についてご確認いただく必要がございます。</p><blockquote><p>対象の FQDN に紐づく IP アドレスの調査については FQDN が利用されるサービス毎に調査が必要となりますので、ご利用サービス宛てにお問い合わせをお願いします。</p></blockquote><p>対象の FQDN によっては IP が固定でわかる場合もあれば、情報公開されておらず不定の場合もあります。IP が明確に特定できないような場合には Internet 経由で通信できるようネットワークを構成いただければ幸いです。</p><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの山崎です。&lt;br&gt;今回は対象の通信が Microsoft ピアリングを経由するかどうかの確認方法についてご紹介します。&lt;/p&gt;
&lt;h2 id=&quot;Microsoft-ピアリングで広報される経路について&quot;&gt;&lt;a href=&quot;
      
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
  </entry>
  
  <entry>
    <title>Azure IaaS における有償 Azure テクニカル サポートの対応範囲</title>
    <link href="https://jpaztech.github.io/blog/other/azure_technical_support_explained/"/>
    <id>https://jpaztech.github.io/blog/other/azure_technical_support_explained/</id>
    <published>2019-11-20T08:30:00.000Z</published>
    <updated>2020-08-18T00:45:29.881Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。</p><p>Azure の IaaS 仮想マシンをご利用のお客様における、Azure の有償テクニカル サポート範囲と留意点について以下の通りご説明します。<br>本ドキュメントでは、課金・サブスクリプション サポートについては言及しません。<br>有償である Professional Developer, Professional Standard, Professional Direct, Premier サポートについてのみのご説明となります。</p><h2 id="Azure-サポートで提供しているサポート-プランと対応範囲"><a href="#Azure-サポートで提供しているサポート-プランと対応範囲" class="headerlink" title="Azure サポートで提供しているサポート プランと対応範囲"></a>Azure サポートで提供しているサポート プランと対応範囲</h2><p>Azure サポートにどのようなプランがあるのかや、その比較は以下をご参照ください。</p><p>ご参考: <a href="https://azure.microsoft.com/ja-jp/support/plans/" target="_blank" rel="noopener">Azure のサポート プランの比較</a></p><h2 id="障害対応-Break-fix-とアドバイザリの違いについて"><a href="#障害対応-Break-fix-とアドバイザリの違いについて" class="headerlink" title="障害対応 (Break/fix) とアドバイザリの違いについて"></a>障害対応 (Break/fix) とアドバイザリの違いについて</h2><p>Azure の有償テクニカル サポート、つまり Developer / Standard / Professional Direct / Premier のすべてにおいて、障害対応 (Break/fix) のサポートが提供されています。障害対応の定義は以下に記載がされています。</p><p>ご参考: <a href="https://azure.microsoft.com/ja-jp/support/faq/" target="_blank" rel="noopener">Azure サポートに関する FAQ</a></p><blockquote><p>障害対応の問題とは、Azure サービスの使用中に経験する技術的な問題です。”障害対応” という業界用語は、”あるテクノロジが正常に機能しなくなり、正常運転状態に復帰するためにサポート組織の介入が必要になった場合の、そのテクノロジをサポートする作業” を指します。</p></blockquote><p>「障害対応」に対して、アドバイザリとは、「障害対応以外」のご相談ごと、つまり手順確認 (ハウツー) やベスト プラクティスの提供といった範囲でのご質問内容となります。</p><p>このアドバイザリ サービスは Professional Direct 契約もしくは Premier サポート契約のみで利用可能となります。Premier サポートでは、マイクロソフトから提供されている、有償サポート対応の製品がすべてサポート対応範囲となりますが、Azure の Professional Direct サポートでは Azure 側の内容のみのサポートが提供されます。</p><p>つまり、Azure ではないマイクロソフト製品、例えば Windows や SQL Server 製品などの設定方法、構築手順、仕様確認といった内容については Premier サポート契約が必要です。<br>一方、Professional Direct では、Azure 基盤側の設定方法などについては、公開情報をベースに調査し、回答させていただくことが可能です。</p><p>Professional Direct と Premier においては、アドバイザリの提供範囲も異なります。Azure サポートに関する FAQから抜粋しますと、以下の通りです。</p><blockquote><p>Q. Premier Advisory サポートと比較して、Professional Direct Limited Advisory サポートではどのようなサポートを提供していますか？</p></blockquote><blockquote><p>A. Professional Direct (ProDirect) Advisory サポートは、(1) Microsoft Azure に関して一般に公開されているベスト プラクティスのドキュメント、および (2) Azure フォーラムからの情報に基づいて、Azure サポート ガイダンスへのアクセスを提供するものです。 ProDirect のアドバイザーは、マイクロソフト関連のドキュメント、Microsoft Azure サポート エンジニア、および Microsoft Azure 製品グループへの各自のアクセスに基づいて、サポートを提供します。 ベスト プラクティス ガイダンスには、例として、以下のものがあります。</p></blockquote><h2 id="お問い合わせの重要度・緊急対応について"><a href="#お問い合わせの重要度・緊急対応について" class="headerlink" title="お問い合わせの重要度・緊急対応について"></a>お問い合わせの重要度・緊急対応について</h2><p>Azure のサポートには、重要度が A ~ C に分類されております。</p><p>通常重要度 (重要度 B、もしくは C) は、日本時間の営業時間 (土日祝日を除く、9:00 ～ 17:30) でのみ対応しています。<br>Professinal Standard、Professinal Direct、Premier サポートにおいて 24 時間 365 日の緊急対応 (重要度 A) が提供されています。</p><p>緊急対応は、運用環境における「障害対応」つまり、正常な状態で稼働していたサービスが正常に機能しなくなった場合の復旧・問題の回避を目的として行われます。<br>原因追求や、ハウツー (※) については重要度 B、もしくは C として、通常営業時間内での対応となります。<br>※ 原因追求やハウツーは障害対応ではないため、重要度を落としたとしても、ご契約や内容によってお受けできない場合がございます。</p><p>Professinal Developer サポートは、開発環境を想定しているため、24 時間 365 日の対応は行えず、重要度 A でも通常時間内での優先対応となります。</p><h2 id="留意点-お問い合わせ番号-1-つにつき-1-つのソリューション提供となります"><a href="#留意点-お問い合わせ番号-1-つにつき-1-つのソリューション提供となります" class="headerlink" title="留意点: お問い合わせ番号 1 つにつき 1 つのソリューション提供となります"></a>留意点: お問い合わせ番号 1 つにつき 1 つのソリューション提供となります</h2><p>Azure には、多岐に渡るテクノロジーが存在します。<br>案件に応じて、データセンターへのエスカレーションや、適切な専任部門にエンジニアが交代となる可能性がございますため、サポートの際に発行させていただくお問い合わせ番号 1 つにつき 1  つの問題・ 1 つのソリューション提供とさせていただいております。</p><p>お問い合わせ内容が多岐にわたる場合、1 つのソリューションごとに新しいお問い合わせ番号の発行をお願いする場合がございます。</p><h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h2><p>以下に、具体例を挙げて対応範囲の Q&amp;A を記載させていただきます。</p><p><strong>Q. オンプレミスの PC やサーバーにおいて不調が発生した場合、Azure サポートで対応が行えるか</strong></p><p>オンプレミス、つまり自社や自宅の環境のサポート対応は Azure サポートでは対応範囲外となります。Premier サポートであれば、マイクロソフトの製品に限って対応が可能です。</p><p><strong>Q. Azure 上の Windows において、問題が発生しているため障害対応を行ってほしい</strong></p><p>前述の 「障害対応」 に該当するお問い合わせ内容であり、Azure 上の Windows で発生している場合には、Azure サポートで対応が行える範囲となります。Windows 専任部隊と連携し、障害状態からの復旧のため対応を行います。<br>障害対応以外のお問い合わせ内容については、チケット制のプロフェッショナル サポート インシデントをご購入いただくか、アドバイザリの対応範疇となる場合には Premier サポートが必要です。</p><ul><li><a href="https://www.microsoft.com/ja-jp/services/professional.aspx" target="_blank" rel="noopener">プロフェッショナル サポート</a><br>(※ Azure ではなく、Windows 、Office、SQL Server などマイクロソフト製品をインシデントというチケット制で問い合わせる形態となります)</li><li><a href="https://www.microsoft.com/ja-jp/services/premier.aspx" target="_blank" rel="noopener">プレミア サポート</a></li></ul><p><strong>Q. Azure 上における特定製品のライセンスについての問い合わせをしたい</strong></p><p>マイクロソフト製品のライセンス (Windows Server や SQL Server 等) については、ライセンス リセラーとなるパートナー各社にお問い合わせください。</p><p>パートナー ネットワークに加入されている弊社パートナー様の場合、弊社パートナー コールセンターにご相談ください。</p><ul><li><a href="https://partner.microsoft.com/ja-jp/support/call-center" target="_blank" rel="noopener">パートナー コールセンター</a></li></ul><p><strong>Q. IaaS 仮想マシンの利用にて、パフォーマンスが出ない</strong><br>構築後、正常にパフォーマンスが出ていた状態から、一時的に極端に悪化している場合には障害対応の範囲となり、Azure サポートでの対応が可能です。</p><p>障害対応の範囲外となるパフォーマンス チューニングは Premier サポートにおいてのみ承れます。<br>Professional Direct サポート契約においては、アドバイザリ サポートにてパフォーマンス上のベストプラクティスを公開情報の範囲からご案内可能です。</p><p><strong>Q. Azure 上の Windows Server 仮想マシンにおける OS 内の設定について、ベストプラクティス・特定機能の設定方法・仕様確認などを行いたい</strong></p><p>Azure サポートの対応範囲外となりますが、Premier サポートであれば対応可能です。<br>(Professional Direct 契約では、Windows OS 内部の動作は障害対応を除いてサポート対象外です。)</p><p><strong>Q. Azure 上の Windows Server 仮想マシンにおけるサードパーティ製品について問い合わせが可能か</strong></p><p>サードパーティ製品のサポートは行っておりませんので、開発元にお問い合わせをいただきますようお願いいたします。</p><p><strong>Q. Office 365 製品の問合せが可能か</strong></p><p>Office 365 の製品についてのサポートは Azure サポート契約ではお受けできないため、Office 365 サポートをご利用いただく必要がございます。<br>しかしながら、Azure 上に導入いただいた Office 365 製品において、Azure プラットフォーム側の問題が発生している可能性がある場合など、Azure プラットフォームとしての見解が必要な内容については Azure サポートにご相談ください。</p><p><strong>Q. Azure 仮想マシンの予期しない再起動が発生したため Azure 基盤側が要因であるか教えてほしい</strong></p><p>Azure テクニカル サポートに対して、予期しない再起動が Azure 起因であるか否かの判断、ならびにその理由についての公式見解をリクエストすることが可能です。</p><p>なお、Azure 仮想マシンでは、基盤側のハードウェア・ソフトウェア要因による不調の際、仮想マシンが予期せず再起動される可能性があります。この際に、仮想マシンは「サービス ヒーリング」と呼ばれる、正常な物理マシンへの移動が自動的に行われ、稼働を再開されます。</p><p>「障害対応」の定義に従いますと、仮想マシンが予期せず再起動したとしても、仮想マシンがサービス ヒーリングして起動した時点で既に復旧済みという理解となります。仮想マシン単体のダウンがお客様のサービス自体のダウンに繋がらないよう、可用性を構成していただく必要がございます。</p><p>ご参考: <a href="https://blogs.msdn.microsoft.com/ainaba-csa/2017/05/31/availability-of-azure-virtual-machines/" target="_blank" rel="noopener">Azure 仮想マシンにおける可用性の考え方</a></p><p><strong>Q. Azure 上の OSS（オープン ソース ソフトウェア) において、障害対応を行ってほしい</strong></p><p>マイクロソフトでは、以下技術情報に沿ったオープン ソース テクノロジーのサポートを行っております。</p><p>また、障害対応・アドバイザリ といった対応範囲は Azure テクニカル サポートと差異はありません。<br>特に、仕様確認など、開発元でなければ回答ができない内容の場合にはディストリビューターとお客様において個別にサポート契約を締結し、ご相談をいただく必要がありますので、下記ドキュメントをご一読ください。</p><ul><li><a href="https://support.microsoft.com/en-us/help/2941892/support-for-linux-and-open-source-technology-in-azure" target="_blank" rel="noopener">Support for Linux and open source technology in Azure</a> (英語原文)</li><li><a href="https://support.microsoft.com/ja-jp/help/2941892/support-for-linux-and-open-source-technology-in-azure" target="_blank" rel="noopener">Linux と Azure のオープン ソース ・ テクノロジーのサポート</a> (日本語機械翻訳版)</li></ul><p><strong>Q. Azure 上の Linux や OSS に関してのベストプラクティス・特定機能の設定方法・仕様確認などを行いたい</strong></p><p>Azure の Linux や OSS については、前述の技術情報 “Linux と Azure のオープン ソース ・ テクノロジーのサポート” に記載の範囲で行います。Professional Direct ないしは Premier サポートの契約が必要です。</p><p><strong>Q. Azure の特定の技術・挙動について仕様確認をしたい</strong></p><p>仕様の確認に関する調査については、Professional Direct、もしくは Premier サポートでのアドバイザリ サービスに含まれます。Professional Direct の場合、公開されている技術情報からのご案内のみとなります。</p><p><strong>Q. Azure Marketplace におけるサードパーティ製品の質疑応答・トラブルシューティングの依頼は可能か</strong></p><p>Azure 基盤側の問題、例えば「サードパーティ製として提供されている仮想マシンが、Azure 基盤側の要因で接続が出来なくなった」といったケースであれば Azure テクニカル サポートにて対応が可能です。<br>それ以外の、価格、ライセンス、製品固有のご質問・トラブルシュートは提供元にご質問をいただく必要があります。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;Azure の IaaS 仮想マシンをご利用のお客様における、Azure の有償テクニカル サポート範囲と留意点について以下の通りご説明します。&lt;br&gt;本ドキュメントでは、課金・サブスクリプション サ
      
    
    </summary>
    
    
    
      <category term="Other" scheme="https://jpaztech.github.io/blog/tags/Other/"/>
    
      <category term="Support Explained" scheme="https://jpaztech.github.io/blog/tags/Support-Explained/"/>
    
  </entry>
  
  <entry>
    <title>Japan Azure IaaS Support Blog リニューアルのお知らせ</title>
    <link href="https://jpaztech.github.io/blog/information/test/"/>
    <id>https://jpaztech.github.io/blog/information/test/</id>
    <published>2019-09-13T09:29:20.000Z</published>
    <updated>2020-08-18T00:45:29.873Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、日本マイクロソフト Azure IaaS Support チームです。</p><p>Microsoft Technet Blog プラットフォームにて掲載しておりました、<a href="https://docs.microsoft.com/en-us/archive/blogs/jpaztech/" target="_blank" rel="noopener">Japan Azure IaaS Support Team Blog</a> および <a href="https://social.msdn.microsoft.com/Forums/ja-JP/963ed40b-78fb-4a39-bfd0-925eb9ef95d3/japan-azure-iaas-support-team-blog-1239812496124831246312490125311249612540?forum=Jpaztech" target="_blank" rel="noopener">MSDN Forum</a>、Blog プラットフォームの運用上の都合によりアーカイブ記事 (MSDN Forum は今後アーカイブ記事となる予定) となりましたため、改めまして、本 GitHub Blog に移行することとなりました。</p><p>度重なる掲載先の変更に伴い、ご愛読いただいております皆様に多大なご不便をおかけいたしますこと、心よりお詫び申し上げます。<br>本 GitHub Blog につきましても、日本マイクロソフト Azure IaaS Support チームに所属する社員より、皆様のお役に立てる情報の発信に努めてまいりますので、ぜひご参照いただけますと幸いです。</p><p>なお、これまでの Microsoft Technet Blog および MSDN Forum に掲載していた記事は、随時本 GitHub Blog の Archive に移行を進めてまいります。<br>Azure の特性上、情報が古くなってしまった記事につきましては移行しない場合がございますため、あらかじめご了承ください。</p><p>本 Blog が、皆様のお役にたてれば幸いです。<br>今後ともよろしくお願いたします。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、日本マイクロソフト Azure IaaS Support チームです。&lt;/p&gt;
&lt;p&gt;Microsoft Technet Blog プラットフォームにて掲載しておりました、&lt;a href=&quot;https://docs.microsoft.com/en-us/arc
      
    
    </summary>
    
    
    
      <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway (WAF) での脆弱性検知について</title>
    <link href="https://jpaztech.github.io/blog/archive/application-gateway-waf-vulnerability-detection/"/>
    <id>https://jpaztech.github.io/blog/archive/application-gateway-waf-vulnerability-detection/</id>
    <published>2018-10-18T00:27:51.000Z</published>
    <updated>2020-08-18T00:45:29.853Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの山崎です。<br>今回は Application Gateway で Web アプリケーション ファイアウォール（WAF） 機能をご利用の際によくお問い合わせをいただく “949110” ルールについてご紹介します。</p><h2 id="■-WAF-機能で検知した情報をログから確認したい"><a href="#■-WAF-機能で検知した情報をログから確認したい" class="headerlink" title="■ WAF 機能で検知した情報をログから確認したい"></a>■ WAF 機能で検知した情報をログから確認したい</h2><p>一般的な WAF の導入シナリオとして、WAF 機能をいきなり本番環境に導入してしまうとフォールスポジティブや (誤検知) フォールスネガティブ (見逃し) に合致してしまう可能性があります。<br>そのため、まずは本番導入前に通信の破棄は行わず、検知のみを行ってログ情報からフォールスポジティブ、フォールスネガティブが発生していないか確認したいというご要望を多くいただきます。<br>Application Gateway の WAF 機能でも検知モード、ログ出力に対応しており、以下を設定することで導入前のテストを実施いただけます。</p><h3 id="検知モード-防止モード"><a href="#検知モード-防止モード" class="headerlink" title="検知モード / 防止モード"></a>検知モード / 防止モード</h3><p>検知モードでは脆弱性の診断は実施されますが、対象の通信が異常と判定された場合でも通信をブロックせず、後述の Firewall ログにログを保存します。<br>防止モードでは異常と判定された通信をログに保存しつつ、通信もブロックします。</p><p>（設定例）[Azure ポータル] Application Gateway 設定の [Web アプリケーション ファイアウォール] から設定します。</p><p><img src="/blog/archive/application-gateway-waf-vulnerability-detection/waf_tayamasa_mode.png" alt=""><br><img src="/blog/archive/application-gateway-waf-vulnerability-detection/waf_tayamasa_403_error.png" alt=""></p><h3 id="Firewall-ログ"><a href="#Firewall-ログ" class="headerlink" title="Firewall ログ"></a>Firewall ログ</h3><p>脆弱性を検知したログを保存するためには、診断ログの “ApplicationGatewayFirewallLog” を設定します。</p><p>（設定例）[Azure ポータル] Application Gateway 設定の [診断ログ] から設定します。</p><p><img src="/blog/archive/application-gateway-waf-vulnerability-detection/waf_tayamasa_firewalllog.png" alt=""></p><h2 id="■-Firewall-ログについて"><a href="#■-Firewall-ログについて" class="headerlink" title="■ Firewall ログについて"></a>■ Firewall ログについて</h2><p>以下は OWASP 3.0 を利用し SQL Injection Attack を検知した際の Firewall ログです。脆弱性が検知された通信毎にログが記録されます。1つの通信に対して複数の脆弱性を検知した場合には、複数の情報が出力されます。<br>複数検知されたかどうかについては “time”, “requestUri”, “clientIp” の項目が同じかどうかで判断することが可能です。</p><pre>{  "records": [    {      "resourceId": "/SUBSCRIPTIONS/xxxxxxxxxxxxxxxx/RESOURCEGROUPS/APPGW_TEST01/PROVIDERS/MICROSOFT.NETWORK/APPLICATIONGATEWAYS/APPGW02_WAF",      "operationName": "ApplicationGatewayFirewall",      "time": "2018-10-29T10:01:31.3790913Z",      "category": "ApplicationGatewayFirewallLog",      "properties": {        "instanceId": "ApplicationGatewayRole_IN_0",        "clientIp": "167.220.232.101",        "clientPort": "0",        "requestUri": "//?=!@rx%20%5E0$",        "ruleSetType": "OWASP",        "ruleSetVersion": "3.0",        "ruleId": "942130",        "message": "SQL Injection Attack: SQL Tautology Detected.",        "action": "Blocked",        "site": "Global",        "details": {          "message": "Warning. Pattern match \"(?i:([\\\\s'\\\"`\\\\(\\\\)]*?)([\\\\d\\\\w]++)([\\\\s'\\\"`\\\\(\\\\)]*?)(?:(?:=|<=>|r?like|sounds\\\\s+like|regexp)([\\\\s'\\\"`\\\\(\\\\)]*?)\\\\2|(?:!=|<=|>=|<>|<|>|\\\\^|is\\\\s+not|not\\\\s+like|not\\\\s+regexp)([\\\\s'\\\"`\\\\(\\\\)]*?)(?!\\\\2)([\\\\d\\\\w]+)))\" at ARGS:.",          "data": "Matched Data: rx ^0 found within ARGS:: !@rx ^0$",          "file": "rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf",          "line": "554"        },        "hostname": "1fe5ea76-fd34-480c-9b8d-a0b0d35cd19e.cloudapp.net"      }    },    {      "resourceId": "/SUBSCRIPTIONS/xxxxxxxxxxxxxxxx/RESOURCEGROUPS/APPGW_TEST01/PROVIDERS/MICROSOFT.NETWORK/APPLICATIONGATEWAYS/APPGW02_WAF",      "operationName": "ApplicationGatewayFirewall",      "time": "2018-10-29T10:01:31.3790913Z",      "category": "ApplicationGatewayFirewallLog",      "properties": {        "instanceId": "ApplicationGatewayRole_IN_0",        "clientIp": "167.220.232.101",        "clientPort": "0",        "requestUri": "//?=!@rx%20%5E0$",        "ruleSetType": "OWASP",        "ruleSetVersion": "3.0",        "ruleId": "949110",        "message": "Mandatory rule. Cannot be disabled. Inbound Anomaly Score Exceeded (Total Score: 5)",        "action": "Blocked",        "site": "Global",        "details": {          "message": "Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score.",          "data": "",          "file": "rules/REQUEST-949-BLOCKING-EVALUATION.conf",          "line": "57"        },        "hostname": "1fe5ea76-fd34-480c-9b8d-a0b0d35cd19e.cloudapp.net"      }    }  ]}</pre><h2 id="■-“949110”-ルールの検知"><a href="#■-“949110”-ルールの検知" class="headerlink" title="■ “949110” ルールの検知"></a>■ “949110” ルールの検知</h2><p>OWASP 3.0 ではスコア判定方式で対象の通信を判定しており、スコアを超えた（= 異常通信と判定した）場合に “949110” が判定されます。上記 Firewall ログの例では SQL Injection Attack を検知した “942130” と、スコア判定によりスコアを超えたことを示す “949110” の2つが検知されています。</p><p>ここで、例えば今回脆弱性として検知された通信について、実はフォールスポジティブで誤検知されてしまったため、検知を無効化して通信を許可したい場合、以下設定による個別の検知ルールの無効化が可能です。</p><h3 id="個別ルールの設定-無効化、有効化"><a href="#個別ルールの設定-無効化、有効化" class="headerlink" title="個別ルールの設定 (無効化、有効化)"></a>個別ルールの設定 (無効化、有効化)</h3><p>Firewall ログから検知した “ruleId” を確認し、同じ番号のルールを探して検知の無効化、有効化を設定することができます。</p><p>（設定例）[Azure ポータル] Application Gateway 設定の [Web アプリケーション ファイアウォール] から設定します。</p><p><img src="/blog/archive/application-gateway-waf-vulnerability-detection/waf_tayamasa_rulesetes.png" alt=""></p><p>よくあるお問い合わせとして、同様に “949110” を無効化しようと設定を確認したところ、”949110” の設定項目がないというお問い合わせをいただきます。</p><p>ご確認いただいた通り、”949110” については WAF 設定で有効/無効を切り替えることは出来ませんが、今回の例の場合、SQL Injection Attack を検知した “942130” を無効化いただければ、”949110” も検知されなくなります。前述の通り、OWSAP 3.0 ではスコア判定方針でスコアを超えた場合に “949110” が検知されますが、”942130” を無効化いただくことでスコア判定のスコアに加算されないため “949110” でも検知されなくなるためです。</p><p>そのため、”949110” については個別に無効化する必要はなく、”949110” とともに検知されたルールをご確認いただき、無効化いただくことで制御することが可能です。</p><blockquote><p>[参考] OWASP 2.2.9 ではスコア判定方式ではないため “949110” が Firewall ログに出力されることはありません。</p></blockquote><h2 id="■-Firewall-ログで検知しているのに通信がブロックされない"><a href="#■-Firewall-ログで検知しているのに通信がブロックされない" class="headerlink" title="■ Firewall ログで検知しているのに通信がブロックされない"></a>■ Firewall ログで検知しているのに通信がブロックされない</h2><p>OWASP 3.0 で防止モードご利用の際、Firewall ログで脆弱性を検知しているにも関わらず通信がブロックされない場合があります。<br>（ログ例）</p><pre>    {      "resourceId": "/SUBSCRIPTIONS/xxxxxxxxxxxxxxxx/RESOURCEGROUPS/APPGW_TEST01/PROVIDERS/MICROSOFT.NETWORK/APPLICATIONGATEWAYS/APPGW02_WAF",      "operationName": "ApplicationGatewayFirewall",      "time": "2018-10-29T11:39:47.2243486Z",      "category": "ApplicationGatewayFirewallLog",      "properties": {        "instanceId": "ApplicationGatewayRole_IN_0",        "clientIp": "167.220.232.101",        "clientPort": "0",        "requestUri": "/vendor/bootstrap/css/bootstrap.min.css.map",        "ruleSetType": "OWASP",        "ruleSetVersion": "3.0",        "ruleId": "920350",        "message": "Host header is a numeric IP address",        "action": "Blocked",        "site": "Global",        "details": {          "message": "Warning. Pattern match \"^[\\\\d.:]+$\" at REQUEST_HEADERS:Host.",          "data": "40.114.66.69",          "file": "rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf",          "line": "791"        },        "hostname": "40.114.66.69"      }    }</pre><p>通信が異常と判定された場合には “949110” が検知されますので、上記のログのような “920350” で検知し、スコア加算されたとしても、異常と判定されるスコアを超えない場合には通信はブロックされず、許可される場合があります。<br>そのため、通信がブロックされたかどうかを確認する場合には “949110” が同時に検知されているかどうかを Firewall ログからご確認ください。</p><blockquote><p>スコア判定の基準については OWASP で管理されており、OWASP CRS の各ルールや、その判定条件についてはサポートチームとしては回答が出来かねますため、GitHub のリポジトリをご参照いただくか、OWASP コミュニティのメーリングリスト等へご相談いただけますと幸いです。</p><p>[参考] <a href="https://jpaztech.github.io/blog/archive/applicationgaetway-waf-01/">Application Gateway で利用できる WAF について </a></p></blockquote><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの山崎です。&lt;br&gt;今回は Application Gateway で Web アプリケーション ファイアウォール（WAF） 機能をご利用の際によくお問い合わせをいただく “949110” ルールについてご紹介します。&lt;/
      
    
    </summary>
    
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/blog/tags/Archive/"/>
    
      <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
      <category term="WAF" scheme="https://jpaztech.github.io/blog/tags/WAF/"/>
    
  </entry>
  
</feed>
